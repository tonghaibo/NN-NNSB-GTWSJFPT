<?xml version='1.0' encoding='GBK'?><mdroot><grdds>
<ROWSET>
<ROW num="0" ><MWTYP >R</MWTYP><MWID >111test</MWID><NAME >111测试</NAME><NOTE ></NOTE><NOACCNAME ></NOACCNAME><FILE >111test.zxg</FILE><SCENE ></SCENE><FIXED ></FIXED><CATTYP ></CATTYP><DTLRNG ></DTLRNG><BATINP ></BATINP><MANUNIT ></MANUNIT><USESMLUNT ></USESMLUNT><ITEMTABLE ></ITEMTABLE><BILHDRTABLE ></BILHDRTABLE><BILDTLTABLE ></BILDTLTABLE><COLLIST ></COLLIST><WHERE ></WHERE><ORDER ></ORDER><DBNAME ></DBNAME><LISTSUM ></LISTSUM><LOADDATA ></LOADDATA><CHECKTITLE ></CHECKTITLE><IFBILL ></IFBILL><EXTJS ></EXTJS><JAVACLS ></JAVACLS><POST2MWID ></POST2MWID><LMS ></LMS><WIDTHMOD ></WIDTHMOD><HEIGHTMOD ></HEIGHTMOD><CLIENTCLASS ></CLIENTCLASS><SHOWBTN ></SHOWBTN><CLOSEPAGES ></CLOSEPAGES><syt >SBCW</syt></ROW>
</ROWSET>
</grdds><grdbtnds>
<ROWSET>
<ROW num="0" ><ID >test</ID><NAME >测试</NAME><ACTTYP ></ACTTYP><URL ></URL><URLTARGET ></URLTARGET><TIP ></TIP><BTNORD ></BTNORD><IMG ></IMG><IMGMOUSE ></IMGMOUSE></ROW>
</ROWSET>
</grdbtnds><grdjsds>
<ROWSET>
<ROW num="0" ><GRDJSDS_VALUE >
//数据加载完毕
function _thisOnpost_loaddata(sheet)
{
	_this.ShowTabBar(1);
	_this.SplitSheet(&amp;quot;0,1&amp;quot;,&amp;quot;h&amp;quot;,&amp;quot;18%&amp;quot;);
	_this.SplitSheet(2,&amp;quot;V&amp;quot;,&amp;quot;50%&amp;quot;);
	//_this.SetAttribe(&amp;quot;SHEET_2&amp;quot;,_this.ATTR_SHEET_SELECTFLAG,_this. SELECTFLAG_SINGLEROW );
	//_this.SetAttribe(&amp;quot;SHEET_3&amp;quot;,_this.ATTR_SHEET_SELECTFLAG,_this. SELECTFLAG_SINGLEROW );
}

//测试
function test()
{
	var param = new Object();
	param.str = &amp;quot;09―050800460006515&amp;quot;;
	var ret = _this.invokeOSFuncExt(&amp;quot;PLDK&amp;quot;,param);
	alert(ret);
	_this.SetCellText(0,3,2,ret);
}
</GRDJSDS_VALUE></ROW>
</ROWSET>
</grdjsds><grdosds>
<ROWSET>
<ROW num="0" ><GRDOSDS_VALUE >var pub = new JavaPackage(&amp;quot;com.xlsgrid.net.pub&amp;quot;);
var web = new JavaPackage(&amp;quot;com.xlsgrid.net.web&amp;quot;);
var servletpack = new JavaPackage(&amp;quot;com.xlsgrid.net.servlet&amp;quot;);
var ftppack = new JavaPackage(&amp;quot;org.apache.commons.net.ftp&amp;quot;);
var timepack = new JavaPackage( &amp;quot;com.xlsgrid.net.time&amp;quot; );
var jschftp = new JavaPackage( &amp;quot;com.jcraft.jsch&amp;quot; );
var storeRoot = &amp;quot;/filestore&amp;quot;;

//创建临时表
function createTempTable(db)
{
	var tempTable = db.GetSQL(&amp;quot;select &amp;apos;TMP_YHKP&amp;apos;||to_char(sysdate,&amp;apos;yymmddhh24miss&amp;apos;) from dual&amp;quot;);
	var sql = &amp;quot;create table &amp;quot;+tempTable+&amp;quot; (sfny varchar(20),djh varchar(20),dwbh varchar(20),dwyhhm varchar(200),dwyhzh varchar(30),dwyhmc varchar(200),yhbm varchar(20))&amp;quot;;
	db.ExcecutSQL(sql);	
	return tempTable;
}

//drop临时表
function dropTempTable(db,tempTable)
{
	var sql = &amp;quot;drop table &amp;quot;+tempTable;
	db.ExcecutSQL(sql);
}


//获取险种名称
function GetXzmc(xzlx,lxbh,db){
	var retStr = &amp;quot;&amp;quot;;
	var sql = &amp;quot;select substrb(csmc,1,8) csmc from cw_csb where lxdm = &amp;apos;XZ&amp;apos; and csdm = &amp;apos;&amp;quot;+xzlx+&amp;quot;&amp;apos;&amp;quot;;
	var xzmc = db.GetSQL(sql);
	if(lxbh == &amp;quot;31&amp;quot;){
		return retStr = &amp;quot;医疗统筹&amp;quot;;
	}else if(lxbh == &amp;quot;33&amp;quot;){
		return retStr = &amp;quot;医疗个账&amp;quot;;
	}else if(lxbh == &amp;quot;34&amp;quot;){
		return retStr = &amp;quot;医疗单建&amp;quot;;	
	}else if(lxbh == &amp;quot;37&amp;quot;){
		return retStr = &amp;quot;公务员&amp;quot;;	
	}else if(lxbh == &amp;quot;38&amp;quot;){
		return retStr = &amp;quot;大额医疗&amp;quot;;	
	}else if(lxbh == &amp;quot;39&amp;quot;){
		return retStr = &amp;quot;离休&amp;quot;;	
	}else if(lxbh == &amp;quot;71&amp;quot;){
		return retStr = &amp;quot;居民统筹&amp;quot;;	
	}else if(lxbh == &amp;quot;73&amp;quot;){
		return retStr = &amp;quot;居民个账&amp;quot;;	
	}else{
		return xzmc ;
	}
}

//补全长度空格
function formatStr(str,len,bef,typ)
{
	str = &amp;quot;&amp;quot;+str;
	var slen = getWordCount(str);//str.length();
	if (slen &amp;gt; len) {
		//return str.substring(0,len);	//该方法有问题
//		return pub.EAFunc.bSubstring(str ,len);
		var retstr = pub.EADbTool.GetSQL(&amp;quot;select substrb(&amp;apos;&amp;quot;+str+&amp;quot;&amp;apos;,0,&amp;quot;+len+&amp;quot;) from dual&amp;quot;);
		return retstr;
	} 
	var trim = &amp;quot;&amp;quot;;
	if(typ == &amp;quot;int&amp;quot; || typ == &amp;quot;INT&amp;quot;) {
		for (var i=0;i&amp;lt;(len-slen);i++) {
			trim += &amp;quot;0&amp;quot;;
		}			
	}
	else {
		for (var i=0;i&amp;lt;(len-slen);i++) {
			trim += &amp;quot; &amp;quot;;
		}	
	}
	if (bef == 1) return trim + str;
	else return str + trim;
}

function getWordCount(s)
{
        var length = 0;
//        for(var i = 0; i &amp;lt; s.length(); i++) {
//		var ascii = java.lang.Character.codePointAt(s, i);
//		if(ascii &amp;gt;= 0 &amp;&amp; ascii &amp;lt;=255)
//					length++;
//		else
//			length += 2;
//	}
	length = pub.EADbTool.GetSQL(&amp;quot;select lengthb(&amp;apos;&amp;quot;+s+&amp;quot;&amp;apos;) from dual&amp;quot;);
        return length;
}





//下载拷盘文件保存到本地P目录
function downLoadFile()
{
	var path = &amp;quot;/u/dsdf/&amp;quot;+mmdir+&amp;quot;/&amp;quot;;
	var txt = pub.EAFunc.readFile(path+filename);
	return txt;
}
//作为.sp服务时的入口
//预定义变量：request,response
function Response()
{
	var itemclass = request.getParameter(&amp;quot;filename&amp;quot;);
  	response.setHeader(&amp;quot;File&amp;quot;,filename);
        response.setHeader(&amp;quot;Content-Disposition&amp;quot;, &amp;quot;attachment;filename=&amp;quot;+filename);
	var path = &amp;quot;/u/dsdf/&amp;quot;+mmdir;
	var txt = pub.EAFunc.readFile(path+filename);
	txt = pub.EAFunc.Replace(txt,&amp;quot;\n&amp;quot;,&amp;quot;\r\n&amp;quot;);
	pub.EAZip.compressStringToStream(txt,response.getOutputStream());
}

function getSysDate()
{
	var dt = pub.EADbTool.GetSQL(&amp;quot;select to_char(sysdate,&amp;apos;yyyymmddhh24miss&amp;apos;) from dual&amp;quot;);
	return dt;
}


//批量代扣权限
function authorPLDK()
{
	return 1;
}

//零星代扣权限
function authorLXDK()
{
	return 1;
}



//生成代扣文件
function PLDK()
{
//	return djh;
	var db = null;
	var sql = &amp;quot;&amp;quot;;
	var tempTable = &amp;quot;&amp;quot;;
	try {
		return formatStr(str,34,&amp;quot;&amp;quot;,&amp;quot;&amp;quot;);
	}
	catch (e) {
		if (db != null) db.Rollback();
		return &amp;quot;生成拷盘出错:&amp;quot;+e.toString();
	}
	finally {
		if (db != null) db.Close();
	}

}

//判断银行是否为同一银行，是否是跨行支付
//dfyhbm 社保银行编码 aae008 单位或个人银行编码
function IsSameBank2(db,dfyhbm,aae008)
{
	var sql = &amp;quot;&amp;quot;;
	sql = &amp;quot;select count(*)
			from (select max(yhzl) yhzl
			          from cw_dfdsb_yszl
			         where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;
			           and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
			           and yhbm = &amp;apos;&amp;quot;+dfyhbm+&amp;quot;&amp;apos;) b,
			       （select max(yhzl) yhzl
			  from cw_dfdsb_yszl
			 where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;
			   and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
			   and yhbm = &amp;apos;&amp;quot;+aae008+&amp;quot;&amp;apos;) a
			 where b.yhzl = a.yhzl&amp;quot;;
	var cnt = db.GetSQL(sql);
	if(cnt &amp;gt; 0) {
		return 1;
	}
	else return 0;		 
}


//作废业务数据
function btRollback(){
	var sql = &amp;quot;&amp;quot;;
	var db = null;
	
	try{
		db = new pub.EADatabase();
		var iuo_ywjk = new SBCW_IYWJK(); //业务接口类
		var ywjkbz = iuo_ywjk.getYWJKBZ(db,thisaccid);

		
//		sql = &amp;quot;SELECT substrb(&amp;apos;&amp;quot;+bthpwjm+&amp;quot;&amp;apos;,-lengthb(&amp;apos;&amp;quot;+btkpwjm+&amp;quot;&amp;apos;)) bthpwjm FROM dual&amp;quot;;
//		var bthpwjn_sub = db.GetSQL(sql);
//		if(bthpwjn_sub != btkpwjm){//回盘文件名跟拷盘文件名不一致情况，则是在补托状态，不允许作废
//			return &amp;quot;回盘文件名跟拷盘文件名不一致,在补托状态,不允许作废 \n 拷盘文件名:&amp;quot;+btkpwjm+&amp;quot;\n 回盘文件名:&amp;quot;+bthpwjm;
//		}
		
		var BAZ610 = &amp;quot;&amp;quot;;
		var AAA027 = &amp;quot;&amp;quot;;
		var BAZ901 = &amp;quot;&amp;quot;;
		var BAZ902 = &amp;quot;&amp;quot;;
		var BAC004 = &amp;quot;&amp;quot;;
		var BAE415 = &amp;quot;&amp;quot;;
		var AAE076 = &amp;quot;&amp;quot;;
		var BAE036 = &amp;quot;&amp;quot;;
		var AIC263 = 0.00;
		var BAE419 = &amp;quot;&amp;quot;;
		var BZE034 = &amp;quot;&amp;quot;;
		var BAC003 = &amp;quot;&amp;quot;;
		var AAB034 = &amp;quot;&amp;quot;;
		var BAE421 = &amp;quot;&amp;quot;;
		//获取回款日期
		var sql = &amp;quot;select to_char(sysdate,&amp;apos;yyyy-mm-dd&amp;apos;) from dual&amp;quot;;
		var hkrq = db.GetSQL(sql);
		
		sql = &amp;quot;select a.BAZ610,a.AAA027,a.AAB034 ,a.BAZ901,a.BAZ902,a.BAC004,a.BAE415,a.AAE076,a.BAE036,sum(a.aic263) AIC263,a.BAC003,a.BAE421
		from ac95 a where AAB001=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos; and BAE074=&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; 
		group by a.BAZ610,a.AAA027,a.AAB034 ,a.BAZ901,a.BAZ902,a.BAC004,a.BAE415,a.AAE076,a.BAE036 ,a.BAC003,a.BAE421&amp;quot;;
		var tmpds = db.QuerySQL(sql);
		if (tmpds.getRowCount() &amp;gt; 0) {
			//调用接口（银海、东软）通知业务 (一笔明细调用一次接口）
			BAZ610 = tmpds.getStringAt(0,&amp;quot;BAZ610&amp;quot;); //业务内部序号
			AAA027 = tmpds.getStringAt(0,&amp;quot;AAA027&amp;quot;); //所属统筹区
			AAB034 = tmpds.getStringAt(0,&amp;quot;AAB034&amp;quot;); //所属统筹区
			BAZ901 = tmpds.getStringAt(0,&amp;quot;BAZ901&amp;quot;); //回盘结果状态码
			BAZ902 = tmpds.getStringAt(0,&amp;quot;BAZ902&amp;quot;); //回盘结果失败原因
			BAC004 = tmpds.getStringAt(0,&amp;quot;BAC004&amp;quot;); //回盘时间
			BAE415 = tmpds.getStringAt(0,&amp;quot;BAE415&amp;quot;); //发放批次
			AAE076 = tmpds.getStringAt(0,&amp;quot;AAE076&amp;quot;); //财务流水号
			BAE036 = tmpds.getStringAt(0,&amp;quot;BAE036&amp;quot;); //回盘时间
			AIC263 = tmpds.getStringAt(0,&amp;quot;AIC263&amp;quot;); //总金额
//			BAE419 = tmpds.getStringAt(0,&amp;quot;BAE419&amp;quot;); //银行种类
			BAC003 = tmpds.getStringAt(0,&amp;quot;BAC003&amp;quot;); //回盘文件名
			BAE421 = tmpds.getStringAt(0,&amp;quot;BAE421&amp;quot;);//报盘流水号
			//调用业务接口
			var yh_ywjk = new SBCW_YWJK_YH();
			var yhjk_msg = yh_ywjk.yhjk_PayInterface(db,djh,&amp;quot;1&amp;quot;,AIC263,hkrq,BAZ901,BAZ902,czyxm,AAB034,thisorgid ,thisaccid,ywjkbz,BAE421,&amp;quot;&amp;quot;,&amp;quot;&amp;quot;);
			var ret = yhjk_msg.split(&amp;quot;@&amp;quot;)[0];
			var retmes = yhjk_msg.split(&amp;quot;@&amp;quot;)[1];
			if(ret!=&amp;quot;NOERROR&amp;quot;){
				db.Rollback();
				return &amp;quot;4、补托调用业务接口prc_p_PayInterface出错！单据号:&amp;quot;+djh+&amp;quot;;出错原因:&amp;quot;+retmes+&amp;quot;.\n&amp;quot;;
			}
			
			//更新回盘信息
			sql = &amp;quot;update ac95 set bie085=&amp;apos;2&amp;apos;,zfbz=&amp;apos;1&amp;apos; where AAB001=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos; and BAE074=&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;&amp;quot;;			
			var upcnt = db.ExcecutSQL(sql);
			if (upcnt == 0) {
				db.Rollback();
				return &amp;quot;3、更新回盘记录不成功，请检查回盘文件数据格式是否正确！单据号:&amp;quot;+djh+&amp;quot;.\n&amp;quot;;
			}
			db.Commit();
//			db.Rollback();
			return 1;
		}

	}
	catch (e) {
//		notify(jobseqid,100,e.toString()+&amp;quot;  出错行=&amp;quot; + rowcnt,&amp;quot;error&amp;quot;);
		if (db != null) db.Rollback();
		return e.toString();
	}
	finally {
		if (db != null) db.Close();
	}

}

//判断业务类型是单笔还是批量 单笔：db 批量:pl
function checkYWLX()
{
	var db = null;
	var sql = &amp;quot;&amp;quot;;
	try{
		db = new pub.EADatabase();
		sql = &amp;quot;select nvl(max(yszl_dm),&amp;apos;NULL&amp;apos;) from aa10 where aaa100 = &amp;apos;YWLX&amp;apos; and aaa102= &amp;apos;&amp;quot;+ywlx+&amp;quot;&amp;apos;&amp;quot;;
		var yszl_dm = db.GetSQL(sql);
		if(yszl_dm == &amp;quot;0122001&amp;quot;) {
			return &amp;quot;pl&amp;quot;;
		}
		else {
			return &amp;quot;db&amp;quot;;
		}
	}catch(e) {
		if(db != null) db.Rollback();
		return e.toString();
	}finally {
		if(db != null) db.Close();
	}
}

//单笔代扣保存
//保存日记帐录入
function Save()
{	
	var db = null;
	var sql = &amp;quot;&amp;quot;;
	var invokeRet = &amp;quot;&amp;quot;;
	var retmsg = &amp;quot;&amp;quot;;//返回1表示成功
	try {
		db = new pub.EADatabase();		
		var lsh = rjzlsh;
		var sxh = &amp;quot;&amp;quot;;
		var yspz_fjpch = &amp;quot;&amp;quot;;
		var iuo_ywjk = new SBCW_IYWJK(); //业务接口类
		var ywjkbz = iuo_ywjk.getYWJKBZ(db,thisaccid);//业务接口标志		
		var service = new SBCW_sbcwService();
		var sbcode = db.GetSQL(&amp;quot;select yszl_sbjgdm from cw_ztb where org = &amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; and acc = &amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;&amp;quot;);// 银社直连社保经办机构代码
		var tcqbm = db.GetSQL(&amp;quot;select tcqbm from cw_sbsb where org = &amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;&amp;quot;);
		var sblsh = service.genSiSeq(sbcode);	
		var ztlx = 1;
		var ywhtjk = &amp;quot;&amp;quot;;
		var dwbh = &amp;quot;&amp;quot;;
		var dwmc = &amp;quot;&amp;quot;;
		var zy = &amp;quot;&amp;quot;;
		var je = jyje;
		
		sql = &amp;quot;SELECT yhmc FROM cw_dfdsb WHERE sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND szbz =&amp;apos;1&amp;apos; AND yhbm = &amp;apos;&amp;quot;+yhzl+&amp;quot;&amp;apos;&amp;quot;;
		var yhmc = db.GetSQL(sql);	
		sql = &amp;quot;SELECT nvl(max(yhzh),&amp;apos;NULL&amp;apos;) yhzh,nvl(max(yhhm),&amp;apos;NULL&amp;apos;) yhhm,nvl(max(kmbh),&amp;apos;NULL&amp;apos;) kmbh,nvl(max(khyh),&amp;apos;NULL&amp;apos;) khyh FROM CW_BKDYHB WHERE SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND BZ = &amp;apos;12&amp;apos; AND (MRTSTZYHBZ = &amp;apos;217&amp;apos; or MRTSTZYHBZ = &amp;apos;218&amp;apos;)
			AND YHZL IN (SELECT YHBM FROM CW_DFDSB WHERE SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND YHZL = &amp;apos;&amp;quot;+yhzl+&amp;quot;&amp;apos; AND SZBZ = &amp;apos;2&amp;apos; AND YHBM &amp;lt;&amp;gt; &amp;apos;*&amp;apos;) &amp;quot;;
		var ds = db.QuerySQL(sql);
		yszl_skzh = ds.getStringAt(0,&amp;quot;yhzh&amp;quot;);
		yszl_skhm = ds.getStringAt(0,&amp;quot;yhhm&amp;quot;);
		yszl_kmbh = ds.getStringAt(0,&amp;quot;kmbh&amp;quot;);		
		yszl_skyh = ds.getStringAt(0,&amp;quot;khyh&amp;quot;);
		if(yszl_kmbh== &amp;quot;NULL&amp;quot; || yszl_skyh== &amp;quot;NULL&amp;quot; || yszl_skhm== &amp;quot;NULL&amp;quot;){
			sql = &amp;quot;SELECT nvl(max(yhzh),&amp;apos;NULL&amp;apos;) yhzh,nvl(max(yhhm),&amp;apos;NULL&amp;apos;) yhhm,nvl(max(kmbh),&amp;apos;NULL&amp;apos;) kmbh,nvl(max(khyh),&amp;apos;NULL&amp;apos;) khyh FROM CW_BKDYHB WHERE SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND BZ = &amp;apos;12&amp;apos; AND (MRTSTZYHBZ = &amp;apos;227&amp;apos; or MRTSTZYHBZ = &amp;apos;228&amp;apos;)
				AND YHZL IN (SELECT YHBM FROM CW_DFDSB WHERE SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND YHZL = &amp;apos;&amp;quot;+yhzl+&amp;quot;&amp;apos; AND SZBZ = &amp;apos;2&amp;apos; AND YHBM &amp;lt;&amp;gt; &amp;apos;*&amp;apos;)&amp;quot;;								
			var ds = db.QuerySQL(sql);
			yszl_skyh = ds.getStringAt(0,&amp;quot;khyh&amp;quot;);
			yszl_skzh = ds.getStringAt(0,&amp;quot;yhzh&amp;quot;);
			yszl_skhm = ds.getStringAt(0,&amp;quot;yhhm&amp;quot;);
			yszl_kmbh = ds.getStringAt(0,&amp;quot;kmbh&amp;quot;);	
			if(yszl_kmbh== &amp;quot;NULL&amp;quot; || yszl_skyh== &amp;quot;NULL&amp;quot; || yszl_skhm== &amp;quot;NULL&amp;quot;) {								
				db.Rollback();
				return &amp;quot;查询无此银行科目,请到[账务管理-&amp;gt;账务维护-&amp;gt;银行帐号设置]&amp;quot;+&amp;quot;\n&amp;quot;+&amp;quot;请检查[&amp;quot;+yhmc+&amp;quot;]社保基金收入户是否设置为统一征收银行或者本行征收银行!!!!!!&amp;quot;;
			}	
		}	
		
		//是否启用银社直连判断
		var sipub = new SBCW_PUBFUNC();
		var chkret = sipub.checkYSZLStatusByKM(db,sbh,zth,yszl_kmbh);
		if (chkret == &amp;quot;0&amp;quot;) { //未启用
			db.Rollback();
			return &amp;quot;社银直连未启用，请到日记账模块操作！&amp;quot;;
		}		
			
		sql = &amp;quot;select dwbh,dwmc,zy,kmbh from v_si_djb_tmp where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and djh=&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;&amp;quot;;
		var ds = db.QuerySQL(sql);
		dwbh = ds.getStringAt(0,&amp;quot;dwbh&amp;quot;);
		dwmc = ds.getStringAt(0,&amp;quot;dwmc&amp;quot;);
		zy = ds.getStringAt(0,&amp;quot;zy&amp;quot;);
		sql = &amp;quot;select to_char(sysdate,&amp;apos;yyyy-mm-dd&amp;apos;) from dual&amp;quot;;
		var yyyymmdd = db.GetSQL(sql);
		var yy =  java.lang.Integer.parseInt(yyyymmdd.split(&amp;quot;-&amp;quot;)[0]);
		var mm =  java.lang.Integer.parseInt(yyyymmdd.split(&amp;quot;-&amp;quot;)[1]);
		var dd =  java.lang.Integer.parseInt(yyyymmdd.split(&amp;quot;-&amp;quot;)[2]);
		//获取科目余额方向
		sql = &amp;quot;select yxyefx from cw_kmb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and kmbh = &amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;&amp;quot;;
		var yxyefx = db.GetSQL(sql);
		//银社直连还要保存到银行日记账表 cw_yhrjzb
		//var yhrjzlsh = db.GetSQL(&amp;quot;select seq_yhrjz_lsh.nextval from dual&amp;quot;);
		var yhrjzsxh = db.GetSQL(&amp;quot;select nvl(max(sxh),0)+1 from cw_yhrjzb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and yy=&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; and mm=&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos; and KMBH=&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;&amp;quot;);
		var yhrjzid = db.GetSQL(&amp;quot;select seq_yhrjzb_id.nextval from dual&amp;quot;);	
		var szbz = &amp;quot;&amp;quot;;	
		if(yszlywlx == &amp;quot;1.7&amp;quot; || yszlywlx == &amp;quot;1.8&amp;quot;) {
			szbz = &amp;quot;2&amp;quot;;
		}	
		else {
			szbz = &amp;quot;1&amp;quot;;
		}			
		if (lsh == &amp;quot;&amp;quot;) { //新增状态
			sql = &amp;quot;select seq_rjz_lsh.nextval from dual&amp;quot;;
			lsh = db.GetSQL(sql); //流水号
			sql = &amp;quot;select nvl(max(sxh),0)+1 from cw_rjzb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and yy=&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; and mm=&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos; and kmbh=&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;&amp;quot;;
			sxh = db.GetSQL(sql); //顺序号
			sql = &amp;quot;select SEQ_CW_RJZB_FJPCH.nextval from dual&amp;quot;;
			yspz_fjpch = db.GetSQL(sql); //原始凭证批次号
		}
		//修改状态
		if (rjzlsh != &amp;quot;&amp;quot;) {
			//更新cw_rjzb
			sql = &amp;quot;update cw_rjzb set yy=&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos;,mm=&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos;,dd=&amp;apos;&amp;quot;+dd+&amp;quot;&amp;apos;,czyxm=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,pch=&amp;apos;&amp;quot;+pch+&amp;quot;&amp;apos;,zy=&amp;apos;&amp;quot;+zy+&amp;quot;&amp;apos;,kmbh=&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;,
				dwbh=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;,dwmc=&amp;apos;&amp;quot;+dwmc+&amp;quot;&amp;apos;,je=&amp;apos;&amp;quot;+je+&amp;quot;&amp;apos;,jefx=&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;,jsfs=&amp;apos;&amp;quot;+jsfs+&amp;quot;&amp;apos;,yspz_fjzs=&amp;apos;&amp;quot;+yspz_fjzs+&amp;quot;&amp;apos;,czysj=sysdate
				where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and org=&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; and acc=&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos; and lsh=&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;&amp;quot;;
			db.ExcecutSQL(sql);
			
			//先清除明细表
			sql = &amp;quot;delete from cw_rjzmxb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and org=&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; and acc=&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos; and lsh=&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;&amp;quot;;
			db.ExcecutSQL(sql);
		}
		else {
			//获取业务类型回退接口及主体类型
			ztlx = 1;
			sql = &amp;quot;SELECT DECODE(&amp;apos;&amp;quot;+ywjkbz+&amp;quot;&amp;apos;,&amp;apos;YH&amp;apos;,YWXT_YHDM,&amp;apos;DR&amp;apos;,YWXT_DRDM,&amp;apos;&amp;quot;+ywjkbz+&amp;quot;&amp;apos;) FROM AA10 WHERE AAA100 = &amp;apos;YWLX&amp;apos; AND 
				AAA102 IN (SELECT DISTINCT YWLX FROM V_SI_DJB_TMP WHERE SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND DJH = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;)&amp;quot;;
			ywhtjk = db.GetSQL(sql);					
			sql = &amp;quot;insert into cw_yhrjzb(id,sbh,zth,SiSeqNo,yy,mm,dd,sxh,czyxm,zy,kmbh,je,jefx,czysj,YSZL_YWLX,YSZL_FKF_KHYH,YSZL_FKF_YHZH,
							YSZL_FKF_YHHM,YSZL_SKF_KHYH,YSZL_SKF_YHZH,YSZL_SKF_YHHM,YSZL_SZBZ,YSZL_YHZL,ztlx,ztbh,ztmc,ywpch,JSFS,djh,yefx,ye,yspz_fjzs,yspz_fjpch,yspz_lrrq,DYYWJK_LX)
				values (&amp;apos;&amp;quot;+yhrjzid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;,&amp;quot;+yy+&amp;quot;,&amp;quot;+mm+&amp;quot;,&amp;quot;+dd+&amp;quot;,&amp;quot;+yhrjzsxh+&amp;quot;,&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zy+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;,&amp;quot;+je+&amp;quot;,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;,sysdate,
						&amp;apos;&amp;quot;+yszlywlx+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_fkyh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_fkzh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_fkhm+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_skyh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_skzh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_skhm+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+szbz+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yhzl+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ztlx+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dwmc+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ffpch+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jsfs+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;,
						&amp;apos;&amp;quot;+yxyefx+&amp;quot;&amp;apos;,0,&amp;apos;&amp;quot;+yspz_fjzs+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yspz_fjpch+&amp;quot;&amp;apos;,sysdate,&amp;apos;&amp;quot;+ywhtjk+&amp;quot;&amp;apos;)&amp;quot;;		
			var cnt = db.ExcecutSQL(sql);	
			if(cnt == 0) {
				db.Rollback();
				return &amp;quot;插入银行日记帐表失败&amp;quot;;
			}		
			sql = &amp;quot;insert into cw_rjzb(sbh,zth,org,acc,lsh,yy,mm,dd,sxh,czyxm,pch,zy,kmbh,lxbh,dwbh,dwmc,je,jefx,jsfs,yspz_fjzs,yspz_fjpch,yspz_lrrq,czysj,djh,siseqno,MKJMBZ)
				values(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dd+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,
				&amp;apos;&amp;apos;,&amp;apos;&amp;quot;+zy+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dwmc+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+je+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jsfs+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yspz_fjzs+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yspz_fjpch+&amp;quot;&amp;apos;,sysdate,sysdate,&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;,&amp;apos;社银直连-银行帐单笔录&amp;apos;)&amp;quot;;
			var cnt = db.ExcecutSQL(sql);	
			if(cnt == 0) {
				db.Rollback();
				return &amp;quot;插入日记帐表失败&amp;quot;;
			}								
		}
		
		//保存cw_rjzmxb
		var mxxh = 0;
		var lxxh = 0;
		var oldlxbh = &amp;quot;&amp;quot;;
		var rjzlxbh = &amp;quot;&amp;quot;;
		var sumje = 0.0;			
		sql = &amp;quot;select sbh,zth,substr(rq,0,4) yy,substr(rq,5,2) mm,substr(rq,7,2) dd,pch,jsfs,djh,dwbh,max(dwmc) dwmc,max(zy) zy,
		       sum(je1) je1,sum(je2) je2,sum(je3) je3,sum(je4) je4,sum(je5) je5,sum(je6) je6,sum(je7) je7,
		       sum(je8) je8,sum(je9) je9,sum(je10) je10,sum(je11) je11,sum(je12) je12,sum(je13) je13,sum(je14) je14,sum(je15) je15,
		         sum(je1+je2+je3+je4+je5+je6+je7+je8+je9+je10+je11+je12+je13+je14+je15) sumje,
		         max(nvl(dwjc,dwmc)) dwjc,nvl(max(dwlxbh),&amp;apos;0&amp;apos;) dwlxbh,max(nvl(yhzh1,yhzh2)) yhzh,lxbh,ym1,ym2,kmbh   
			FROM  v_si_djb_tmp 
			where djh =&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and rzbz = &amp;apos;0&amp;apos; and zfbz = &amp;apos;0&amp;apos;
			group by djh,sbh,zth,rq,djh,dwbh,lxbh,jsfs,pch,lxbh,ym1,ym2,kmbh&amp;quot;;	
		var rjzmxds = db.QuerySQL(sql);
		if(rjzmxds.getRowCount() &amp;gt; 0) {
			for(var i= 0;i&amp;lt;rjzmxds.getRowCount();i++) {
				var lxbh = rjzmxds.getStringAt(i,&amp;quot;LXBH&amp;quot;);
				for(var j=1;j&amp;lt;=15;j++) {
					var ym1 = rjzmxds.getStringAt(i,&amp;quot;YM1&amp;quot;);
					var ym2 = rjzmxds.getStringAt(i,&amp;quot;YM2&amp;quot;);
					var lxxh = j;
					var je = pub.EAFunc.NVL(rjzmxds.getStringAt(i,&amp;quot;JE&amp;quot;+j),&amp;quot;0&amp;quot;);
					if (je == &amp;quot;&amp;quot;) je = 0;
					je = 1.0 * je;		
					if (je != 0 &amp;&amp; je != &amp;quot;&amp;quot;) {
						var jefx = db.GetSQL(&amp;quot;select fx from cw_rjlxmxb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and lxbh = &amp;apos;&amp;quot;+lxbh+&amp;quot;&amp;apos; and mxxh = &amp;apos;&amp;quot;+lxxh+&amp;quot;&amp;apos;&amp;quot;);						
						if (oldlxbh == &amp;quot;&amp;quot;) {
							oldlxbh = lxbh;
							rjzlxbh = oldlxbh;
						}
						mxxh ++;
						sumje += je;
						//计算类型序号lxxh
						if (lxbh == oldlxbh) {
							//lxxh ++;
						}
						else {
							//lxxh = 1;
							oldlxbh = lxbh;
							rjzlxbh += lxbh;
						}	
						
						sql = &amp;quot;insert into cw_rjzmxb(sbh,zth,org,acc,lsh,mxxh,kmbh,lxbh,lxxh,ym1,ym2,je,jefx)values(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;,
							&amp;apos;&amp;quot;+mxxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lxbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lxxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ym1+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ym2+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+je+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;)&amp;quot;;
						var cnt = db.ExcecutSQL(sql);
						if(cnt == 0) {
							db.Rollback();
							return &amp;quot;插入失败，插入日记账明细失败&amp;quot;;
						}
					}	
				}	
			}			
		}else {
			db.Rollback();
			return &amp;quot;1、支付失败，查询v_si_djb_tmp无数据&amp;quot;;
		}			
		//更新日记帐表的总金额
		sql = &amp;quot;update cw_rjzb a set je=(select sum(je) from cw_rjzmxb b where a.sbh=b.sbh and a.zth=b.zth and a.lsh=b.lsh)
			where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and lsh=&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;&amp;quot;;
		db.ExcecutSQL(sql);
		
		//更新日记帐表的类型编号
		sql = &amp;quot;update cw_rjzb a set lxbh=&amp;apos;&amp;quot;+rjzlxbh+&amp;quot;&amp;apos; where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and lsh=&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;&amp;quot;;
		db.ExcecutSQL(sql);
		
		//前面处理所有内部账，未涉及接口调用		
		//下面涉及所以接口调用		
		var yh_ywjk = new SBCW_YWJK_YH(); 	//征收中间件业务接口
		var uo_ywjk = new SBCW_IYWJK();		//发放中间件业务接口		
		if(djh != &amp;quot;&amp;quot; ){	
			//获取到账日期
			sql = &amp;quot;select trim(&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos;||trim(to_char(&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos;,&amp;apos;00&amp;apos;))||trim(to_char(&amp;apos;&amp;quot;+dd+&amp;quot;&amp;apos;,&amp;apos;00&amp;apos;))) rq from dual&amp;quot;;
			var rq = db.GetSQL(sql);	
			//获取拷盘流水号
			var kplsh = db.GetSQL(&amp;quot;select seq_kplsh.nextval from dual&amp;quot;);						
			sql = &amp;quot;update v_si_djb_tmp set rzbz = &amp;apos;1&amp;apos;,rzr = &amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,rzsj = to_date(&amp;apos;&amp;quot;+rq+&amp;quot;&amp;apos;,&amp;apos;yyyy-mm-dd&amp;apos;) ,lsh = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;,cwbz = &amp;apos;1&amp;apos;
				where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and djh= &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and zfbz = 0 and zbbz = 0 and rzbz = &amp;apos;0&amp;apos;&amp;quot;;
			db.ExcecutSQL(sql);			
			//更新AC95
			sql = &amp;quot;update ac95 set BAZ901 = 0,BAZ902 = &amp;apos;成功&amp;apos;,aae076 = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;,bae011 = &amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,bae036 = sysdate,bae116=&amp;apos;1&amp;apos;,bae012=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,bae034 = sysdate,
				BAC002=sysdate,AAE036=sysdate,AAE011=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,bae421=&amp;apos;&amp;quot;+kplsh+&amp;quot;&amp;apos;
				where zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and bae074 = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;&amp;quot;;
			db.ExcecutSQL(sql);						
			//判断是否是挂暂存记录，是挂暂存记录不调用接口
			sql = &amp;quot;select count(1) from v_si_djb_tmp where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and djh= &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and zfbz = 0 and zbbz = &amp;apos;1&amp;apos;&amp;quot;;
			var gzcou = db.GetSQL(sql);
			if( gzcou &amp;lt;= 0){
				var ywlx = &amp;quot;&amp;quot;;
				sql = &amp;quot;SELECT DISTINCT YWLX FROM V_SI_DJB_TMP where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and djh= &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and zfbz = 0 and zbbz = 0 and rzbz = &amp;apos;1&amp;apos;&amp;quot;;
				var yw_ds = db.QuerySQL(sql);
				if(yw_ds.getRowCount() &amp;lt;= 0){
					db.Rollback();
					return &amp;quot;查询业务类型出错，单据号:&amp;quot;+djh+&amp;quot;\n&amp;quot;+sql;
				}else{
					ywlx = yw_ds.getStringAt(0,&amp;quot;YWLX&amp;quot;);
				}			
				sql = &amp;quot;select distinct szzt from aa10 where aaa100 = &amp;apos;YWLX&amp;apos; AND AAA102 IN (SELECT DISTINCT YWLX FROM V_SI_DJB_TMP where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and djh= &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and zfbz = 0 and zbbz = 0 and rzbz = &amp;apos;1&amp;apos;)&amp;quot;;
				var szzt = db.GetSQL(sql);
				if(szzt == 1){
					//单据号金额与录入金额不等不允许保存
					sql = &amp;quot;select sum(je1+je2+je3+je4+je5+je6+je7+je8+je9+je10+je11+je12+je13+je14+je15) je,jsfs
						from v_si_djb_tmp where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and djh = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and zfbz=&amp;apos;0&amp;apos; group by jsfs&amp;quot;;
					var je_ds = db.QuerySQL(sql);
					var djsum   = je_ds.getStringAt(0,&amp;quot;JE&amp;quot;);
					var si_jsfs = je_ds.getStringAt(0,&amp;quot;JSFS&amp;quot;);
					if(si_jsfs != &amp;quot;退暂存款财务不调接口&amp;quot;){
						//调用业务接口	
						var jffs = &amp;quot;&amp;quot;;		//缴费方式
						if(ywjkbz == &amp;quot;YH&amp;quot;){
							if(ywlx == &amp;quot;A120&amp;quot;){
								jffs = &amp;quot;4&amp;quot;;
							}else{
								jffs = &amp;quot;3&amp;quot;;
							}
						}else if(ywjkbz == &amp;quot;DR&amp;quot;){
							jffs = &amp;quot;DEDZ&amp;quot;;	//等额到账
						}								
						if( dwbh != &amp;quot;BMKX99&amp;quot; ){
							var yhjk_msg = yh_ywjk.yhjk_PayInterface(db,djh,jffs,djsum,rq,&amp;quot;&amp;quot;,&amp;quot;&amp;quot;,czyxm,tcqbm ,thisorgid ,thisaccid,ywjkbz,sblsh,zy,yszl_kmbh);  
							var ret = yhjk_msg.split(&amp;quot;@&amp;quot;)[0];
							var retmes = yhjk_msg.split(&amp;quot;@&amp;quot;)[1];
							if(ret!=&amp;quot;NOERROR&amp;quot;){
								db.Rollback();
								return &amp;quot;1、调用征收业务接口出错！单据号:&amp;quot;+djh+&amp;quot;;出错原因:&amp;quot;+retmes+&amp;quot;.\n&amp;quot;;
							}
							sql = &amp;quot;update ac95 set BAZ901 = &amp;apos;0000&amp;apos;,BAC004=to_date(&amp;apos;&amp;quot;+rq+&amp;quot;&amp;apos;,&amp;apos;yyyy-mm-dd&amp;apos;),BAE011=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,BAE036=sysdate,AAE076 =&amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos; 
							where aaa027 = &amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and BAE074 = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;&amp;quot;;
							db.ExcecutSQL(sql);							
						}//if( dwbh != &amp;quot;BMKX99&amp;quot; )
					}//if(si_jsfs != &amp;quot;退暂存款财务不调接口&amp;quot;)
				}else if(szzt == 2){
					//银行发放接口
					//  --财务回写业务数据标志
					//  PROCEDURE prc_updateac82_aae117(prm_aaz220   IN    NUMBER,   --应付计划事件ID (BAZ610	 业务内部序号)
					//                                  prm_aaa027   IN    VARCHAR2, --所属统筹区 ()
					//                                  prm_aae117   IN    VARCHAR2, --支付标志（11:支付成功，12：支付失败）
					//                                  prm_reason   IN    VARCHAR2, --失败原因
					//                                  prm_yac900   IN    VARCHAR2, --记账凭证号
					//                                  prm_yac901   IN    VARCHAR2, --制单人
					//                                  prm_yac902   IN    DATE,     --记账时间
					//                                  prm_yac903   IN    VARCHAR2, --财务汇总批次号
					//                                  prm_yac904   IN    DATE,     --到账时间
					//                                  prm_yac905   IN    DATE,     --对账时间
					//				    prm_yac906   IN    DATE,     --回盘时间
					//                                  prm_xh       OUT   VARCHAR2, --记录流水号
					//                                  prm_appcode  OUT   VARCHAR2,
					//                                  prm_errmsg   OUT   VARCHAR2);
					//function yhkpReturn(db,orgid,accid,ywguid,tcqbm,zfbz,errmsg,lsh,zdr,jzdat,pch,daozdat,duizdat,hprq,ywjkbz)
					if(ywjkbz == &amp;quot;YH&amp;quot;){
						sql = &amp;quot;SELECT distinct BAZ610,BAE415 FROM ac95 WHERE  aaa027 = &amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and BAE074 = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;&amp;quot;;
						var jkds = db.QuerySQL(sql);
						var BAZ610 = jkds.getStringAt(0,&amp;quot;BAZ610&amp;quot;);
						var BAE415 = jkds.getStringAt(0,&amp;quot;BAE415&amp;quot;);
						sql = &amp;quot;SELECT to_char(to_date(&amp;apos;&amp;quot;+rq+&amp;quot;&amp;apos;,&amp;apos;yyyy-mm-dd&amp;apos;),&amp;apos;yyyy-mm-dd&amp;apos;) FROM dual&amp;quot;;
						var czysj = db.GetSQL(sql);
						
						var jkmsg = uo_ywjk.yhkpReturn(db,thisorgid,thisaccid,BAZ610 ,tcqbm,&amp;quot;11&amp;quot;,&amp;quot;&amp;quot;,lsh,czyxm,czysj ,BAE415,czysj ,czysj ,czysj ,ywjkbz);
						var ret = jkmsg.split(&amp;quot;@&amp;quot;)[1];
						var msg = jkmsg.split(&amp;quot;@&amp;quot;)[2];
						if(ret != &amp;quot;NOERROR&amp;quot;){
							db.Rollback();
							return &amp;quot;1、调用发放业务接口出错，出错原因:&amp;quot;+jkmsg ;
						}
					}
					
					sql = &amp;quot;update ac95 set BAZ901 = &amp;apos;0000&amp;apos;,BAC004=to_date(&amp;apos;&amp;quot;+rq+&amp;quot;&amp;apos;,&amp;apos;yyyy-mm-dd&amp;apos;),BAE011=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,BAE036=sysdate,AAE076 =&amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos; 
						where aaa027 = &amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and BAE074 = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;&amp;quot;;
					db.ExcecutSQL(sql);
				}
			}
		}	
		var TransType = &amp;quot;&amp;quot;;
		var TransMode = &amp;quot;&amp;quot;;
		TransType = &amp;quot;003&amp;quot;;
		TransMode = &amp;quot;2&amp;quot;;
		var BankCode = &amp;quot;&amp;quot;;		
		var wssi2 = new SBCW_WSSI2();
		var yhjgdm = db.GetSQL(&amp;quot;select b.yszl_yhjgdm from cw_bkdyhb a,cw_dfdsb_yszl b where a.sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and a.zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and a.kmbh = &amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;and b.sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and b.zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and b.yhbm = a.yhzl&amp;quot;);//银行机构代码
		//求单位机构代码
		var dwjgdm = &amp;quot;&amp;quot;;
		try{dwjgdm = db.GetSQL(&amp;quot;SELECT AAB003 FROM AB01 WHERE AAB001 = &amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;&amp;quot;);}catch(e){}					
               //function F0112001(SenderInstId,RecverInstId,SiSeq,CrBkAcctId,CrBkAcctName,DrBkAcctId,DrBkAcctName,SiAcctId,Amt,TransType,TransMode)                    		
		var mny = db.GetSQL(&amp;quot;select to_number(&amp;apos;&amp;quot;+je+&amp;quot;&amp;apos;)*100 from dual&amp;quot;);	
		var retMap = new java.util.HashMap();
		var retMap = wssi2.F0112001(sbcode,yhjgdm,sblsh ,yszl_skzh ,yszl_skhm ,yszl_fkzh ,yszl_fkhm ,dwbh ,mny,TransType,TransMode,BankCode);
//		db.Rollback();
//		return retMap ;
		var busicode = retMap.get(&amp;quot;RstCode&amp;quot;);
		var busiinfo = retMap.get(&amp;quot;RstInfo&amp;quot;);
		//返回成功则继续 保存日记账
		if(busicode == &amp;quot;0000&amp;quot;) {
			sql = &amp;quot;update cw_yhrjzb set yszl_yhrzlsh = &amp;apos;&amp;quot;+retMap.get(&amp;quot;BkSeq&amp;quot;)+&amp;quot;&amp;apos;,yszl_yhrzrq =&amp;quot;+retMap.get(&amp;quot;BusiDate&amp;quot;)+&amp;quot;,yszl_yhrzsj = &amp;quot;+retMap.get(&amp;quot;BusiTime&amp;quot;)+&amp;quot;
					where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;&amp;quot;;	
			db.ExcecutSQL(sql);		
			try{writeLog(&amp;quot;单笔结算&amp;quot;,czyid,czyxm,thisorgid,thisaccid,&amp;quot;单笔成功，业务类型：&amp;quot;+yszlywlx+&amp;quot;,社保流水号：&amp;quot;+sblsh);}catch(ee){}									
			db.Commit();
			/*失败也要通知业务，接口待定*/			
			retmsg = 1;			
		}else {
			if(db != null) db.Rollback();
			retmsg = &amp;quot;交易出错&amp;quot;+busiinfo;
		}
		
	}
	catch(e) {
		if (db != null) db.Rollback();
		try{writeLog(&amp;quot;单笔结算&amp;quot;,czyid,czyxm,thisorgid,thisaccid,&amp;quot;单笔结算出错，业务类型：&amp;quot;+ysywlx+&amp;quot;,出错原因：&amp;quot;+e.toString());}catch(ee){}		
		//throw new Exception(e.toString());
		return e.toString();
	}
	finally {
		if (db != null) db.Close();
	}
	return retmsg;
}


//写日志
function writeLog(Action,opusr,opusrnam,org,acc,note)
{
	var GRDID = &amp;quot;YSZL_RJZLR&amp;quot;;
	var type = &amp;quot;银行账单笔录(社保发起)&amp;quot;;
	var SYT= &amp;quot;SBCW&amp;quot;;
	note = note.toString();
	note = pub.EAFunc.Replace(note,&amp;quot;&amp;apos;&amp;quot;,&amp;quot;&amp;apos;&amp;apos;&amp;quot;);
	if(note.length() &amp;gt;= 4000) {
		note = note.substring(0,3999);
	}	
	var sql = &amp;quot;insert into oplog(GRDID,TYPE,ACTION,OPUSR,OPUSRNAM,NOTE,ORG,ACC,SYT) values (&amp;apos;&amp;quot;+GRDID+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+type+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+Action+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+opusr+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+opusrnam+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+note+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+org+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+acc+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+SYT+&amp;quot;&amp;apos;)&amp;quot;;
	pub.EADbTool.ExcecutSQL(sql);
}










</GRDOSDS_VALUE></ROW>
</ROWSET>
</grdosds><fldhdr>
<ROWSET>
<ROW num="0" ><BILID >1单据编号</BILID><STAT >0单据状态</STAT><SUBTYP >0子类型</SUBTYP><CORPID >0往来单位编号</CORPID><CORPNAM >0往来单位名称</CORPNAM><LOCID >0仓库|部门编号</LOCID><LOCNAM >0仓库|部门名称</LOCNAM><DAT >0单据日期</DAT><CRTUSR >1录入人</CRTUSR><CRTUSRNAM >0录入人姓名</CRTUSRNAM><CRTDAT >0录入日期</CRTDAT><CHKUSR >1审核人</CHKUSR><CHKUSRNAM >0审核人姓名</CHKUSRNAM><CHKDAT >0审核日期</CHKDAT><SUMQTY >0合计金额</SUMQTY><SUMMNY >0合计金额</SUMMNY><REFID1 >0扩展字段</REFID1><REFNAM1 >0扩展字段</REFNAM1><REFID2 >0扩展字段</REFID2><REFNAM2 >0扩展字段</REFNAM2><REFID3 >0扩展字段</REFID3><REFNAM3 >0扩展字段</REFNAM3><REFID4 >0扩展字段</REFID4><REFNAM4 >0扩展字段</REFNAM4><REFID5 >0扩展字段</REFID5><REFNAM5 >0扩展字段</REFNAM5><REFID6 >0扩展字段</REFID6><REFNAM6 >0扩展字段</REFNAM6><NOTE >0备注</NOTE></ROW>
</ROWSET>
</fldhdr><flddtl>
<ROWSET>
<ROW num="0" ><SEQID >1明细序号</SEQID><ITMID >1品种编号</ITMID><ITMNAM >0品种名称</ITMNAM><ITEMPC >0品种批次号</ITEMPC><ITMSPC >0规格</ITMSPC><UNIT >0计量单位</UNIT><SMLUNT >0小计量单位</SMLUNT><UNTNUM >0大单位转小单位因子</UNTNUM><PRICE >0价格</PRICE><QTY >0数量</QTY><TAXTYP >0税率类型</TAXTYP><NOTAXMNY >0不含税税额</NOTAXMNY><TAXMNY >0税额</TAXMNY><MNY >0下单金额</MNY><REFID1 >0扩展字段</REFID1><REFNAM1 >0扩展字段</REFNAM1><REFID2 >0扩展字段</REFID2><REFNAM2 >0扩展字段</REFNAM2><REFID3 >0扩展字段</REFID3><REFNAM3 >0扩展字段</REFNAM3><REFID4 >0扩展字段</REFID4><REFNAM4 >0扩展字段</REFNAM4><REFID5 >0扩展字段</REFID5><REFNAM5 >0扩展字段</REFNAM5></ROW>
</ROWSET>
</flddtl></mdroot>