<?xml version='1.0' encoding='GBK'?><mdroot><grdds>
<ROWSET>
<ROW num="0" ><MWTYP >R</MWTYP><MWID >PZGL_RJZ2PZ</MWID><NAME >日记帐生成凭证</NAME><NOTE ></NOTE><NOACCNAME ></NOACCNAME><FILE >PZGL_RJZ2PZ.zxg</FILE><SCENE ></SCENE><FIXED ></FIXED><CATTYP ></CATTYP><DTLRNG ></DTLRNG><BATINP ></BATINP><MANUNIT ></MANUNIT><USESMLUNT ></USESMLUNT><ITEMTABLE ></ITEMTABLE><BILHDRTABLE ></BILHDRTABLE><BILDTLTABLE ></BILDTLTABLE><COLLIST ></COLLIST><WHERE ></WHERE><ORDER ></ORDER><DBNAME ></DBNAME><LISTSUM ></LISTSUM><LOADDATA ></LOADDATA><CHECKTITLE ></CHECKTITLE><IFBILL ></IFBILL><EXTJS >xlsgrid/js/main.js</EXTJS><JAVACLS ></JAVACLS><POST2MWID ></POST2MWID><LMS ></LMS><WIDTHMOD ></WIDTHMOD><HEIGHTMOD ></HEIGHTMOD><CLIENTCLASS ></CLIENTCLASS><SHOWBTN >0</SHOWBTN><CLOSEPAGES ></CLOSEPAGES><syt >SBCW</syt></ROW>
</ROWSET>
</grdds><grdjsds>
<ROWSET>
<ROW num="0" ><GRDJSDS_VALUE >var sheet_rjz1   = 0;
var sheet_rjz2   = 1;
var sheet_rjzmx1 = 2;
var sheet_param  = 3;
var sheet_tqsj   = 4;
var sheet_rjzmx2 = 5;

var cur_yyyy = &amp;quot;&amp;quot;;
var cur_mm   = &amp;quot;&amp;quot;;
var cur_kmbh = &amp;quot;&amp;quot;;
var cur_sbh  = &amp;quot;&amp;quot;;
var cur_zth  = &amp;quot;&amp;quot;;

var ZXGFILE0 = &amp;quot;&amp;quot;;
var ZXGFILE1 = &amp;quot;&amp;quot;;
var ZXGFILE2 = &amp;quot;&amp;quot;;
var ZXGFILE5 = &amp;quot;&amp;quot;;

var sum_jfje = 0.00;//借方金额
var sum_dfje = 0.00;//贷方金额
var jefx = &amp;quot;&amp;quot;;//金额方向
var zbs = 0;//总笔数

//数据加载完毕
function _thisOnpost_loaddata(sheet)
{
	initLayout();
	
	var yyList = _this.CreateListValueByXMLDS(_this.HttpCall(homeurl+&amp;quot;/XmlDB.sp?bind=V_CW_YYYY&amp;quot;),&amp;quot;ID&amp;quot;,&amp;quot;NAME&amp;quot;);
	var mmList = _this.CreateListValueByXMLDS(_this.HttpCall(homeurl+&amp;quot;/XmlDB.sp?bind=V_CW_MM&amp;quot;),&amp;quot;ID&amp;quot;,&amp;quot;NAME&amp;quot;);
	//var kmList =_this.CreateListValueByXMLDS(_this.HttpCall(homeurl+&amp;quot;/XmlDB.sp?bind=V_ACCITEM&amp;where=mjbz=1 and XJYHBZ&amp;lt;&amp;gt;0 and QLBZ&amp;lt;&amp;gt;1 and nvl(RJZKM_LRBZ,&amp;apos;1&amp;apos;) = &amp;apos;1&amp;apos;&amp;quot;),&amp;quot;ID&amp;quot;,&amp;quot;NAME&amp;quot;);
	var logyymm = G_LOGDAT.substring(0,7).replace(&amp;quot;-&amp;quot;,&amp;quot;&amp;quot;); //登录年月
	var kmList =_this.CreateListValueByXMLDS(_this.HttpCall(homeurl+&amp;quot;/XmlDB.sp?bind=V_ACCITEM&amp;where=mjbz=1 and XJYHBZ&amp;lt;&amp;gt;0 and QLBZ&amp;lt;&amp;gt;1 and nvl(RJZKM_LRBZ,&amp;apos;1&amp;apos;) = &amp;apos;1&amp;apos; and nvl(jssj,&amp;apos;999999&amp;apos;)&amp;gt;=&amp;apos;&amp;quot;+logyymm+&amp;quot;&amp;apos; and nvl(kssj,&amp;apos;190001&amp;apos;)&amp;lt;=&amp;apos;&amp;quot;+logyymm+&amp;quot;&amp;apos;&amp;quot;),&amp;quot;ID&amp;quot;,&amp;quot;NAME&amp;quot;);
	
	cur_yyyy = G_LOGDAT.substring(0,4);
	cur_mm = 1*(G_LOGDAT.substring(5,7));
	
	_this.SetToComboBox(&amp;quot;&amp;quot;,sheet_param,1,1,yyList); _this.SetCellText(sheet_param,1,1,cur_yyyy);
	_this.SetToComboBox(&amp;quot;&amp;quot;,sheet_param,1,3,mmList); _this.SetCellText(sheet_param,1,3,cur_mm);
	_this.SetToComboBox(&amp;quot;&amp;quot;,sheet_param,1,7,kmList);
	
	cur_sbh = G_ORGID;
	cur_zth = G_ACCID.replace(G_ORGID,&amp;quot;&amp;quot;);
	
	_this.AutoFixScreenWidth();
}

//页面布局初始化
function initLayout(){
	var layoutxml=&amp;quot;&amp;lt;?xml version = &amp;apos;1.0&amp;apos; encoding=\&amp;quot;GBK\&amp;quot;?&amp;gt; &amp;quot;+
			&amp;quot;&amp;lt;ROWSET&amp;gt;&amp;quot;+
			&amp;quot;&amp;lt;ROW &amp;gt;&amp;quot;+
			 &amp;quot;&amp;lt;C0  height=\&amp;quot;8%\&amp;quot; width=\&amp;quot;100%\&amp;quot; ROWSPAN=\&amp;quot;2\&amp;quot; COLSPAN=\&amp;quot;1\&amp;quot;&amp;gt;3&amp;lt;/C0&amp;gt;&amp;quot;+
			&amp;quot;&amp;lt;/ROW&amp;gt;&amp;quot;+
			&amp;quot;&amp;lt;ROW &amp;gt;&amp;quot;+
			 &amp;quot;&amp;lt;C0  height=\&amp;quot;67%\&amp;quot; width=\&amp;quot;50%\&amp;quot; ROWSPAN=\&amp;quot;1\&amp;quot; COLSPAN=\&amp;quot;1\&amp;quot;&amp;gt;0&amp;lt;/C0&amp;gt;&amp;quot;+
			 &amp;quot;&amp;lt;C1  height=\&amp;quot;67%\&amp;quot; width=\&amp;quot;50%\&amp;quot; ROWSPAN=\&amp;quot;1\&amp;quot; COLSPAN=\&amp;quot;1\&amp;quot;&amp;gt;1&amp;lt;/C1&amp;gt;&amp;quot;+
			&amp;quot;&amp;lt;/ROW&amp;gt;&amp;quot;+
			&amp;quot;&amp;lt;ROW &amp;gt;&amp;quot;+
			 &amp;quot;&amp;lt;C0  height=\&amp;quot;20%\&amp;quot; width=\&amp;quot;50%\&amp;quot; ROWSPAN=\&amp;quot;1\&amp;quot; COLSPAN=\&amp;quot;1\&amp;quot;&amp;gt;2&amp;lt;/C0&amp;gt;&amp;quot;+
			 &amp;quot;&amp;lt;C1  height=\&amp;quot;20%\&amp;quot; width=\&amp;quot;50%\&amp;quot; ROWSPAN=\&amp;quot;1\&amp;quot; COLSPAN=\&amp;quot;1\&amp;quot;&amp;gt;5&amp;lt;/C1&amp;gt;&amp;quot;+
			&amp;quot;&amp;lt;/ROW&amp;gt;&amp;quot;+
			&amp;quot;&amp;lt;ROW &amp;gt;&amp;quot;+
			 &amp;quot;&amp;lt;C0  height=\&amp;quot;5%\&amp;quot; width=\&amp;quot;100%\&amp;quot; ROWSPAN=\&amp;quot;1\&amp;quot; COLSPAN=\&amp;quot;2\&amp;quot;&amp;gt;4&amp;lt;/C0&amp;gt;&amp;quot;+
			&amp;quot;&amp;lt;/ROW&amp;gt;&amp;quot;+
			&amp;quot;&amp;lt;/ROWSET&amp;gt;&amp;quot;;
	_this.SetLayoutDS(layoutxml);
	
//	_this.AddToolbarButton(&amp;quot;udf_btnSearchPrev&amp;quot;,&amp;quot;上一个&amp;quot;,&amp;quot;上一个&amp;quot;,&amp;quot;&amp;quot;,0,7,7,60);
//	_this.AddToolbarButton(&amp;quot;udf_btnSearchNext&amp;quot;,&amp;quot;下一个&amp;quot;,&amp;quot;下一个&amp;quot;,&amp;quot;&amp;quot;,0,7,7,60);
//	_this.AddToolbarButton(&amp;quot;udf_btnSearch&amp;quot;,&amp;quot;查找筛选&amp;quot;,&amp;quot;查找筛选&amp;quot;,&amp;quot;&amp;quot;,0,7,7,60);
	
	_this.AddToolbarButton(&amp;quot;udf_btnGl&amp;quot;,&amp;quot;过滤&amp;quot;,&amp;quot;过滤&amp;quot;,&amp;quot;&amp;quot;,0,1,1,60);
	_this.AddToolbarButton(&amp;quot;udf_btnAllXz&amp;quot;,&amp;quot;全选&amp;quot;,&amp;quot;全选&amp;quot;,&amp;quot;&amp;quot;,0,1,1,60);
	_this.AddToolbarButton(&amp;quot;udf_btnAllWxz&amp;quot;,&amp;quot;全未选&amp;quot;,&amp;quot;全未选&amp;quot;,&amp;quot;&amp;quot;,0,3,3,60);
	_this.AddToolbarButton(&amp;quot;udf_btnChkJE&amp;quot;,&amp;quot;检查金额&amp;quot;,&amp;quot;检查金额&amp;quot;,&amp;quot;&amp;quot;,0,3,3,60);
	_this.AddToolbarButton(&amp;quot;udf_btnScpz&amp;quot;,&amp;quot;生成凭证&amp;quot;,&amp;quot;生成凭证&amp;quot;,&amp;quot;&amp;quot;,0,5,5,60);
	

	var tqsjItem = _this.CreateListValue();
	_this.SetListValue(tqsjItem,&amp;quot;1&amp;quot;,&amp;quot;财务批次号&amp;quot;);
//	_this.SetListValue(tqsjItem,&amp;quot;2&amp;quot;,&amp;quot;款项&amp;quot;);
	_this.SetListValue(tqsjItem,&amp;quot;3&amp;quot;,&amp;quot;日&amp;quot;);
//	_this.SetListValue(tqsjItem,&amp;quot;4&amp;quot;,&amp;quot;单位类型&amp;quot;);
	_this.SetToRadioBox(&amp;quot;&amp;quot;,sheet_tqsj,1,1,tqsjItem);
	_this.SetCellText(sheet_tqsj,1,1,&amp;quot;1&amp;quot;);	
	
	ZXGFILE0 = _this.SaveTempZXGFile(0); 
	ZXGFILE1 = _this.SaveTempZXGFile(1);
	ZXGFILE2 = _this.SaveTempZXGFile(2);	
	ZXGFILE5 = _this.SaveTempZXGFile(5);
	
	_this.SetAttribe(&amp;quot;SHEET_0&amp;quot;,_this.ATTR_SHEET_SELECTFLAG,_this. SELECTFLAG_SINGLEROW );
	_this.SetAttribe(&amp;quot;SHEET_1&amp;quot;,_this.ATTR_SHEET_SELECTFLAG,_this. SELECTFLAG_SINGLEROW );
	_this.SetAttribe(&amp;quot;SHEET_2&amp;quot;,_this.ATTR_SHEET_SELECTFLAG,_this. SELECTFLAG_SINGLEROW );
	_this.SetAttribe(&amp;quot;SHEET_5&amp;quot;,_this.ATTR_SHEET_SELECTFLAG,_this. SELECTFLAG_SINGLEROW );

}

//加载日记账数据
function loadRjzData(yyyy,mm,kmbh,filter){
	_this.SetToolbarString(&amp;quot;正在加载数据...&amp;quot;);
	resetTips();
	
	//清空数据
	_this.LoadZXGFile(ZXGFILE0,-1,0);
	_this.SetAttribe(&amp;quot;SHEET_&amp;quot;+sheet_rjz1,_this.ATTR_SHOW_ZERO,1);
	_this.SetFixedRow(sheet_rjz1,1);
	_this.SetMainCellRange(sheet_rjz1,1,0,_this.GetRowCount(sheet_rjz1)-2,_this.GetColCount(sheet_rjz1)-1);
	
	_this.LoadZXGFile(ZXGFILE0,-1,1);
	_this.SetAttribe(&amp;quot;SHEET_&amp;quot;+sheet_rjz2,_this.ATTR_SHOW_ZERO,1);
	_this.SetFixedRow(sheet_rjz2,1);
	_this.SetMainCellRange(sheet_rjz2,1,0,_this.GetRowCount(sheet_rjz2)-2,_this.GetColCount(sheet_rjz2)-1);
	
	_this.LoadZXGFile(ZXGFILE2,-1,2);

	//加载日记账数据
	var xml = _sql.query(&amp;quot;rjzpzsc&amp;quot;,&amp;quot;YYYY=&amp;quot;+yyyy+&amp;quot;&amp;MM=&amp;quot;+mm+&amp;quot;&amp;KMBH=&amp;quot;+kmbh+&amp;quot;&amp;FILTER=&amp;quot;+filter+&amp;quot;&amp;SBH=&amp;quot;+cur_sbh+&amp;quot;&amp;ZTH=&amp;quot;+cur_zth);
	_this.SetXmlDS(sheet_rjz1,1,0,_this.GetRowCount(sheet_rjz1)-2,_this.GetColCount(sheet_rjz1)-1,xml);
	jsSumJE(sheet_rjz1);
	
	//设置选择控件
	_this.SetToBoolBox(sheet_rjz1,0,0);
	for (var r=_this.GetMainCellRangeRow1(sheet_rjz1);r&amp;lt;=_this.GetMainCellRangeRow2(sheet_rjz1);r++) {
		if (_this.GetCellText(sheet_rjz1,r,1) != &amp;quot;&amp;quot;) {
			_this.SetToBoolBox(sheet_rjz1,r,0);
			var jefx = _this.GetCellText(sheet_rjz1,r,5);
			var kxlx = _this.GetCellText(sheet_rjz1,r,10);
			//贷方整行颜色提示，利息整行颜色提示 81款项利息收入
			if (jefx == &amp;quot;贷&amp;quot; || kxlx.indexOf(&amp;quot;81&amp;quot;) &amp;gt; -1) {
				setOneRowCellColor(sheet_rjz1,r,255,0,0);
			}
		}
	}
	
	//加载日记帐明细
	var sblsh = _this.GetCellText(sheet_rjz1,1,6);
	loadRJZMXData(sblsh);
	
	_this.AutoFixScreenWidth();
	_this.SetToolbarString(&amp;quot;&amp;quot;);

}

//加载日记账明细数据
function loadRJZMXData(sblsh){
	_this.SetToolbarString(&amp;quot;正在加载数据...&amp;quot;);
	
	//清空前面加载的日记账明细数据
	_this.loadZXGFile(ZXGFILE2,-1,2);
	_this.SetAttribe(&amp;quot;SHEET_&amp;quot;+sheet_rjzmx1,_this.ATTR_SHOW_ZERO,1);
	_this.SetFixedRow(sheet_rjzmx1,1);
	_this.SetFixedRow(sheet_rjzmx1,2);	
	_this.SetMainCellRange(sheet_rjzmx1,1,0,_this.GetRowCount(sheet_rjzmx1)-2,_this.GetColCount(sheet_rjzmx1)-1);

	var xml = _sql.query(&amp;quot;rjzmxb&amp;quot;,&amp;quot;SBLSH=&amp;quot;+sblsh+&amp;quot;&amp;SBH=&amp;quot;+cur_sbh+&amp;quot;&amp;ZTH=&amp;quot;+cur_zth+&amp;quot;&amp;KMBH=&amp;quot;+cur_kmbh);
	_this.SetXmlDS(sheet_rjzmx1,1,0,_this.GetRowCount(sheet_rjzmx1)-2,_this.GetColCount(sheet_rjzmx1)-1,xml);	
	for (var r=_this.GetMainCellRangeRow1(sheet_rjzmx1);r&amp;lt;=_this.GetMainCellRangeRow2(sheet_rjzmx1);r++) {
		if (_this.GetCellText(sheet_rjzmx1,r,0) == &amp;quot;&amp;quot;) _this.SetRowVisible(sheet_rjzmx1,r,-1);
	}

	_this.SetToolbarString(&amp;quot;&amp;quot;);
	_this.AutoFixScreenWidth();
	
	jsSumJE(sheet_rjzmx1);

}

//加载日记账明细数据(生成凭证部分)
function loadRJZMXData2(sblsh){
	_this.SetToolbarString(&amp;quot;正在加载数据...&amp;quot;);
	
	//清空前面加载的日记账明细数据
	_this.loadZXGFile(ZXGFILE5,-1,5);
	_this.SetAttribe(&amp;quot;SHEET_&amp;quot;+sheet_rjzmx2,_this.ATTR_SHOW_ZERO,1);
	_this.SetFixedRow(sheet_rjzmx2,1);
	_this.SetFixedRow(sheet_rjzmx2,2);	
	_this.SetMainCellRange(sheet_rjzmx2,1,0,_this.GetRowCount(sheet_rjzmx2)-2,_this.GetColCount(sheet_rjzmx2)-1);

	var xml = _sql.query(&amp;quot;rjzmxb&amp;quot;,&amp;quot;SBLSH=&amp;quot;+sblsh+&amp;quot;&amp;SBH=&amp;quot;+cur_sbh+&amp;quot;&amp;ZTH=&amp;quot;+cur_zth+&amp;quot;&amp;KMBH=&amp;quot;+cur_kmbh);
	_this.SetXmlDS(sheet_rjzmx2,1,0,_this.GetRowCount(sheet_rjzmx2)-2,_this.GetColCount(sheet_rjzmx2)-1,xml);	
	for (var r=_this.GetMainCellRangeRow1(sheet_rjzmx2);r&amp;lt;=_this.GetMainCellRangeRow2(sheet_rjzmx2);r++) {
		if (_this.GetCellText(sheet_rjzmx2,r,1) == &amp;quot;&amp;quot;) _this.SetRowVisible(sheet_rjzmx2,r,-1);
	}
	
	_this.SetToolbarString(&amp;quot;&amp;quot;);
	_this.RefreshFormula();
	_this.AutoFixScreenWidth();
	
	jsSumJE(sheet_rjzmx2);

}

//按范围提取数据
function tqsjFwxz(){
	var tqsjRadioRet = _this.GetCellText(sheet_tqsj,1,1);
	_this.SetToStandardCell(sheet_tqsj,1,6);
	_this.SetCellText(sheet_tqsj,1,6,&amp;quot;&amp;quot;);
	if(tqsjRadioRet == &amp;quot;1&amp;quot;)
	{
		_this.SetCellText(sheet_tqsj,1,5,&amp;quot;财务批次号&amp;quot;);		
	}else if(tqsjRadioRet == &amp;quot;2&amp;quot;)
	{
//		_this.SetCellText(sheet_tqsj,1,5,&amp;quot;款项&amp;quot;);
//		var rjkxbhList =_this.CreateListValueByXMLDS(_this.HttpCall(homeurl+&amp;quot;/XmlDB.sp?bind=V_CW_RJZKXLXB&amp;quot;),&amp;quot;ID&amp;quot;,&amp;quot;NAME&amp;quot;);
//		_this.SetToComboBox(&amp;quot;&amp;quot;,sheet_tqsj,1,6,rjkxbhList);		
	}else if(tqsjRadioRet == &amp;quot;3&amp;quot;)
	{
		_this.SetCellText(sheet_tqsj,1,5,&amp;quot;日&amp;quot;);
	}else if(tqsjRadioRet == &amp;quot;4&amp;quot;)
	{
//		_this.SetCellText(sheet_tqsj,1,5,&amp;quot;单位类型&amp;quot;);
//		var dwlxList =_this.CreateListValueByXMLDS(_this.HttpCall(homeurl+&amp;quot;/XmlDB.sp?bind=SI_DWLXB&amp;quot;),&amp;quot;DWLXBH&amp;quot;,&amp;quot;DWLX&amp;quot;);
//		_this.SetToComboBox(&amp;quot;&amp;quot;,sheet_tqsj,1,6,dwlxList);
	}
}

//修改单元格内容
function _thisOnCellModify(sheet,row,col,oldvalue,newvalue)
{
	if(sheet == sheet_param) {
		if(row == 1 &amp;&amp; (col == 7 || col == 1 || col == 3)) {			
			cur_yyyy = _this.GetCellText(sheet_param,1,1);
			cur_mm   = _this.GetCellText(sheet_param,1,3);
			cur_kmbh = _this.GetCellText(sheet_param,1,7);
			
			if(cur_kmbh == &amp;quot;&amp;quot; || cur_kmbh == &amp;quot;undefind&amp;quot;)
			{
				alert(&amp;quot;科目编号不能为空!!&amp;quot;);
				return false;
			}else{
				loadRjzData(cur_yyyy,cur_mm,cur_kmbh,&amp;quot;&amp;quot;);
			}
		}
	}
	else if(sheet == sheet_tqsj) {
		if(row == 1 &amp;&amp; col == 6) {
			var tqsjRadioRet = _this.GetCellText(sheet_tqsj,1,1);	
			getTqsj(sheet,row,col,tqsjRadioRet );
		}
	}
	else if (sheet == sheet_rjz1 || sheet == sheet_rjz2) {
		if (row == 0 &amp;&amp; col == 0) {
			for (var r=_this.GetMainCellRangeRow1(sheet);r&amp;lt;=_this.GetMainCellRangeRow2(sheet);r++) {
				if (_this.GetCellText(sheet,r,1) != &amp;quot;&amp;quot;) {
					_this.SetCellText(sheet,r,0,newvalue);
					if (sheet == sheet_rjz1) {
						if (newvalue == 1) rjz1CopyRjz2(sheet_rjz1,r,&amp;quot;&amp;quot;,&amp;quot;1&amp;quot;);
						else btnAllWxz();
					}
				}
			}
		}
		else if (row &amp;gt;= _this.GetMainCellRangeRow1(sheet) &amp;&amp; row &amp;lt;= _this.GetMainCellRangeRow2(sheet) &amp;&amp; col == 0) {
			if (newvalue == 1) rjz1CopyRjz2(sheet_rjz1,row,&amp;quot;&amp;quot;,&amp;quot;1&amp;quot;);
			else {
				cancelSelectRJZ(_this.GetCellText(sheet,row,6));
			}
		}
	}
}

//取消右边的日记帐选择
function cancelSelectRJZ(sblsh)
{
	for (var r=_this.GetMainCellRangeRow1(sheet_rjz2);r&amp;lt;=_this.GetMainCellRangeRow2(sheet_rjz2);r++) {
		var siseqno = _this.GetCellText(sheet_rjz2,r,6);
		if (siseqno == sblsh) {
			rjz1CopyRjz2(sheet_rjz2,r,&amp;quot;&amp;quot;,&amp;quot;2&amp;quot;);
		}
	}
}

//选择科目
function showKM()
{
	var obj = new Object();
        obj.filter = &amp;quot;xjyhbz &amp;lt;&amp;gt; 0&amp;quot;;
        obj.mjbz = &amp;quot;1&amp;quot;;
        obj.bz = &amp;quot;&amp;quot;;
        obj.jb = 0;
        obj.kmbh = &amp;quot;&amp;quot;;
	var retVal = window.showModalDialog(&amp;quot;show.sp?grdid=CW_KMSEL&amp;quot;,obj,&amp;quot;dialogWidth=600px;dialogHeight=500px&amp;quot;);
	return retVal;
}

//鼠标左键点击
function _thisOnMouseLClick(sheet,row,col)
{
	if(sheet == sheet_tqsj)
	{
		if(row == 1 &amp;&amp; col == 1)
		{
			tqsjFwxz();
		}
		else if (row == 1 &amp;&amp; col == 8) { //筛选查找
			btnSearch();
		}
		else if (row == 1 &amp;&amp; col == 9) { //上一个
			btnSearchPrev();
		}
		else if (row == 1 &amp;&amp; col == 10) { //下一个
			btnSearchNext();
		}
		
	}else if(sheet == sheet_param)
	{
		if(row == 1 &amp;&amp; col == 8)
		{
			var retVal = showKM();
			if (retVal != &amp;quot;&amp;quot; &amp;&amp; retVal != &amp;quot;undefined&amp;quot; &amp;&amp; retVal != undefined) {
				_this.SetCellText(sheet_param,1,7,retVal);
				cur_kmbh = retVal;
				loadRjzData(cur_yyyy,cur_mm,cur_kmbh,&amp;quot;&amp;quot;);
			}
		}
	}else if(sheet == sheet_rjz2 &amp;&amp; row &amp;gt; 0){
		var sblsh = _this.GetCellText(sheet_rjz2,row,6);
		
		if(sblsh != &amp;quot;&amp;quot;){
			loadRJZMXData2(sblsh);
		}
	}else if(sheet == sheet_rjz1 &amp;&amp; row &amp;gt; 0){
		var sblsh = _this.GetCellText(sheet_rjz1,row,6);
		
		if(sblsh != &amp;quot;&amp;quot;){
			loadRJZMXData(sblsh);
		}
	}
}

//鼠标双击
function _thisOnMouseDClick(sheet,row,col)
{	
	if(sheet == sheet_rjz1) {
		if(row &amp;gt;= _this.GetMainCellRangeRow1(sheet) &amp;&amp; row &amp;lt;= _this.GetMainCellRangeRow2(sheet)) {
			if (_this.GetCellText(sheet,row,1) != &amp;quot;&amp;quot;) {
				var bz = _this.GetCellText(sheet,row,11);
				if (bz == &amp;quot;&amp;quot;) {
					rjz1CopyRjz2(sheet,row,col,1);
				}
				else {
					cancelSelectRJZ(_this.GetCellText(sheet,row,6));
				}
			}
		}
	}
	else if(sheet == sheet_rjz2) {
		if(row &amp;gt;= _this.GetMainCellRangeRow1(sheet) &amp;&amp; row &amp;lt;= _this.GetMainCellRangeRow2(sheet)){
			if (_this.GetCellText(sheet,row,1) != &amp;quot;&amp;quot;) {
				rjz1CopyRjz2(sheet,row,col,2);
				loadRJZMXData2(&amp;quot;&amp;quot;);
			}
		}
		//如果删除了全部明细行，那么重新加载空模板
		if (_this.GetRowCount(sheet) == 2) {
			_this.LoadZXGFile(ZXGFILE1,-1,sheet_rjz2);
			_this.SetMainCellRange(sheet_rjz2,1,0,_this.GetRowCount(sheet_rjz2)-2,_this.GetColCount(sheet_rjz2)-1);
			for(var r = 1;r&amp;lt;= _this.GetRowCount(sheet_rjz1);r++) {
				//_this.SetCellBkColor(sheet_rjz1,r,3,255,255,255);
				_this.SetCellText(sheet_rjz1,r,11,&amp;quot;&amp;quot;);
			}
			loadRJZMXData2(&amp;quot;&amp;quot;);
		}
	}
}

//选择生成凭证数据
function getTqsj(sheet,row,col,ret)
{	
	var str1 = _this.GetCellText(sheet_tqsj,1,6);
	var str2 = _this.GetCellText(sheet_tqsj,1,7);
	var count = 0;

	for(var i = 1;i &amp;lt;= _this.GetRowCount(sheet_rjz1) - 2;i++) {	
		count ++;
		var rq   = _this.GetCellText(sheet_rjz1,i,1);
		var pch  = _this.GetCellText(sheet_rjz1,i,2);
		var dwbh = _this.GetCellText(sheet_rjz1,i,9);
		var dwbh = _this.GetCellText(sheet_rjz1,i,10);
		var dwlxbh = _this.GetCellText(sheet_rjz1,i,13);
		var lsh  = _this.GetCellText(sheet_rjz1,i,6);

		if(ret == 1) { //按批次查询
			if(str1 == pch &amp;&amp; pch != &amp;quot;&amp;quot; &amp;&amp; str1 != &amp;quot;&amp;quot;)	{
				rjz1CopyRjz2(sheet,i,0,1);
			}
		}
		else if(ret == 2) { //按款项
			var lxbh = str1.split(&amp;quot;-&amp;quot;)[0];
			var lxxh = str1.split(&amp;quot;-&amp;quot;)[1];			
			_sql.querytods(&amp;quot;getCount&amp;quot;,&amp;quot;SBH=&amp;quot;+cur_sbh+&amp;quot;&amp;ZTH=&amp;quot;+cur_zth+&amp;quot;&amp;LSH=&amp;quot;+lsh+&amp;quot;&amp;LXBH=&amp;quot;+lxbh+&amp;quot;&amp;LXXH=&amp;quot;+lxxh);
			var count =  _this.XMLDS_GetString(0,&amp;quot;COUNT&amp;quot;);
			
			if(count &amp;gt; 0){
				rjz1CopyRjz2(sheet,i,0,1);
			}
			
		}
		else if(ret == 3) { //按日
			if(str1 == rq &amp;&amp; str1 != &amp;quot;&amp;quot;) {
				rjz1CopyRjz2(sheet,i,0,1);
			}
		}
		else if(ret == 4) { //按单位类型
			if(str1 == dwlxbh &amp;&amp; str1 != &amp;quot;&amp;quot;){
				rjz1CopyRjz2(sheet,i,0,1);
			}
		}
		
		if(str2 != &amp;quot;&amp;quot; &amp;&amp; str2 == count){
			return false;
		}
	}
}

//将日记账选择数据复制到日记账2
function rjz1CopyRjz2(sheet,row,col,ret)
{
	if (ret == 1) {
		var bz = _this.GetCellText(sheet_rjz1,row,11);
		var rjz1_lsh = _this.GetCellText(sheet_rjz1,row,6);
		if(rjz1_lsh == &amp;quot;&amp;quot; || rjz1_lsh == null) return false;
		if(bz == 1) return false;
		
		for(var i = 1; i &amp;lt;= _this.GetRowCount(sheet_rjz2) - 1; i++) {			
			//追加行数
			if(i == _this.GetRowCount(sheet_rjz2) - 1){
				_this.AppendRow(sheet_rjz2,i-1);
				_this.SetMainCellRange(sheet_rjz2,1,0,_this.GetRowCount(sheet_rjz2)-2,_this.GetColCount(sheet_rjz2)-1);				
			}
			var lsh = _this.GetCellText(sheet_rjz2,i,6);
			if(lsh == &amp;quot;&amp;quot; || lsh == null){
				for(var j=1;j&amp;lt;= _this.GetColCount(sheet_rjz1) - 1;j++) {
					_this.SetCellText(sheet_rjz2,i,j,_this.GetCellText(sheet_rjz1,row,j) );					
				}
				jefx = _this.GetCellText(sheet_rjz1,row,5);
				var je = _this.GetCellText(sheet_rjz1,row,4)*1;
				if(jefx == &amp;quot;借&amp;quot;) {
					sum_jfje += je;
				}
				else if(jefx == &amp;quot;贷&amp;quot;) {
					sum_dfje += je;
				}
				zbs ++;
				//_this.SetCellBkColor(sheet_rjz1,row,3,220,20,60);
				_this.SetCellText(sheet_rjz1,row,11,&amp;quot;1&amp;quot;);
				_this.SetCellText(sheet_rjz1,row,0,&amp;quot;1&amp;quot;);
				break;
			}
		}
		var jdce = 1.00*sum_jfje-1.00*sum_dfje;//借贷差额
		if(jdce &amp;gt; 0) {
			jdce = &amp;quot;借：&amp;quot;+jdce.toFixed(2);
		}
		else if(jdce &amp;lt; 0) {
			jdce = &amp;quot;贷：&amp;quot;+jdce.toFixed(2);
		}
		else {
			jdce = &amp;quot;&amp;quot;;
		}
		_this.SetCellText(sheet_param,1,11,sum_jfje);
		_this.SetCellText(sheet_param,1,13,sum_dfje);
		_this.SetCellText(sheet_param,1,15,zbs);
		_this.SetCellText(sheet_param,1,17,jdce);
	}
	else if(ret == 2) {
		var lsh = _this.GetCellText(sheet_rjz2,row,6);
		//for(var i = row; i&amp;lt;= row ; i++) {
			jefx = _this.GetCellText(sheet_rjz2,row,5);
			var je = _this.GetCellText(sheet_rjz2,row,4)*1;			
			for(var j = 1;j &amp;lt;= 10 ;j++) {
				_this.SetCellText(sheet_rjz2,row,j,&amp;quot;&amp;quot; );				
			}
			if(lsh != &amp;quot;&amp;quot;) {
				if(jefx == &amp;quot;借&amp;quot;) {
					sum_jfje -= je;
				}
				else if(jefx == &amp;quot;贷&amp;quot;) {
					sum_dfje -= je;
				}
				zbs --;					
			}			
			_this.DeleteRow(sheet_rjz2,row);
			//break;
		//}
		var jdce = 1.00*sum_jfje-1.00*sum_dfje;//借贷差额
		if(jdce &amp;gt; 0) {
			jdce = &amp;quot;借：&amp;quot;+jdce.toFixed(2);
		}
		else if(jdce &amp;lt; 0) {
			jdce = &amp;quot;贷：&amp;quot;+jdce.toFixed(2);
		}
		else {
			jdce = &amp;quot;&amp;quot;;
		}
		_this.SetCellText(sheet_param,1,11,sum_jfje);
		_this.SetCellText(sheet_param,1,13,sum_dfje);
		_this.SetCellText(sheet_param,1,15,zbs);
		_this.SetCellText(sheet_param,1,17,jdce);			
		for(var r = 1;r&amp;lt;= _this.GetRowCount(sheet_rjz1);r++) {
			var lsh_rjz1 = _this.GetCellText(sheet_rjz1,r,6);
			if(lsh == lsh_rjz1) {
				//_this.SetCellBkColor(sheet_rjz1,r,3,255,255,255);
				_this.SetCellText(sheet_rjz1,r,11,&amp;quot;&amp;quot;);
				_this.SetCellText(sheet_rjz1,r,0,&amp;quot;0&amp;quot;);
				break;
			}
		}
		
		//如果删除了全部明细行，那么重新加载空模板
		if (_this.GetRowCount(sheet_rjz2) == 2) {
			_this.LoadZXGFile(ZXGFILE1,-1,sheet_rjz2);
			_this.SetMainCellRange(sheet_rjz2,1,0,_this.GetRowCount(sheet_rjz2)-2,_this.GetColCount(sheet_rjz2)-1);
			loadRJZMXData2(&amp;quot;&amp;quot;);
		}

	}

	jsSumJE(sheet_rjz2);
	
	//设置选择控件
	_this.SetToBoolBox(sheet_rjz2,0,0);
	for (var r=_this.GetMainCellRangeRow1(sheet_rjz2);r&amp;lt;=_this.GetMainCellRangeRow2(sheet_rjz2);r++) {
		if (_this.GetCellText(sheet_rjz2,r,1) != &amp;quot;&amp;quot;) {
			_this.SetToBoolBox(sheet_rjz2,r,0);
		}
	}
	
	_this.Redraw();
}

//全未选
function btnAllWxz()
{
	_this.LoadZXGFile(ZXGFILE1,-1,sheet_rjz2);
	_this.SetMainCellRange(sheet_rjz2,1,0,_this.GetRowCount(sheet_rjz2)-2,_this.GetColCount(sheet_rjz2)-1);
	for(var r = 0;r&amp;lt;= _this.GetMainCellRangeRow2(sheet_rjz1);r++) {
		if (_this.GetCellText(sheet_rjz1,r,1) != &amp;quot;&amp;quot;) {
			//_this.SetCellBkColor(sheet_rjz1,r,3,255,255,255);
			_this.SetCellText(sheet_rjz1,r,11,&amp;quot;&amp;quot;);
			_this.SetCellText(sheet_rjz1,r,0,&amp;quot;0&amp;quot;);
		}
	}
	loadRJZMXData2(&amp;quot;&amp;quot;);
}

//全选
function btnAllXz()
{
	//弹出款项类型选择//window.returnValue = lxbh;
	var kxsel = window.showModalDialog(&amp;quot;show.sp?grdid=RJZ_KXSEL3&amp;quot;,null,&amp;quot;dialogWidth=300px;dialogHeight=260px&amp;quot;);
	if (kxsel != &amp;quot;undefined&amp;quot; &amp;&amp; kxsel != undefined &amp;&amp; kxsel != &amp;quot;&amp;quot;) {
		var rjzxml = invokeOSFunc(&amp;quot;getRjzByKXBZ&amp;quot;,&amp;quot;sbh=&amp;quot;+cur_sbh+&amp;quot;&amp;zth=&amp;quot;+cur_zth+&amp;quot;&amp;yyyy=&amp;quot;+cur_yyyy+&amp;quot;&amp;mm=&amp;quot;+cur_mm+&amp;quot;&amp;kmbh=&amp;quot;+cur_kmbh+&amp;quot;&amp;bz=&amp;quot;+kxsel);
		_this.XMLDS_Reset();
		_this.XMLDS_Parse(rjzxml);
		for (var i=0;i&amp;lt;_this.XMLDS_GetRowCount();i++) {
			var siseqno = _this.XMLDS_GetString(i,&amp;quot;SISEQNO&amp;quot;);
			var dd = _this.XMLDS_GetString(i,&amp;quot;DD&amp;quot;);
			for (var r = 1; r &amp;lt;= _this.GetRowCount(sheet_rjz1) - 1; r++){
				if (siseqno == _this.GetCellText(sheet_rjz1,r,6) &amp;&amp; dd == _this.GetCellText(sheet_rjz1,r,1)) {
					rjz1CopyRjz2(sheet_rjz1,r,&amp;quot;&amp;quot;,&amp;apos;1&amp;apos;);
					break;
				}
			}
		}
	}
	
}

//过滤
function btnGl()
{
	var obj = new Object();
	obj.yyyy = cur_yyyy;
	obj.mm = cur_mm;
	obj.kmbh = cur_kmbh;	
	
	_sql.querytods(&amp;quot;getKmmc&amp;quot;,&amp;quot;SBH=&amp;quot;+cur_sbh+&amp;quot;&amp;ZTH=&amp;quot;+cur_zth+&amp;quot;&amp;KMBH=&amp;quot;+cur_kmbh);
	var kmmc = _this.XMLDS_GetString(0,&amp;quot;KMMC&amp;quot;);
	
	obj.kmmc = kmmc;
	var retVal = window.showModalDialog(&amp;quot;show.sp?grdid=RJZ_FILTER&amp;quot;,obj,&amp;quot;dialogWidth=600px;dialogHeight=300px&amp;quot;);
	var param = retVal;
//	alert(param.dat1+&amp;quot;,kmbh=&amp;quot;+param.kmbh);
//	if (filter != &amp;quot;&amp;quot; &amp;&amp; filter != &amp;quot;undefined&amp;quot; &amp;&amp; filter != undefined) {
//		alert(&amp;quot;过滤&amp;quot;);
//	}

	try {
		var filter = &amp;quot;&amp;quot;;
		if (param.reset == &amp;quot;1&amp;quot;) { //恢复
			loadRjzData(cur_yyyy,cur_mm,cur_kmbh,&amp;quot;&amp;quot;);
		}
		else {
			if (param.dat1 != &amp;quot;&amp;quot;) {
				var dat1 = param.dat1;
				var dat2 = param.dat2;
				//cur_yyyy = dat1.split(&amp;quot;-&amp;quot;)[0];
				//cur_mm = 1 * (dat1.split(&amp;quot;-&amp;quot;)[1]);
				var dd1 = 1 * (dat1.split(&amp;quot;-&amp;quot;)[2]);
				var dd2 = 1 * (dat2.split(&amp;quot;-&amp;quot;)[2]);
				filter = &amp;quot; and (A.dd&amp;gt;=&amp;quot;+dd1+&amp;quot; and A.dd&amp;lt;=&amp;quot;+dd2+&amp;quot;)&amp;quot;;
			}
			if (param.jsfs != &amp;quot;&amp;quot;) {
				filter += &amp;quot; and (A.jsfs=&amp;apos;&amp;quot;+param.jsfs+&amp;quot;&amp;apos;)&amp;quot;;
			}
			if (param.kmbh != &amp;quot;&amp;quot;) {
				_this.SetCellText(sheet_param,1,7,param.kmbh);
				cur_kmbh = param.kmbh;
			}
			if (param.dwbh != &amp;quot;&amp;quot;) {
				filter += &amp;quot; and (A.dwbh=&amp;apos;&amp;quot;+param.dwbh+&amp;quot;&amp;apos;)&amp;quot;;
			}
			if (param.zy != &amp;quot;&amp;quot;) {
				filter += &amp;quot; and (A.zy like &amp;apos;%25&amp;quot;+param.zy+&amp;quot;%25&amp;apos;)&amp;quot;;
			}
			if (param.mny1 != &amp;quot;&amp;quot;) {
				filter += &amp;quot; and A.je&amp;gt;=&amp;quot;+param.mny1;
			}
			if (param.mny2 != &amp;quot;&amp;quot;) {
				filter += &amp;quot; and A.je&amp;lt;=&amp;quot;+param.mny2;
			}
			if (param.printbz != &amp;quot;&amp;quot;) {
				filter += &amp;quot; and A.dybz=&amp;apos;&amp;quot;+param.printbz+&amp;quot;&amp;apos;&amp;quot;;
			}
			if (param.djh != &amp;quot;&amp;quot;) {
				filter += &amp;quot; and A.djh like &amp;apos;%25&amp;quot;+param.djh+&amp;quot;%25&amp;apos;&amp;quot;;
			}
			if (param.pch != &amp;quot;&amp;quot;) {
				filter += &amp;quot; and A.CWPCH like &amp;apos;%25&amp;quot;+param.pch+&amp;quot;%25&amp;apos;&amp;quot;;
			}

			loadRjzData(cur_yyyy,cur_mm,cur_kmbh,filter);			
		}
	}
	catch(e) {}
}

//查找
var cur_search_param;    //当前查找条件
var cur_search_row = -1; //查找到的当前行
function btnSearch()
{
	var obj = new Object();
	obj.yyyy = cur_yyyy;
	obj.mm = cur_mm;
	obj.kmbh = cur_kmbh;	
	
	_sql.querytods(&amp;quot;getKmmc&amp;quot;,&amp;quot;SBH=&amp;quot;+cur_sbh+&amp;quot;&amp;ZTH=&amp;quot;+cur_zth+&amp;quot;&amp;KMBH=&amp;quot;+cur_kmbh);
	var kmmc = _this.XMLDS_GetString(0,&amp;quot;KMMC&amp;quot;);
	
	obj.kmmc = kmmc;
	var retVal = window.showModalDialog(&amp;quot;show.sp?grdid=RJZ_SEARCH&amp;quot;,obj,&amp;quot;dialogWidth=600px;dialogHeight=300px&amp;quot;);
	try {
		cur_search_row = -1;
		cur_search_param = retVal;
		doSearch(&amp;quot;down&amp;quot;);
	} catch (e) {
	
	}
	
}

//执行查找
function doSearch(searchFx)
{
	var sdat1 = cur_search_param.dat1;
	var sdat2 = cur_search_param.dat2;
	var skmbh = cur_search_param.kmbh;
	var skxlx = cur_search_param.kxlx;
	var sdwbh = cur_search_param.dwbh;
	var sdwlx = cur_search_param.dwlx;
	var szy   = cur_search_param.zy;
	var smny1 = cur_search_param.mny1;
	var smny2 = cur_search_param.mny2;
	var sdjh  = cur_search_param.djh;
	var spch  = cur_search_param.pch;
	var syy = 1*sdat1.split(&amp;quot;-&amp;quot;)[0];
	var smm = 1*sdat1.split(&amp;quot;-&amp;quot;)[1];
	var sdd1 = 1*sdat1.split(&amp;quot;-&amp;quot;)[2];
	var sdd2 = 1*sdat2.split(&amp;quot;-&amp;quot;)[2];
	
	if (syy != cur_yyyy || smm != cur_mm || skmbh != cur_kmbh) {
		alert(&amp;quot;未找到符合条件的日记帐！&amp;quot;);
		return false;
	} 
	
	if (smny1 != &amp;quot;&amp;quot; &amp;&amp; smny2 == &amp;quot;&amp;quot;) smny2 = &amp;quot;999999999999999999.99&amp;quot;;
	if (smny2 != &amp;quot;&amp;quot; &amp;&amp; smny1 == &amp;quot;&amp;quot;) smny1 = &amp;quot;0.00&amp;quot;;
	
	var row1 = _this.GetMainCellRangeRow1(sheet_rjz1)-1;
	var row2 = _this.GetMainCellRangeRow2(sheet_rjz1)+1;
	
	var bFind = false;
	if (searchFx == &amp;quot;down&amp;quot;) {
		if (cur_search_row != -1) row1 = cur_search_row;
		for (var row=row1+1; row&amp;lt;=row2;row++) {
			bFind = doSearchRowValue(sheet_rjz1,row,sdd1,sdd2,spch,szy,sdjh,sdwbh,sdwlx,smny1,smny2,skxlx);
			if (bFind == true) break;
		}
	}
	else if (searchFx == &amp;quot;up&amp;quot;) {
		for (var row=cur_search_row-1; row&amp;gt;=1;row--) {
			bFind = doSearchRowValue(sheet_rjz1,row,sdd1,sdd2,spch,szy,sdjh,sdwbh,sdwlx,smny1,smny2,skxlx);
			if (bFind == true) break;
		}
	}

	//如果查找到，滚动到记录行
	if (bFind) {
		//alert(&amp;quot;找到记录行&amp;quot;+cur_search_row);
		ScrollToFindRow(sheet_rjz1,cur_search_row);
		_thisOnMouseLClick(sheet_rjz1,cur_search_row,3);
	}
	else {
		alert(&amp;quot;未找到符合条件的日记帐！&amp;quot;);
	}
}

//查找记录行
function doSearchRowValue(sheet_rjz1,row,sdd1,sdd2,spch,szy,sdjh,sdwbh,sdwlx,smny1,smny2,skxlx)
{
	var dd = _this.GetCellText(sheet_rjz1,row,1);
	if (dd &amp;gt;= sdd1 &amp;&amp; dd &amp;lt;= sdd2) { //查找日期
		var pch = _this.GetCellText(sheet_rjz1,row,2); //批次号
		var zy = _this.GetCellText(sheet_rjz1,row,3); //摘要
		var mny = _this.GetCellText(sheet_rjz1,row,4); //金额
		var djh = _this.GetCellText(sheet_rjz1,row,5); //单据号
		var dwbh = _this.GetCellText(sheet_rjz1,row,7); //主体编号
		var dwlx = _this.GetCellText(sheet_rjz1,row,11); //主体类型
		var kxlx = _this.GetCellText(sheet_rjz1,row,10); //主体类型
		
		if (spch  != &amp;quot;&amp;quot;) { if (spch == pch) { cur_search_row = row; return true; } else return false; }
		if (szy   != &amp;quot;&amp;quot;) { if (zy.indexOf(szy) != -1) { cur_search_row = row; return true; } else return false; }
		if (sdjh  != &amp;quot;&amp;quot;) { if (sdjh == djh) { cur_search_row = row; return true; } else return false; }
		if (sdwbh != &amp;quot;&amp;quot;) { if (sdwbh == dwbh) { cur_search_row = row; return true; } else return false; }
		if (sdwlx != &amp;quot;&amp;quot;) { if (sdwlx == dwlx) { cur_search_row = row; return true; } else return false; }
		if (skxlx != &amp;quot;&amp;quot;) { if (kxlx.indexOf(skxlx) != -1) { cur_search_row = row; return true; } else return false; }
		if (smny1 != &amp;quot;&amp;quot; || smny2 != &amp;quot;&amp;quot;) { 
			if (1.0*smny1 &amp;lt;= 1.0*mny &amp;&amp; 1.0*smny2 &amp;gt;= 1.0*mny) { 
				cur_search_row = row; 
				return true; 
			}
			else {
				return false;
			} 
		}
		
		cur_search_row = row; 
		return true;
	}
	
	return false;


}

//滚动到行
function ScrollToFindRow(sheet,scroll_row)
{
	var scroll_height = -30;
	for (var r=0;r&amp;lt;scroll_row;r++) {
		if (r == scroll_row) break;
		scroll_height += _this.GetRowHeight(sheet,r);
	}
	_this.ScrollToPos(sheet,scroll_height,0);
	_this.SetCellFocus(sheet,scroll_row,3);
}

//查找上一个
function btnSearchPrev()
{
	try { doSearch(&amp;quot;up&amp;quot;); } catch (e) { }
}

//查找下一个
function btnSearchNext()
{
	try { doSearch(&amp;quot;down&amp;quot;); } catch (e) { }
}

//生成凭证
function btnScpz(){
	var lsh = &amp;quot;&amp;quot;;
	var paramObj = new Object();	
	//检查是否已经结账
	var param = new Object();
	param.yy = cur_yyyy;
	param.mm = 1*cur_mm;
	param.sbh = cur_sbh;
	param.zth = cur_zth;
	var jz_retVal = invokeOSFuncExt(&amp;quot;check_jz&amp;quot;,param);
	var jz_ret = jz_retVal.split(&amp;quot;@&amp;quot;)[0];
	var jz_msg = jz_retVal.split(&amp;quot;@&amp;quot;)[1];
	if(jz_ret != 1 ){
		alert(jz_msg);
		return false;
	}
	
	//清楚空行记录
	for(var i = 1;i&amp;lt;= _this.GetRowCount(sheet_rjz2)-1;i++){
		lsh = _this.GetCellText(sheet_rjz2,i,6);
		zy  = _this.GetCellText(sheet_rjz2,i,3);
		if(lsh == &amp;quot;&amp;quot; &amp;&amp; zy == &amp;quot;&amp;quot;) {
			_this.DeleteRow(sheet_rjz2,i);
			i --;
		}
	}

	if(_this.GetRowCount(sheet_rjz2) &amp;lt;= 2){
		return false;
	}
	
	var mesStr = &amp;quot;请选择%20%20(1)[是]-直接保存凭证%20%20(2)[否]-查看凭证%20%20(3)[取消]-取消操作&amp;quot;;
	var retVal = window.showModalDialog(&amp;quot;show.sp?grdid=MESSAGEBOX&amp;mesStr=&amp;quot;+mesStr,null,&amp;quot;dialogWidth=450px;dialogHeight=300px&amp;quot;);
	if(retVal == -1 || retVal == &amp;quot;undefined&amp;quot; || retVal == undefined){
		return false;
	}
//	alert(retVal);
//	retVal = &amp;quot;1&amp;quot;;
	
	var xml = _this.GetXml(sheet_rjz2,_this.GetMainCellRangeRow1(sheet_rjz2),_this.GetMainCellRangeCol1(sheet_rjz2),_this.GetMainCellRangeRow2(sheet_rjz2),_this.GetMainCellRangeCol2(sheet_rjz2));
	paramObj.rjzmxXml  = xml ;
	paramObj.sbh = G_ORGID;
	paramObj.zth = G_ACCID.replace(G_ORGID,&amp;quot;&amp;quot;);
	paramObj.thisorgid = G_ORGID;
	paramObj.thisaccid = G_ACCID;
	paramObj.czyxm = G_USRNAM;
//	paramObj.rq    = G_LOGDAT;
	paramObj.cur_yy = cur_yyyy;
	paramObj.cur_mm = cur_mm;
	paramObj.dd_Load = G_LOGDAT.substring(8,10)*1;
//	alert( G_LOGDAT.substring(8,10)*1);
	paramObj.kmbh  = cur_kmbh;	
	paramObj.retPzVal = retVal;
	
	var retVal = invokeOSFuncExt(&amp;quot;save_jk_pzb&amp;quot;,paramObj );
	var ret = retVal.split(&amp;quot;@&amp;quot;)[0];
	var msg = retVal.split(&amp;quot;@&amp;quot;)[1];

	if (ret == 1) {
		alert(&amp;quot;保存成功！&amp;quot;+msg );
		loadRjzData(cur_yyyy,cur_mm,cur_kmbh,&amp;quot;&amp;quot;);
		resetTips();
		return false;
	}
	else if(ret == -1){
		alert(retVal );
		return false;
	}else {
		var jk_czxh = ret.split(&amp;quot;~&amp;quot;)[0];
		var pzguid = &amp;quot;&amp;quot;;
		var pzmx_xml = ret.split(&amp;quot;~&amp;quot;)[1];
		var pzmx_xmlarr = new Array();
		pzmx_xmlarr.push(pzmx_xml);
		var param = new Object();
		//param.pzmx_xml = pzmx_xml;
		param.pzmx_xml = pzmx_xmlarr; //增加处理查看多张凭证的情况
		param.jk_czxh  = jk_czxh;
		param.jspz = 0;
		var retMsg = window.showModalDialog(&amp;quot;show.sp?grdid=PZGL_PZZDXG&amp;guid=&amp;quot;+pzguid+&amp;quot;&amp;accid=&amp;quot;+G_ACCID,param,&amp;quot;dialogWidth=1200px;dialogHeight=600px&amp;quot;);
		if(retMsg == 1){
			loadRjzData(cur_yyyy,cur_mm,cur_kmbh,&amp;quot;&amp;quot;);
			resetTips();
		}
	}

}

//初始化借贷方金额提示信息
function resetTips()
{
	sum_jfje = 0.00;//借方金额
	sum_dfje = 0.00;//贷方金额
	jefx = &amp;quot;&amp;quot;;//金额方向
	zbs = 0;//总笔数
	_this.SetCellText(sheet_param,1,11,&amp;quot;&amp;quot;);
	_this.SetCellText(sheet_param,1,13,&amp;quot;&amp;quot;);
	_this.SetCellText(sheet_param,1,15,&amp;quot;&amp;quot;);
	_this.SetCellText(sheet_param,1,17,&amp;quot;&amp;quot;);
	
}

//检查金额
function btnChkJE()
{
	if (!confirm(&amp;quot;检查日记帐金额，是否继续？&amp;quot;)) return;
	var rjz2xml = getRjz2Xml();
	if (rjz2xml == &amp;quot;&amp;quot;) {
		alert(&amp;quot;无数据可检查！&amp;quot;);
		return;
	}
	
	var param = new Object();
	param.rjz2xml = rjz2xml;
	param.yy = cur_yyyy;
	param.mm = cur_mm;
	param.kmbh = cur_kmbh;
	param.thisorgid = G_ORGID;
	param.thisaccid = G_ACCID;
	
	var ret = invokeOSFuncExt(&amp;quot;CheckMny&amp;quot;,param);
	alert(ret);
	
}


//
function getRjz2Xml()
{
	var cnt = 0;
	for (var r=_this.GetMainCellRangeRow1(sheet_rjz2);r&amp;lt;=_this.GetMainCellRangeRow2(sheet_rjz2);r++) {
		if (_this.GetCellText(sheet_rjz2,r,1) != &amp;quot;&amp;quot;) cnt ++;
	}
	if (cnt == 0) {
		return &amp;quot;&amp;quot;;
	}
	var xml = _this.GetXml(sheet_rjz2,1,0,_this.GetMainCellRangeRow2(sheet_rjz2),_this.GetMainCellRangeCol2(sheet_rjz2));
	return xml;
}


//计算合计金额
function jsSumJE(sheet_yhrjzb)
{
	var jfje_sum = 0.00;
	var dfje_sum = 0.00;
	var ye_sum   = 0.00;
	var jfbs     = 0;
	var dfbs     = 0;
	for(var i =_this.GetMainCellRangeRow1(sheet_yhrjzb);i&amp;lt;=_this.GetMainCellRangeRow2(sheet_yhrjzb);i++){
		var jefx = _this.GetCellText(sheet_yhrjzb,i,5); //使用金额方向计算
		var jfje = 0;
		var dfje = 0;
		if (jefx == &amp;quot;借&amp;quot;) jfje = _this.GetCellText(sheet_yhrjzb,i,4)*1.00;
		if (jefx == &amp;quot;贷&amp;quot;) dfje = _this.GetCellText(sheet_yhrjzb,i,4)*1.00;
		
		var ye   = 0;
		var qcbz = 0;
		var sblsh = _this.GetCellText(sheet_yhrjzb,i,6);
		
		if(ye == &amp;quot;&amp;quot;) ye = 0.00;
		if(jfje == &amp;quot;&amp;quot;) jfje = 0.00;
		if(dfje == &amp;quot;&amp;quot;) dfje = 0.00;
		
		if(sblsh != &amp;quot;&amp;quot;){
			if(qcbz == 1) {
				ye_sum = 1.0* round(ye,2);
			}else{
				if(jefx == &amp;quot;借&amp;quot;){
					jfbs ++;
					jfje_sum = 1.00 * round(jfje_sum,2) + 1.00 * round(jfje,2);
					ye_sum = 1.00 * round(ye_sum,2) + 1.00 * round(jfje,2);
					//_this.SetCellText(sheet_yhrjzb,i,10,ye_sum);
				}else if(jefx == &amp;quot;贷&amp;quot;){
					dfbs ++;
					dfje_sum = 1.00 * round(dfje_sum,2) + 1.00 * round(dfje,2);
					ye_sum = 1.00 * round(ye_sum,2) - 1.00 * round(dfje,2);
					//_this.SetCellText(sheet_yhrjzb,i,10,ye_sum);
				}
			}
		}

	}
	
	var retje_sum = jfje_sum - dfje_sum;
	var retjefx = &amp;quot;&amp;quot;;
	if (retje_sum &amp;gt; 0) {
		retjefx = &amp;quot;借&amp;quot;;
	}
	else {
		retjefx = &amp;quot;贷&amp;quot;;
		retje_sum = Math.abs(retje_sum);
	}
	
	//_this.SetCellText(sheet_param,1,10,&amp;quot;借：&amp;quot;+jfbs+&amp;quot;笔；   贷：&amp;quot;+dfbs+&amp;quot;笔；&amp;quot;);
	if (sheet_yhrjzb != sheet_rjzmx1 &amp;&amp; sheet_yhrjzb != sheet_rjzmx2) {
		_this.SetCellText(sheet_yhrjzb,_this.GetRowCount(sheet_yhrjzb)-1,4,retje_sum);
	}
	_this.SetCellText(sheet_yhrjzb,_this.GetRowCount(sheet_yhrjzb)-1,5,retjefx);
}

//设置一行颜色
function setOneRowCellColor(sheet,row,r,g,b)
{
	for (var c=0;c&amp;lt;_this.GetColCount(sheet);c++) {
		_this.SetCellColor(sheet,row,c,r,g,b);
	}
}

//按F3
function _thisOnF3KeyDown(sheet,row,col)
{

}
</GRDJSDS_VALUE></ROW>
</ROWSET>
</grdjsds><grdosds>
<ROWSET>
<ROW num="0" ><GRDOSDS_VALUE >//检查结账
function check_jz(){
	var Pub = new SBCW_CW_PUBLIC();
	var retVal = Pub.Pub_check_jz(sbh,zth,yy,mm);
	return retVal;
}

//日记账凭证生成
function save_jk_pzb(){
	var db = null;
	var sql = &amp;quot;&amp;quot;;
	var dbQsql = &amp;quot;&amp;quot;;
	
	var jk_czxh = &amp;quot;&amp;quot;;
	var jk_rjzXml = &amp;quot;&amp;quot;;
	
	var sblsh = &amp;quot;&amp;quot;;	//社保流水号
	var dylsh = &amp;quot;&amp;quot;;
	var djh = &amp;quot;&amp;quot;;
	var old_djh = &amp;quot;0&amp;quot;;
	var count = 0;//记录附件张数
	var dbQcount = 0;
	var yy = cur_yy;
	var mm = cur_mm;
	var dd = dd_Load;
	var sum_ce = 0;
	var jfje = 0;
	var dfje = 0;
	var jefx = &amp;quot;&amp;quot;;
	var dbq_kmbh=&amp;quot;&amp;quot;;
	try{
		db = new pub.EADatabase();
		
		sql = &amp;quot;SELECT SEQ_JKCZXH.NEXTVAL FROM dual&amp;quot;;
		jk_czxh = db.GetSQL(sql);
		
		sql = &amp;quot;select sys_guid() from dual&amp;quot;;
		var pzguid = db.GetSQL(sql);
		
		jk_rjzXml = new pub.EAXmlDS(rjzmxXml);	
		
		for(var i = 0;i &amp;lt; jk_rjzXml.getRowCount();i++) {
			sblsh = jk_rjzXml.getStringAt(i,&amp;quot;COL6&amp;quot;);
			djh   = jk_rjzXml.getStringAt(i,&amp;quot;COL7&amp;quot;);
			dylsh = jk_rjzXml.getStringAt(i,&amp;quot;COL8&amp;quot;);
			
			sql = &amp;quot;select nvl(sum( decode(jefx,&amp;apos;借&amp;apos;,je,-je) ),0) sumje from cw_rjzb where sbh = &amp;apos;&amp;quot; + sbh + &amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+ zth +&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;&amp;quot;;
			var sumje = 1.0 * db.GetSQL(sql);
			
			//sql = &amp;quot;select count(1) from cw_rjzmxb where sbh = &amp;apos;&amp;quot; + sbh + &amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+ zth +&amp;quot;&amp;apos; and lsh in (select lsh from cw_rjzb where siseqno = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;)&amp;quot;;
			//var mxcou = db.GetSQL(sql);
//			sql = &amp;quot;select count(1) cnt,sum(decode(jefx,&amp;apos;借&amp;apos;,je,decode(sign(0-je),1,-je,je))) summxje from cw_rjzmxb where sbh = &amp;apos;&amp;quot; + sbh + &amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+ zth 
//				+&amp;quot;&amp;apos; and lsh in (select lsh from cw_rjzb where sbh = &amp;apos;&amp;quot; + sbh + &amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+ zth +&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;)&amp;quot;;
//			var tmpds = db.QuerySQL(sql);

			//20161227 lyh modify 金额有借有贷，有正有负 不需要判断金额相减
			sql = &amp;quot;select count(1) cnt,sum( decode(jefx,&amp;apos;借&amp;apos;,je,-je) ) summxje from cw_rjzmxb where sbh = &amp;apos;&amp;quot; + sbh + &amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+ zth 
				+&amp;quot;&amp;apos; and lsh in (select lsh from cw_rjzb where sbh = &amp;apos;&amp;quot; + sbh + &amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+ zth +&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;)&amp;quot;;
			var tmpds = db.QuerySQL(sql);
			var mxcou = 1 * tmpds.getStringAt(0,&amp;quot;CNT&amp;quot;);
			var summxje = 1.0 * tmpds.getStringAt(0,&amp;quot;SUMMXJE&amp;quot;); //cw_rjzmxb合计金额
			if(mxcou &amp;lt;= 0) {
				db.Rollback();
				//throw new Exception(&amp;quot;第&amp;quot;+ (i+1) +&amp;quot;行出错，无日记账明细，不允许生成凭证，流水号：&amp;quot;+sblsh );
				return &amp;quot;-1&amp;quot;+&amp;quot;@&amp;quot;+&amp;quot;生成凭证出错：&amp;quot;+&amp;quot;第&amp;quot;+ (i+1) +&amp;quot;行出错，无日记账明细，不允许生成凭证，流水号：&amp;quot;+sblsh;
				return false;
			}
			
			//判断cw_rjzb和cw_rjzmxb金额是否相等
			if (sumje != summxje) {
				db.Rollback();
				//throw new Exception(&amp;quot;第&amp;quot;+ (i+1) +&amp;quot;行出错，日记账合计金额不相等，不允许生成凭证，流水号：&amp;quot;+sblsh );
				return &amp;quot;-1&amp;quot;+&amp;quot;@&amp;quot;+&amp;quot;生成凭证出错：&amp;quot;+&amp;quot;第&amp;quot;+ (i+1) +&amp;quot;行出错，日记账合计金额(&amp;quot;+sumje+&amp;quot;)与明细金额(&amp;quot;+summxje+&amp;quot;)不相等，不允许生成凭证，流水号：&amp;quot;+sblsh; 
				return false;
			}
						
			//插入cw_jk_rjzb
			sql = &amp;quot;insert into cw_jk_rjzb(sbh,zth,lsh,yy,mm,dd,sxh,czyxm,zy,kmbh,lxbh,djh,dwbh,je,jefx,jsfs,yefx,qcbz,fkbz,dwmc,dybz,czysj,org,acc,czxh,old_pch,dylsh,siseqno)
				select sbh,zth,lsh,yy,mm,dd,sxh,czyxm,zy,kmbh,lxbh,djh,dwbh,je,jefx,jsfs,yefx,qcbz,fkbz,dwmc,dybz,czysj,org,acc ,&amp;apos;&amp;quot;+jk_czxh +&amp;quot;&amp;apos;,old_pch,dylsh,siseqno
				  from cw_rjzb where sbh = &amp;apos;&amp;quot; + sbh + &amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+ zth +&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;&amp;quot;;  				  
			db.ExcecutSQL(sql);
			if(djh != old_djh) count ++;			
			old_djh = djh;
		}

		//插入接口cw_jk_pzb
		sql = &amp;quot;insert into cw_jk_pzb(sbh,zth,yy,mm,dd,pzlx,pzh,zt,zdrxm,fjzs,cwbz,chbz,jsbz,zdrsj,org,acc,ID,guid)
		 	values(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;quot;+yy+&amp;quot;,&amp;quot;+mm+&amp;quot;,&amp;quot;+dd+&amp;quot;,&amp;apos;记&amp;apos;,&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;,&amp;apos;未核&amp;apos;,&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+count+&amp;quot;&amp;apos;,0,0,0,sysdate,&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+pzguid +&amp;quot;&amp;apos;)&amp;quot;;
		db.ExcecutSQL(sql);
		
		//获取摘要收支前缀
		sql = &amp;quot;SELECT decode( substrb(&amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos;,1,3),&amp;apos;102&amp;apos;,&amp;apos;收&amp;apos;,&amp;apos;支&amp;apos;)||cw_pack4.kmmc(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos;) || decode( substrb(&amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos;,1,3),&amp;apos;102&amp;apos;,&amp;apos;保险费&amp;apos;,&amp;apos;保险金&amp;apos;) FROM dual&amp;quot;;
	 	var zy = db.GetSQL(sql);
		
		//获取借贷放总金额
		sql = &amp;quot;SELECT nvl(sum(decode(b.jefx,&amp;apos;贷&amp;apos;,b.je,0)),0) jfje, nvl(sum(decode(b.jefx,&amp;apos;贷&amp;apos;,0,b.je)),0) dfje
  			 FROM CW_JK_RJZB A, CW_RJZMXB B, SI_DWB C
			 WHERE A.SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and a.zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and a.czxh =&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos; AND A.SBH = B.SBH
			   AND A.ZTH = B.ZTH AND A.LSH = B.LSH AND A.SBH = C.SBH(+) AND A.ZTH = C.ZTH(+) AND A.DWBH = C.DWBH(+)&amp;quot;;
		var jeds = db.QuerySQL(sql);
		var jfje = jeds.getStringAt(0,&amp;quot;jfje&amp;quot;);
		var dfje = jeds.getStringAt(0,&amp;quot;dfje&amp;quot;);
		var mxxh = 0;
		//计算差额
		if( jfje &amp;gt; dfje ){
			mxxh ++;
	 		sum_ce = 1.0*jfje - 1.0*dfje;
	 		jefx = &amp;quot;贷&amp;quot;;
	 		//汇总银行金额借贷方差额
			sql = &amp;quot;insert into cw_jk_pzmxb(sbh,zth,yy,mm,dd,pzlx,pzh,mxxh,zt,zy,kmbh,je,jefx,chbz,jsbz,org,acc,id,formguid,SEQID)
		 		values(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;quot;+yy+&amp;quot;,&amp;quot;+mm+&amp;quot;,&amp;quot;+dd+&amp;quot;,&amp;apos;记&amp;apos;,&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;,&amp;apos;1&amp;apos;,&amp;apos;未核&amp;apos;,&amp;apos;&amp;quot;+zy+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sum_ce+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;,0,0,&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+pzguid +&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+mxxh+&amp;quot;&amp;apos;)&amp;quot;;
			db.ExcecutSQL(sql);
	 	}else if(jfje &amp;lt; dfje){
	 		mxxh ++;
	 		sum_ce = 1.0*dfje - 1.0*jfje;
	 		jefx = &amp;quot;借&amp;quot;;
	 		//汇总银行金额借贷方差额
			sql = &amp;quot;insert into cw_jk_pzmxb(sbh,zth,yy,mm,dd,pzlx,pzh,mxxh,zt,zy,kmbh,je,jefx,chbz,jsbz,org,acc,id,formguid,SEQID)
			 	values(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;quot;+yy+&amp;quot;,&amp;quot;+mm+&amp;quot;,&amp;quot;+dd+&amp;quot;,&amp;apos;记&amp;apos;,&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;,&amp;apos;1&amp;apos;,&amp;apos;未核&amp;apos;,&amp;apos;&amp;quot;+zy+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sum_ce+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;,0,0,&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+pzguid +&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+mxxh+&amp;quot;&amp;apos;)&amp;quot;;
			db.ExcecutSQL(sql);
	 	}
		
		//插入cw_jk_pzmxb
		//两银行转账的数据，不需要转换金额方向	
		dbQsql = &amp;quot;SELECT A.SBH sbh,A.ZTH zth,A.YY yy,A.MM mm,&amp;quot;+dd+&amp;quot; dd,&amp;apos;记&amp;apos; pzlx,&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos; pzh,&amp;apos;未核&amp;apos; zt,MAX(a.ZY) zy,MAX(NVL(DECODE(A.DYLSH, NULL, NULL, A.KMBH), B.KMBH)) KMBH,sum(nvl(b.je,0)) je,
				DECODE(A.DYLSH, NULL, DECODE(B.JEFX, &amp;apos;借&amp;apos;, &amp;apos;贷&amp;apos;, &amp;apos;借&amp;apos;), B.JEFX) JEFX,&amp;apos;0&amp;apos; chbz,&amp;apos;0&amp;apos; jsbz, B.LXBH,B.LXXH,NVL(C.DWLXBH, 0) DWLXBH,a.dylsh DYLSH
			  FROM CW_jk_rjzb A, CW_RJZMXB B, SI_DWB C
			 WHERE A.SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and a.zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and a.czxh =&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos; AND A.SBH = B.SBH
			   AND A.ZTH = B.ZTH AND A.LSH = B.LSH AND A.SBH = C.SBH(+) AND A.ZTH = C.ZTH(+) AND A.DWBH = C.DWBH(+)
			 GROUP BY A.SBH,A.ZTH,A.YY,A.MM,DECODE(A.DYLSH, NULL, NULL, A.KMBH),DECODE(A.DYLSH, NULL, DECODE(B.JEFX, &amp;apos;借&amp;apos;, &amp;apos;贷&amp;apos;, &amp;apos;借&amp;apos;), B.JEFX),B.LXBH,B.LXXH,NVL(C.DWLXBH, 0),a.dylsh
			 order by b.lxbh,b.lxxh&amp;quot;;
			 
		var ds = db.QuerySQL(dbQsql);	
		for(var db_r = 0;db_r &amp;lt;ds.getRowCount();db_r++){	
			dbq_kmbh = &amp;quot;&amp;quot;;
			var chbz = 0;
			mxxh++;
			try{dbq_kmbh = ds.getStringAt(db_r,&amp;quot;kmbh&amp;quot;);}catch(e){}
			var dbq_je   = 1.0*ds.getStringAt(db_r,&amp;quot;je&amp;quot;);
			var dbq_jefx = ds.getStringAt(db_r,&amp;quot;jefx&amp;quot;);
			var dbq_lxbh = ds.getStringAt(db_r,&amp;quot;lxbh&amp;quot;);
			var dbq_lxxh = ds.getStringAt(db_r,&amp;quot;lxxh&amp;quot;);
			var dbq_dwlxbh = ds.getStringAt(db_r,&amp;quot;dwlxbh&amp;quot;);
			var dbq_zy = ds.getStringAt(db_r,&amp;quot;zy&amp;quot;);	
			var dbq_dylsh = ds.getStringAt(db_r,&amp;quot;dylsh&amp;quot;);

			if(dbq_kmbh == &amp;quot;&amp;quot;){
				 dbq_kmbh = getKmbh(sbh,zth,dbq_dwlxbh,dbq_lxbh,dbq_lxxh,db);
			}
			
			if(dbq_je &amp;lt; 0) chbz = 1;
						
			sql = &amp;quot;insert into cw_jk_pzmxb(sbh,zth,yy,mm,dd,pzlx,pzh,mxxh,zt,zy,kmbh,je,jefx,chbz,jsbz,org,acc,id,formguid,SEQID)
		 		values(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;quot;+yy+&amp;quot;,&amp;quot;+mm+&amp;quot;,&amp;quot;+dd+&amp;quot;,&amp;apos;记&amp;apos;,&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+mxxh+&amp;quot;&amp;apos;,&amp;apos;未核&amp;apos;,&amp;apos;&amp;quot;+dbq_zy+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dbq_kmbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dbq_je+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dbq_jefx+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+chbz+&amp;quot;&amp;apos;,0,&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+pzguid +&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+mxxh+&amp;quot;&amp;apos;)&amp;quot;;
		 	db.ExcecutSQL(sql);		 	 		 		 	
		}
		
		//检查借贷方金额是否平衡
		sql = &amp;quot;SELECT COUNT(1) FROM CW_JK_PZMXB WHERE SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND YY = &amp;quot;+yy+&amp;quot; AND MM = &amp;quot;+mm+&amp;quot; AND id = &amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos; 
				HAVING SUM(DECODE(JEFX, &amp;apos;借&amp;apos;, JE, 0)) = SUM(DECODE(JEFX, &amp;apos;贷&amp;apos;, 0, JE))&amp;quot;;
		var jcds = 1*db.GetSQL(sql);
		if(jcds == 0){
			db.Rollback();
			return &amp;quot;-1&amp;quot;+&amp;quot;@&amp;quot;+&amp;quot;生成凭证出错，借贷方金额不平衡，不允许生成凭证!!!&amp;quot;+sql;
		}
	 	
		if(retPzVal == 1){
			//保存cw_pzb cw_pzmxb 更新 cw_rjzb
			var Dateret = savePzb(sbh,zth,yy,mm,jk_czxh,db,kmbh);
			var ret = Dateret.split(&amp;quot;@&amp;quot;)[0];
			var msg = Dateret.split(&amp;quot;@&amp;quot;)[1];
			if(ret == 1){
				db.Commit();
				return &amp;quot;1&amp;quot;+&amp;quot;@&amp;quot;+&amp;quot;1.生成凭证成功，凭证号为:&amp;quot;+msg ;
			}else{
				db.Rollback();
				return &amp;quot;-1&amp;quot;+&amp;quot;@&amp;quot;+&amp;quot;1.生成凭证出错：&amp;quot;+msg;
			}
		}else{
			var xml = &amp;quot;&amp;quot;;
			//凭证预览功能  构造XML
//			sql = &amp;quot;SELECT a.DD,a.PZLX,a.MXXH,a.ZT,a.ZY,a.KMBH,a.JE,a.JEFX, b.FJZS FROM CW_JK_PZMXB a,cw_jk_pzb b 
//				WHERE a.SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND a.ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND a.YY = &amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; AND a.MM = &amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos; AND a.PZH = &amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;
//				  and a.sbh = b.sbh and a.zth = b.zth and a.yy = b.yy and a.mm = b.mm and a.pzh = b.pzh
//				 order by mxxh&amp;quot;;
			//相同科目的进行合并
			sql = &amp;quot;select dd,pzlx,zt,rownum mxxh,zy,kmbh,je,jefx,fjzs 
				from (
				SELECT a.DD,a.PZLX,max(a.mxxh) mxxh,a.ZT,max(a.ZY) zy,a.KMBH,sum(a.JE) je,a.JEFX,sum(b.FJZS) fjzs 
				FROM CW_JK_PZMXB a,cw_jk_pzb b 
				WHERE a.SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND a.ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND a.YY = &amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; AND a.MM = &amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos; AND a.PZH = &amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;
				  and a.sbh = b.sbh and a.zth = b.zth and a.yy = b.yy and a.mm = b.mm and a.pzh = b.pzh
				group by a.DD,a.PZLX,a.ZT,a.KMBH,a.JEFX
				order by mxxh
				)&amp;quot;;
			var xmlds = db.QuerySQL(sql);
			if(xmlds.getRowCount()&amp;lt;= 0){
				db.Rollback();
				return -1+&amp;quot;@&amp;quot;+&amp;quot;查询接口凭证mx表出错&amp;quot;+sql ;
			}else{
				var row = 0;
				xml = &amp;quot;&amp;lt;?xml version = &amp;apos;1.0&amp;apos;?&amp;gt;&amp;lt;ROWSET&amp;gt;&amp;quot;;
				for(var i =0;i&amp;lt;xmlds.getRowCount();i++){
					var dd   = xmlds.getStringAt(i,&amp;quot;DD&amp;quot;);
					var pzlx = &amp;quot;记&amp;quot;;
					var mxxh = xmlds.getStringAt(i,&amp;quot;MXXH&amp;quot;);
					var zt   = xmlds.getStringAt(i,&amp;quot;ZT&amp;quot;);
					var zy   = xmlds.getStringAt(i,&amp;quot;ZY&amp;quot;);
					var kmbh = xmlds.getStringAt(i,&amp;quot;KMBH&amp;quot;);
					
					var je1   = 1.0*xmlds.getStringAt(i,&amp;quot;JE&amp;quot;);					
					var kxjsf_sql = &amp;quot;select trim(to_char(round(&amp;quot;+je1+&amp;quot;,2))) je from dual&amp;quot;;//转换金额，避免科学计算法
					var je = db.GetSQL(kxjsf_sql);
					
					var jefx = xmlds.getStringAt(i,&amp;quot;JEFX&amp;quot;);
					var fjzs = xmlds.getStringAt(i,&amp;quot;FJZS&amp;quot;);
					row ++;
					var rowStr = &amp;quot;&amp;lt;ROW num=&amp;apos;&amp;quot;+row+&amp;quot;&amp;apos; SELECTFLAG=&amp;apos;0&amp;apos; name=&amp;apos;&amp;apos;&amp;gt;
								&amp;lt;SBH&amp;gt;&amp;quot;+sbh+&amp;quot;&amp;lt;/SBH&amp;gt;
								&amp;lt;ZTH&amp;gt;&amp;quot;+zth+&amp;quot;&amp;lt;/ZTH&amp;gt;
								&amp;lt;YY&amp;gt;&amp;quot;+yy+&amp;quot;&amp;lt;/YY&amp;gt;
								&amp;lt;MM&amp;gt;&amp;quot;+mm+&amp;quot;&amp;lt;/MM&amp;gt;
								&amp;lt;DD&amp;gt;&amp;quot;+dd+&amp;quot;&amp;lt;/DD&amp;gt;
								&amp;lt;PZLX&amp;gt;&amp;quot;+pzlx+&amp;quot;&amp;lt;/PZLX&amp;gt;
								&amp;lt;MXXH&amp;gt;&amp;quot;+mxxh+&amp;quot;&amp;lt;/MXXH&amp;gt;
								&amp;lt;ZT&amp;gt;&amp;quot;+zt+&amp;quot;&amp;lt;/ZT&amp;gt;
								&amp;lt;ZY&amp;gt;&amp;quot;+zy+&amp;quot;&amp;lt;/ZY&amp;gt;
								&amp;lt;KMBH&amp;gt;&amp;quot;+kmbh+&amp;quot;&amp;lt;/KMBH&amp;gt;
								&amp;lt;JE&amp;gt;&amp;quot;+je+&amp;quot;&amp;lt;/JE&amp;gt;
								&amp;lt;JEFX&amp;gt;&amp;quot;+jefx+&amp;quot;&amp;lt;/JEFX&amp;gt;
								&amp;lt;FJZS&amp;gt;&amp;quot;+fjzs+&amp;quot;&amp;lt;/FJZS&amp;gt;
								&amp;lt;ORGID&amp;gt;&amp;quot;+thisorgid+&amp;quot;&amp;lt;/ORGID&amp;gt;
								&amp;lt;ACCID&amp;gt;&amp;quot;+thisaccid+&amp;quot;&amp;lt;/ACCID&amp;gt;
				       			&amp;lt;/ROW&amp;gt;&amp;quot;;
				       	xml += 	rowStr;
				}
			}
			xml+= &amp;quot;&amp;lt;/ROW&amp;gt;&amp;lt;/ROWSET&amp;gt;&amp;quot;;
			db.Commit();		
			return jk_czxh+&amp;quot;~&amp;quot;+ xml + &amp;quot;@&amp;quot;+&amp;quot;生成接口凭证数据成功!&amp;quot;;
//			return jk_czxh+&amp;quot;@&amp;quot;+&amp;quot;生成接口凭证数据成功!&amp;quot;;
		}		
	}catch(e) {
		if (db != null) db.Rollback();
		return &amp;quot;-1&amp;quot;+&amp;quot;@&amp;quot;+&amp;quot;2.生成凭证出错：&amp;quot;+e.toString();
	}
	finally {
		if (db != null) db.Close();
	}
}

function getKmbh(sbh,zth,dwlxbh,lxbh,lxxh,db){
	var sql = &amp;quot;&amp;quot;;
	var kx_kmbh = &amp;quot;&amp;quot;;
	try{	
		var msg = &amp;quot;&amp;quot;;
		try{
			sql = &amp;quot;SELECT DISTINCT d.kmbh FROM cw_kxkmb d WHERE sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND lxbh = &amp;apos;&amp;quot;+lxbh+&amp;quot;&amp;apos; AND mxxh = &amp;apos;&amp;quot;+lxxh+&amp;quot;&amp;apos; AND dwlxbh = &amp;apos;&amp;quot;+dwlxbh+&amp;quot;&amp;apos;&amp;quot;;
			kx_kmbh = db.GetSQL(sql);
		}catch(e){
			try{
				sql = &amp;quot;SELECT DISTINCT d.kmbh FROM cw_kxkmb d WHERE sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND lxbh = &amp;apos;&amp;quot;+lxbh+&amp;quot;&amp;apos; AND mxxh = &amp;apos;&amp;quot;+lxxh+&amp;quot;&amp;apos; and dwlxbh = &amp;apos;0&amp;apos;&amp;quot;;
				kx_kmbh = db.GetSQL(sql);
			}catch(e){
				msg = &amp;quot;类型编号：&amp;quot;+lxbh+&amp;quot;;类型序号：&amp;quot;+lxxh+&amp;quot;查无数据，单位类型编号：&amp;quot;+dwlxbh+&amp;quot;，请到《日记款项设置》设置对应科目!!\n&amp;quot;+sql;
				throw new Exception(msg );
				return false;
			}
		}

		try{
			sql = &amp;quot;select mjbz from cw_kmb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND kmbh = &amp;apos;&amp;quot;+kx_kmbh+&amp;quot;&amp;apos;&amp;quot;;
			var ds = db.QuerySQL(sql);
			if(ds.getRowCount() &amp;lt;= 0){
				msg = &amp;quot;类型编号：&amp;quot;+lxbh+&amp;quot;;类型序号：&amp;quot;+lxxh+&amp;quot;;科目编号:&amp;quot;+kx_kmbh+&amp;quot;查寻无此科目，请到《日记款项设置》设置对应科目!!&amp;quot;;
				throw new Exception(msg);
				return false;
			}else{
				var mjbz = ds.getStringAt(0,&amp;quot;mjbz&amp;quot;);
				if (mjbz != 1){
					msg = &amp;quot;1类型编号：&amp;quot;+lxbh+&amp;quot;;类型序号：&amp;quot;+lxxh+&amp;quot;;科目编号:&amp;quot;+kx_kmbh+&amp;quot;不是末级科目，请到《日记款项设置》设置对应科目!!&amp;quot;;
					throw new Exception(msg);
					return false;
				}
			}
		}catch(e){
			throw new Exception(msg+sql);
			return false;
		}
		return kx_kmbh;
	}catch(e) {
		if (db != null) db.Rollback();
		throw new Exception(e.toString());
	}

}

//直接生成凭证
function savePzb(sbh,zth,yy,mm,jk_czxh,db,kmbh)
{
	var sql = &amp;quot;&amp;quot;;
	var pzh = &amp;quot;&amp;quot;;
	var pzh_str = 0;
	var fgf = &amp;quot;-&amp;quot;;
	var pzlx = &amp;quot;记&amp;quot;;
	try {
		//获取凭证号
		sql = &amp;quot;select nvl(max(pzh),0)+1 pzh from cw_pzb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND yy = &amp;quot;+yy+&amp;quot; and mm = &amp;quot;+mm;
		pzh = db.GetSQL(sql);				
		
		//插入cw_pzb 
//		var guid = db.GetSQL(&amp;quot;select sys_guid() from dual&amp;quot;);
		sql = &amp;quot;insert into cw_pzb(sbh,zth,yy,mm,dd,pzlx,pzh,zt,zdrxm,fjzs,cwbz,chbz,jsbz,zdrsj,org,acc,guid,czxh)
			select sbh,zth,yy,mm,dd,pzlx,&amp;quot;+pzh+&amp;quot;,zt,zdrxm,fjzs,cwbz,chbz,jsbz,zdrsj,org,acc,guid,&amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;
			   from cw_jk_pzb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND yy = &amp;quot;+yy+&amp;quot; and mm = &amp;quot;+mm+&amp;quot; and id = &amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;&amp;quot;;
		db.ExcecutSQL(sql);
		
		//插入cw_pzmxb
//		sql = &amp;quot;insert into cw_pzmxb(sbh,zth,yy,mm,dd,pzlx,pzh,mxxh,zt,zy,kmbh,je,jefx,chbz,jsbz,org,acc,formguid,seqid,guid)
//			select sbh,zth,yy,mm,dd,pzlx,&amp;quot;+pzh+&amp;quot;,mxxh,zt,zy,kmbh,je,jefx,chbz,jsbz,org,acc,formguid,seqid,guid
//			 from  cw_jk_pzmxb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND yy = &amp;quot;+yy+&amp;quot; and mm = &amp;quot;+mm+&amp;quot; and id = &amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;&amp;quot;;
		//相同科目的进行合并
		sql = &amp;quot;insert into cw_pzmxb(sbh,zth,yy,mm,dd,pzlx,pzh,mxxh,zt,zy,kmbh,je,jefx,chbz,jsbz,org,acc,formguid,seqid,guid)
			select sbh,zth,yy,mm,dd,pzlx,pzh,rownum mxxh,zt,zy,kmbh,je,jefx,chbz,jsbz,org,acc,formguid,rownum seqid,sys_guid() guid
			from (
			select sbh,zth,yy,mm,dd,pzlx,&amp;apos;&amp;quot;+pzh+&amp;quot;&amp;apos; pzh,min(mxxh) mxxh,zt,max(zy) zy,kmbh,sum(je) je,jefx,chbz,jsbz,org,acc,formguid
			from  cw_jk_pzmxb 
			where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND yy = &amp;quot;+yy+&amp;quot; and mm = &amp;quot;+mm+&amp;quot; and id = &amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;
			group by sbh,zth,yy,mm,dd,pzlx,zt,kmbh,jefx,chbz,jsbz,org,acc,formguid
			order by mxxh
			)&amp;quot;;	 
		
		db.ExcecutSQL(sql);
		
		//更新cw_rjzb
		sql = &amp;quot;select lsh,old_pch,djh,&amp;apos;&amp;apos; sxh,dylsh,kmbh,siseqno from cw_jk_rjzb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND yy = &amp;quot;+yy+&amp;quot; and mm = &amp;quot;+mm+&amp;quot; and czxh = &amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos; order by lsh&amp;quot;;
		var ds = db.QuerySQL(sql);
		var old_ywpch = &amp;quot;&amp;quot;;
		var old_djh   = &amp;quot;&amp;quot;;
		var old_lsh   = &amp;quot;&amp;quot;;
		for(var ds_r=0;ds_r&amp;lt; ds.getRowCount();ds_r ++){
			var ywpch = ds.getStringAt(ds_r,&amp;quot;old_pch&amp;quot;);
			var djh   = ds.getStringAt(ds_r,&amp;quot;djh&amp;quot;);
			var sblsh = ds.getStringAt(ds_r,&amp;quot;siseqno&amp;quot;);
			var lsh   = ds.getStringAt(ds_r,&amp;quot;lsh&amp;quot;);
			var dylsh = ds.getStringAt(ds_r,&amp;quot;dylsh&amp;quot;);
			if(lsh != old_lsh) {
			
				if(ywpch != &amp;quot;&amp;quot;){
					if(old_ywpch != ywpch) pzh_str ++;
				}else{
					if(djh != &amp;quot;&amp;quot;){
						if(old_djh != djh) pzh_str ++;
					}else{
						pzh_str ++;
					}
				}
				
				//更新cw_rjzb
				sql = &amp;quot;update cw_rjzb set pzlx = &amp;apos;&amp;quot;+pzlx+&amp;quot;&amp;apos;,pzh = &amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;,str_pzh = &amp;apos;&amp;quot;+fgf+pzh_str+&amp;quot;&amp;apos; where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND lsh in (&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dylsh+&amp;quot;&amp;apos;) and pzh is null&amp;quot;; 
				db.ExcecutSQL(sql);
			}
			old_ywpch = ywpch;
			old_djh   = djh;
			old_lsh   = lsh;
		}
		
		//更新cw_yhrjzb		
		sql = &amp;quot;update cw_yhrjzb set pzh = &amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos; where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and siseqno in (select siseqno from cw_jk_rjzb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; AND zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and czxh = &amp;apos;&amp;quot;+jk_czxh+&amp;quot;&amp;apos;)&amp;quot;;
		db.ExcecutSQL(sql);
		
		//调用财务函数cw_rjz_pack.rjz_pzh
//		try{
//		
//			var conn = db.GetConn();
//			var statement = conn.createStatement();
//			var stmt = conn.prepareCall(&amp;quot;call cw_rjz_pack.rjz_pzh(?,?,?,?,?,?,?)&amp;quot;);//cw_rjz_pack.rjz_pzh
//			stmt.setString(1,sbh);
//			stmt.setString(2,zth);
//			stmt.setString(3,yy);
//			stmt.setString(4,mm);
//			stmt.setString(5,kmbh);
//			stmt.setString(6,pzlx);
//			stmt.setString(7,pzh);
//						
//			stmt.executeUpdate();
//			
//			stmt.close();
//
//		}catch (e){
//			db.Rollback();
//			return -1+&amp;quot;@&amp;quot;+&amp;quot;调用财务后台包出错cw_rjz_pack.rjz_pzh&amp;quot;+e.toString();
//		}

		//凭证生成后需要写入到报表系统的指标库
		updateIndexDetail(db,sbh,zth,yy,mm,pzh);
		
		return &amp;quot;1&amp;quot;+&amp;quot;@&amp;quot;+pzh;
	}catch(e) {
		//if (db != null) db.Rollback();
		return &amp;quot;-1&amp;quot;+&amp;quot;@&amp;quot;+&amp;quot;生成凭证出错!&amp;quot;+e.toString()+sql;
	}


}

//凭证生成后需要写入到报表系统的指标库
function updateIndexDetail(db,sbh,zth,yy,mm,pzh)
{
	var accid = sbh+&amp;quot;&amp;quot;+zth;
	var replocid = &amp;quot;&amp;quot;;
	var sql = &amp;quot;select bmbh from oa_reploc where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and hzbz=&amp;apos;2&amp;apos;&amp;quot;;
	try { replocid = db.GetSQL(sql); } catch(e) { throw new Exception(&amp;quot;科目数据写入报表指标库出错！报表位置定义编号未找到！&amp;quot;+e.toString()); }

	sql = &amp;quot;select yy,mm,kmbh,sum(je) je,org,acc,sbh,zth 
			from cw_pzmxb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and yy=&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; and mm=&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos; and pzh=&amp;apos;&amp;quot;+pzh+&amp;quot;&amp;apos;
			group by yy,mm,kmbh,org,acc,sbh,zth&amp;quot;;
	var ds = db.QuerySQL(sql);
	for(var row=0;row&amp;lt;ds.getRowCount();row++) {
		var yy = ds.getStringAt(row,&amp;quot;yy&amp;quot;);
		var mm = ds.getStringAt(row,&amp;quot;mm&amp;quot;);
		if(mm.length() == 1) mm = &amp;quot;0&amp;quot;+mm.toString();                	
		var kmbh = ds.getStringAt(row,&amp;quot;kmbh&amp;quot;);
		var je = 1.0 * ds.getStringAt(row,&amp;quot;je&amp;quot;);
		var org = ds.getStringAt(row,&amp;quot;org&amp;quot;);
		var acc = ds.getStringAt(row,&amp;quot;acc&amp;quot;);
		var sbh = ds.getStringAt(row,&amp;quot;sbh&amp;quot;);
		var zth = ds.getStringAt(row,&amp;quot;zth&amp;quot;);
	
		var indexitemid = &amp;quot;03&amp;quot;;  //指标项 03本月数
	
		//获取科目编号对应的指标编号
		var column_money = &amp;quot;money&amp;quot;+mm;
		sql = &amp;quot;select indexid from fin_index where kmbh = &amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos;&amp;quot;;
		var idxds = db.QuerySQL(sql);
		if (idxds.getRowCount() &amp;lt;= 0) {
			throw new Exception(&amp;quot;科目 &amp;quot;+kmbh+&amp;quot; 未设置对应指标！&amp;quot;);
		}
		
		for (var i=0;i&amp;lt;idxds.getRowCount();i++) {
			var indexid = idxds.getStringAt(i,&amp;quot;INDEXID&amp;quot;);
			
			sql = &amp;quot;select nvl(&amp;quot;+column_money+&amp;quot;,0) &amp;quot;+column_money+&amp;quot; from fin_indexdetail 
				where org=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and acc=&amp;apos;&amp;quot;+accid+&amp;quot;&amp;apos; and indexyear = &amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; and indexid = &amp;apos;&amp;quot;+indexid+&amp;quot;&amp;apos; and indexitemid=&amp;apos;&amp;quot;+indexitemid+&amp;quot;&amp;apos; and replocid=&amp;apos;&amp;quot;+replocid+&amp;quot;&amp;apos;&amp;quot;;
			var sum_money = 0.00;       
			var tmpds = db.QuerySQL(sql);
			if(tmpds.getRowCount() &amp;gt; 0) {
				sum_money = 1.0 * tmpds.getStringAt(0,column_money);
				sum_money += je;					
				sql = &amp;quot;update fin_indexdetail set &amp;quot;+column_money+&amp;quot;=&amp;quot;+sum_money+&amp;quot; 
				       where org=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and acc=&amp;apos;&amp;quot;+accid+&amp;quot;&amp;apos; and indexyear = &amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; and indexid = &amp;apos;&amp;quot;+indexid+&amp;quot;&amp;apos; and indexitemid=&amp;apos;&amp;quot;+indexitemid+&amp;quot;&amp;apos; and replocid=&amp;apos;&amp;quot;+replocid+&amp;quot;&amp;apos;&amp;quot;;
				db.ExcecutSQL(sql);              
			}
			else if(tmpds.getRowCount() == 0 ) {
				sql = &amp;quot;insert into fin_indexdetail(org,acc,indexid,indexyear,indexitemid,&amp;quot;+column_money+&amp;quot;,replocid)
					values(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+accid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+indexid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+indexitemid+&amp;quot;&amp;apos;,&amp;quot;+je+&amp;quot;,&amp;apos;&amp;quot;+replocid+&amp;quot;&amp;apos;)&amp;quot;;
				db.ExcecutSQL(sql);                  	       
			}
		}         
	} 
}


//检查日记帐金额
function CheckMny()
{
	var db = null;
	var sql = &amp;quot;&amp;quot;;
	var ret = &amp;quot;&amp;quot;;

	try {
		db = new pub.EADatabase();
		var ds = new pub.EAXmlDS(rjz2xml);
		for (var i=0;i&amp;lt;ds.getRowCount();i++) {
			var dd = ds.getStringAt(i,&amp;quot;COL1&amp;quot;);
			var yhzy = ds.getStringAt(i,&amp;quot;COL3&amp;quot;);
			var yhje = pub.EAFunc.Replace(ds.getStringAt(i,&amp;quot;COL4&amp;quot;),&amp;quot;,&amp;quot;,&amp;quot;&amp;quot;); //处理金额逗号分隔符
			var yhjefx = ds.getStringAt(i,&amp;quot;COL5&amp;quot;);
			var siseqno = ds.getStringAt(i,&amp;quot;COL6&amp;quot;);
			
			if (dd != &amp;quot;&amp;quot;) {
			
				if (yhzy == &amp;quot;&amp;quot;) {
					ret += &amp;quot;第 &amp;quot;+(i+1)+&amp;quot; 笔记录,摘要不能为空!\n&amp;quot;;
				}
				
				
				sql = &amp;quot;select * from cw_rjzb where org=&amp;apos;%s&amp;apos; and acc=&amp;apos;%s&amp;apos; and yy=%s and mm=%s and siseqno=&amp;apos;%s&amp;apos;&amp;quot;.format([thisorgid,thisaccid,yy,mm,siseqno]);
				var rjzds = db.QuerySQL(sql);
				if (rjzds.getRowCount() &amp;gt; 0) {
					var rjzzy = rjzds.getStringAt(0,&amp;quot;ZY&amp;quot;);
					var rjzje = pub.EAFunc.Replace(rjzds.getStringAt(0,&amp;quot;JE&amp;quot;),&amp;quot;,&amp;quot;,&amp;quot;&amp;quot;); //处理金额逗号分隔符
					var rjzjefx = rjzds.getStringAt(0,&amp;quot;JEFX&amp;quot;);
					var lsh = rjzds.getStringAt(0,&amp;quot;LSH&amp;quot;);
				
					sql = &amp;quot;select round(sum(decode(jefx,&amp;apos;借&amp;apos;,nvl(je,0),0)),2) jfje1,round(sum(decode(jefx,&amp;apos;贷&amp;apos;,nvl(je,0),0)),2) dfje1
						from cw_rjzmxb where org=&amp;apos;%s&amp;apos; and acc=&amp;apos;%s&amp;apos; and lsh=&amp;apos;%s&amp;apos;&amp;quot;.format([thisorgid,thisaccid,lsh]);
					var rjzmxds = db.QuerySQL(sql);
					if (rjzmxds.getRowCount() &amp;lt;= 0) {
						ret += &amp;quot;第 &amp;quot;+(i+1)+&amp;quot; 笔记录有问题：查询日记帐明细表没有记录!\n&amp;quot;;
					}
					
					var jfje1 = pub.EAFunc.Replace(rjzmxds.getStringAt(0,&amp;quot;JFJE1&amp;quot;),&amp;quot;,&amp;quot;,&amp;quot;&amp;quot;); //处理金额逗号分隔符
					var dfje1 = pub.EAFunc.Replace(rjzmxds.getStringAt(0,&amp;quot;DFJE1&amp;quot;),&amp;quot;,&amp;quot;,&amp;quot;&amp;quot;); //处理金额逗号分隔符
					var jdje = pub.EAFunc.Replace(pub.EAFunc.formatMoney(1.0*jfje1 - 1.0*dfje1,2),&amp;quot;,&amp;quot;,&amp;quot;&amp;quot;); //处理金额逗号分隔符
				
					var jdfx = &amp;quot;&amp;quot;;
					if (java.lang.Math.abs(1.0*jfje1) &amp;gt;= java.lang.Math.abs(1.0*dfje1)) {
						jdfx = &amp;quot;借&amp;quot;;
						if (1.0*jfje1 &amp;gt;= 0) jdje = &amp;quot;&amp;quot; + (java.lang.Math.abs(1.0*jdje));
						else jdje = &amp;quot;&amp;quot; + (-1 * java.lang.Math.abs(1.0*jdje));						
					}
					else {
						jdfx = &amp;quot;贷&amp;quot;;
						if (1.0*dfje1 &amp;gt;= 0) jdje = &amp;quot;&amp;quot; + java.lang.Math.abs(1.0*jdje);
						else jdje = &amp;quot;&amp;quot; + (-1 * java.lang.Math.abs(1.0*jdje));
						
					}

					if (!(rjzje == 0 &amp;&amp; jdje == 0)) {
						if ((1.0*yhje != 1.0*rjzje) || (1.0*rjzje != 1.0*jdje) || rjzjefx != jdfx) {
							ret += &amp;quot;第 &amp;quot; + (i+1) + &amp;quot; 笔记录有问题：&amp;quot; + yhzy + &amp;quot; 【日记帐主表金额:&amp;quot; + rjzjefx +&amp;quot; &amp;quot; + pub.EAFunc.formatMoney(1.0*rjzje,2) 
								+ &amp;quot; != 明细表金额:&amp;quot; + jdfx + &amp;quot; &amp;quot; + pub.EAFunc.formatMoney(1.0*jdje,2) + &amp;quot;】\n&amp;quot;;
						}
					}
				
				}
			}
		}
		
		if (ret == &amp;quot;&amp;quot;) {
			ret = &amp;quot;检查完成,没有发现问题!&amp;quot;;
		}
		
		return ret;
	
	}
	catch (e) {
		if (db != null) db.Rollback();
		return e.toString();
	}
	finally {
		if (db != null) db.Close();
	}
}


function getRjzByKXBZ()
{	
	// 日记帐录入时选择款项类型: 收入, 支出, 收支, 其他
	var g_sr_lxbh = &amp;quot;lxbh=&amp;apos;11&amp;apos; or lxbh=&amp;apos;21&amp;apos; or lxbh=&amp;apos;31&amp;apos;  OR  lxbh=&amp;apos;33&amp;apos; OR lxbh=&amp;apos;34&amp;apos; OR lxbh=&amp;apos;37&amp;apos; OR lxbh=&amp;apos;38&amp;apos; OR lxbh=&amp;apos;39&amp;apos; OR lxbh=&amp;apos;41&amp;apos; or lxbh=&amp;apos;51&amp;apos; or lxbh=&amp;apos;61&amp;apos; or lxbh = &amp;apos;71&amp;apos;&amp;quot;;
	var g_zc_lxbh = &amp;quot;lxbh=&amp;apos;12&amp;apos; or lxbh=&amp;apos;22&amp;apos; or lxbh=&amp;apos;32&amp;apos; OR lxbh=&amp;apos;35&amp;apos; OR lxbh=&amp;apos;36&amp;apos; OR  lxbh=&amp;apos;3A&amp;apos; OR  lxbh=&amp;apos;3B&amp;apos; OR lxbh=&amp;apos;3C&amp;apos; OR lxbh=&amp;apos;3D&amp;apos; or lxbh=&amp;apos;42&amp;apos; or lxbh=&amp;apos;52&amp;apos; or lxbh=&amp;apos;62&amp;apos; or lxbh = &amp;apos;72&amp;apos; or lxbh=&amp;apos;91&amp;apos; or lxbh=&amp;apos;92&amp;apos; &amp;quot;;
	var g_sz_lxbh = &amp;quot;lxbh=&amp;apos;11&amp;apos; or lxbh=&amp;apos;21&amp;apos; or lxbh=&amp;apos;31&amp;apos; OR  lxbh=&amp;apos;33&amp;apos; OR lxbh=&amp;apos;34&amp;apos; OR lxbh=&amp;apos;37&amp;apos; OR lxbh=&amp;apos;38&amp;apos; OR lxbh=&amp;apos;39&amp;apos; or lxbh=&amp;apos;41&amp;apos; or lxbh=&amp;apos;51&amp;apos; or lxbh=&amp;apos;61&amp;apos; or lxbh = &amp;apos;71&amp;apos; or lxbh=&amp;apos;12&amp;apos; or lxbh=&amp;apos;22&amp;apos; or lxbh=&amp;apos;32&amp;apos;  OR lxbh=&amp;apos;35&amp;apos; OR lxbh=&amp;apos;36&amp;apos; OR  lxbh=&amp;apos;3A&amp;apos; OR  lxbh=&amp;apos;3B&amp;apos; OR lxbh=&amp;apos;3C&amp;apos; OR lxbh=&amp;apos;3D&amp;apos; or lxbh=&amp;apos;42&amp;apos; or lxbh=&amp;apos;52&amp;apos; or lxbh=&amp;apos;62&amp;apos; or lxbh = &amp;apos;72&amp;apos; or lxbh=&amp;apos;91&amp;apos; or lxbh=&amp;apos;92&amp;apos; &amp;quot;;
	var g_qts_lxbh = &amp;quot;lxbh=&amp;apos;81&amp;apos; or lxbh=&amp;apos;82&amp;apos; or lxbh=&amp;apos;83&amp;apos; or lxbh=&amp;apos;84&amp;apos; or lxbh=&amp;apos;85&amp;apos; or lxbh=&amp;apos;86&amp;apos; or lxbh = &amp;apos;87&amp;apos; or lxbh = &amp;apos;88&amp;apos; or lxbh = &amp;apos;89&amp;apos;&amp;quot;;
	var g_qtz_lxbh = &amp;quot;lxbh=&amp;apos;93&amp;apos; or lxbh=&amp;apos;94&amp;apos; or lxbh=&amp;apos;95&amp;apos; or lxbh=&amp;apos;96&amp;apos; or lxbh = &amp;apos;97&amp;apos; or lxbh = &amp;apos;98&amp;apos; or lxbh = &amp;apos;99&amp;apos;&amp;quot;; //20121010 qfj 增加医疗手工增加提现款项99
	var g_qtsz_lxbh = &amp;quot;lxbh=&amp;apos;81&amp;apos; or lxbh=&amp;apos;82&amp;apos; or lxbh=&amp;apos;83&amp;apos; or lxbh=&amp;apos;84&amp;apos; or lxbh=&amp;apos;85&amp;apos; or lxbh=&amp;apos;86&amp;apos; or lxbh = &amp;apos;87&amp;apos; or lxbh = &amp;apos;88&amp;apos; or lxbh = &amp;apos;89&amp;apos; or lxbh=&amp;apos;93&amp;apos; or lxbh=&amp;apos;94&amp;apos; or lxbh=&amp;apos;95&amp;apos; or lxbh=&amp;apos;96&amp;apos; or lxbh = &amp;apos;97&amp;apos; or lxbh = &amp;apos;98&amp;apos; or lxbh = &amp;apos;99&amp;apos;&amp;quot;;
	
	var sr_lxbh = pub.EAFunc.Replace(g_sr_lxbh,&amp;quot;lxbh&amp;quot;,&amp;quot;b.lxbh&amp;quot;);
	var zc_lxbh = pub.EAFunc.Replace(g_zc_lxbh,&amp;quot;lxbh&amp;quot;,&amp;quot;b.lxbh&amp;quot;);
	var sz_lxbh = pub.EAFunc.Replace(g_sz_lxbh,&amp;quot;lxbh&amp;quot;,&amp;quot;b.lxbh&amp;quot;);
	var qts_lxbh = pub.EAFunc.Replace(g_qts_lxbh,&amp;quot;lxbh&amp;quot;,&amp;quot;b.lxbh&amp;quot;);
	var qtz_lxbh = pub.EAFunc.Replace(g_qtz_lxbh,&amp;quot;lxbh&amp;quot;,&amp;quot;b.lxbh&amp;quot;);
	var qtsz_lxbh = pub.EAFunc.Replace(g_qtsz_lxbh,&amp;quot;lxbh&amp;quot;,&amp;quot;b.lxbh&amp;quot;);
	
	var sql = &amp;quot;select distinct yy,mm,dd,siseqno,sxh from cw_rjzb a,cw_rjzmxb b
		where a.sbh=b.sbh and a.zth=b.zth and a.lsh=b.lsh
		  and a.sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and a.zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; 
		  and a.yy=&amp;quot;+yyyy+&amp;quot; and a.mm=&amp;quot;+mm+&amp;quot; and a.kmbh=&amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos;&amp;quot;;
	//1基本收入
	if (bz == 1) sql += &amp;quot; and (&amp;quot;+sr_lxbh+&amp;quot;)&amp;quot;;
	//2支出
	else if (bz == 2) sql += &amp;quot; and (&amp;quot;+zc_lxbh+&amp;quot;)&amp;quot;;
	//3收支
	else if (bz == 3) sql += &amp;quot; and (&amp;quot;+sr_lxbh+&amp;quot; or &amp;quot;+zc_lxbh+&amp;quot;)&amp;quot;;
	//4其他收入
	else if (bz == 4) sql += &amp;quot; and (&amp;quot;+qts_lxbh+&amp;quot;)&amp;quot;;
	//5其他支出
	else if (bz == 5) sql += &amp;quot; and (&amp;quot;+qtz_lxbh+&amp;quot;)&amp;quot;;
	//6其他收支
	else if (bz == 6) sql += &amp;quot; and (&amp;quot;+qts_lxbh+&amp;quot; or &amp;quot;+qtz_lxbh+&amp;quot;)&amp;quot;;
	//7借方（收入）
	else if (bz == 7) sql += &amp;quot; and a.jefx=&amp;apos;借&amp;apos;&amp;quot;;
	//8贷方（支出）
	else if (bz == 8) sql += &amp;quot; and a.jefx=&amp;apos;贷&amp;apos;&amp;quot;;
	//9全部
	else if (bz == 9) sql += &amp;quot;&amp;quot;;
	
	var mysql = &amp;quot;select * from (&amp;quot;+sql+&amp;quot;) ORDER BY SXH,SISEQNO&amp;quot;;
	
	var ds = pub.EADbTool.QuerySQL(mysql);
	return ds.GetXml();
}



</GRDOSDS_VALUE></ROW>
</ROWSET>
</grdosds><grddscds>
<ROWSET>
<ROW num="0" ><ID >rjzpzsc</ID><NAME >日记账凭证生成</NAME><DATDSC >SELECT &amp;apos;&amp;apos; sel,
       A.DD,
       A.CWPCH,
       A.ZY,
       A.JE,
       A.JEFX,
       A.SISEQNO,
       A.DJH,
       &amp;apos;&amp;apos; DYLSH,
       A.ZTBH,
       b.lxbh LXBH,
       &amp;apos;&amp;apos; BZ,
       A.ZTMC,
       A.ZTLX DWLXBH,
       &amp;apos;&amp;apos; DWLX
  FROM CW_YHRJZB A, (
       select distinct a.sbh,a.zth,a.siseqno,min(a.lxbh) lxbh from cw_rjzb a,cw_rjzmxb b
       where a.sbh=b.sbh and a.zth=b.zth and a.lsh=b.lsh
          and a.sbh=&amp;apos;[%SBH]&amp;apos; and a.zth=&amp;apos;[%ZTH]&amp;apos; 
	    and a.yy=[%YYYY] and a.mm=[%MM] 
          and a.kmbh=&amp;apos;[%KMBH]&amp;apos; group by a.sbh,a.zth,a.siseqno
  ) B
 WHERE A.SBH = &amp;apos;[%SBH]&amp;apos;
   AND A.ZTH = &amp;apos;[%ZTH]&amp;apos;
   AND A.YY = &amp;apos;[%YYYY]&amp;apos;
   AND A.MM = &amp;apos;[%MM]&amp;apos;
   AND A.KMBH = &amp;apos;[%KMBH]&amp;apos; [%FILTER]
   AND A.PZH IS NULL
   AND A.QCBZ = &amp;apos;0&amp;apos; 
   and a.siseqno=b.siseqno and a.sbh=b.sbh and a.zth=b.zth
 ORDER BY A.DD,A.SXH, A.SISEQNO</DATDSC><C4 >rjzpzsc</C4><C5 >rjzpzsc</C5><C6 >rjzpzsc</C6><C7 >rjzpzsc</C7><C8 >rjzpzsc</C8><C9 >rjzpzsc</C9><C10 >rjzpzsc</C10><C11 >rjzpzsc</C11><C12 >rjzpzsc</C12><C13 >rjzpzsc</C13><C14 >rjzpzsc</C14><C15 >rjzpzsc</C15><C16 ></C16><C17 >rjzpzsc</C17><C18 >rjzpzsc</C18></ROW>
<ROW num="1" ><ID >rjzmxb</ID><NAME >日记账明细表</NAME><DATDSC >SELECT NVL(C.RJLX, A.KMBH) RJLX,
       NVL(B.KXMC, D.KMMC) KXMC,
       A.YM1,
       A.YM2,
       A.JE,
       A.JEFX,
       A.SBH SBH,
       A.ZTH ZTH,
       A.LSH,
       A.LXBH,
       A.LXXH
  FROM CW_RJZMXB A, CW_RJLXMXB B, CW_RJLXB C, CW_KMB D, CW_RJZB E
 WHERE A.SBH = &amp;apos;[%SBH]&amp;apos;
   AND A.ZTH = &amp;apos;[%ZTH]&amp;apos;
   AND D.SBH(+) = &amp;apos;[%SBH]&amp;apos;
   AND D.ZTH(+) = &amp;apos;[%ZTH]&amp;apos;
   AND D.KMBH(+) = A.KMBH
   AND B.SBH(+) = &amp;apos;[%SBH]&amp;apos;
   AND B.ZTH(+) = &amp;apos;[%ZTH]&amp;apos;
   AND B.LXBH(+) = A.LXBH
   AND B.MXXH(+) = A.LXXH
   AND C.SBH(+) = &amp;apos;[%SBH]&amp;apos;
   AND C.ZTH(+) = &amp;apos;[%ZTH]&amp;apos;
   AND C.LXBH(+) = B.LXBH
   AND A.SBH = E.SBH
   AND A.ZTH = E.ZTH
   AND A.LSH = E.LSH
   AND E.SISEQNO = &amp;apos;[%SBLSH]&amp;apos; AND E.KMBH=&amp;apos;[%KMBH]&amp;apos;
   AND E.SBH = &amp;apos;[%SBH]&amp;apos;
   AND E.ZTH = &amp;apos;[%ZTH]&amp;apos;
 ORDER BY A.LSH, A.MXXH</DATDSC><C4 >rjzmxb</C4><C5 ></C5><C6 ></C6><C7 ></C7><C8 ></C8><C9 ></C9><C10 >rjzmxb</C10><C11 ></C11><C12 >rjzmxb</C12><C13 ></C13><C14 >rjzmxb</C14><C15 ></C15><C16 >rjzmxb</C16><C17 ></C17><C18 >rjzmxb</C18></ROW>
<ROW num="2" ><ID >getKmmc</ID><NAME ></NAME><DATDSC >select cw_pack4.kmmc(&amp;apos;[%SBH]&amp;apos;,&amp;apos;[%ZTH]&amp;apos;,&amp;apos;[%KMBH]&amp;apos;) KMMC
FROM dual </DATDSC><C4 ></C4><C5 ></C5><C6 ></C6><C7 ></C7><C8 ></C8><C9 >getKmmc</C9><C10 ></C10><C11 ></C11><C12 ></C12><C13 ></C13><C14 ></C14><C15 ></C15><C16 ></C16><C17 ></C17><C18 ></C18></ROW>
<ROW num="3" ><ID >getCount</ID><NAME ></NAME><DATDSC >select count(1) COUNT from cw_rjzmxb 
 where sbh = &amp;apos;[%SBH]&amp;apos; and zth = &amp;apos;[%ZTH]&amp;apos; and lsh = &amp;apos;[%LSH]&amp;apos;
   and lxbh = &amp;apos;[%LXBH]&amp;apos; and lxxh = &amp;apos;[%LXXH]&amp;apos;</DATDSC><C4 ></C4><C5 ></C5><C6 ></C6><C7 ></C7><C8 ></C8><C9 ></C9><C10 ></C10><C11 ></C11><C12 ></C12><C13 ></C13><C14 ></C14><C15 ></C15><C16 ></C16><C17 ></C17><C18 ></C18></ROW>
</ROWSET>
</grddscds><fldhdr>
<ROWSET>
<ROW num="0" ><BILID >1单据编号</BILID><STAT >0单据状态</STAT><SUBTYP >0子类型</SUBTYP><CORPID >0往来单位编号</CORPID><CORPNAM >0往来单位名称</CORPNAM><LOCID >0仓库|部门编号</LOCID><LOCNAM >0仓库|部门名称</LOCNAM><DAT >0单据日期</DAT><CRTUSR >1录入人</CRTUSR><CRTUSRNAM >0录入人姓名</CRTUSRNAM><CRTDAT >0录入日期</CRTDAT><CHKUSR >1审核人</CHKUSR><CHKUSRNAM >0审核人姓名</CHKUSRNAM><CHKDAT >0审核日期</CHKDAT><SUMQTY >0合计金额</SUMQTY><SUMMNY >0合计金额</SUMMNY><REFID1 >0扩展字段</REFID1><REFNAM1 >0扩展字段</REFNAM1><REFID2 >0扩展字段</REFID2><REFNAM2 >0扩展字段</REFNAM2><REFID3 >0扩展字段</REFID3><REFNAM3 >0扩展字段</REFNAM3><REFID4 >0扩展字段</REFID4><REFNAM4 >0扩展字段</REFNAM4><REFID5 >0扩展字段</REFID5><REFNAM5 >0扩展字段</REFNAM5><REFID6 >0扩展字段</REFID6><REFNAM6 >0扩展字段</REFNAM6><NOTE >0备注</NOTE></ROW>
</ROWSET>
</fldhdr><flddtl>
<ROWSET>
<ROW num="0" ><SEQID >1明细序号</SEQID><ITMID >1品种编号</ITMID><ITMNAM >0品种名称</ITMNAM><ITEMPC >0品种批次号</ITEMPC><ITMSPC >0规格</ITMSPC><UNIT >0计量单位</UNIT><SMLUNT >0小计量单位</SMLUNT><UNTNUM >0大单位转小单位因子</UNTNUM><PRICE >0价格</PRICE><QTY >0数量</QTY><TAXTYP >0税率类型</TAXTYP><NOTAXMNY >0不含税税额</NOTAXMNY><TAXMNY >0税额</TAXMNY><MNY >0下单金额</MNY><REFID1 >0扩展字段</REFID1><REFNAM1 >0扩展字段</REFNAM1><REFID2 >0扩展字段</REFID2><REFNAM2 >0扩展字段</REFNAM2><REFID3 >0扩展字段</REFID3><REFNAM3 >0扩展字段</REFNAM3><REFID4 >0扩展字段</REFID4><REFNAM4 >0扩展字段</REFNAM4><REFID5 >0扩展字段</REFID5><REFNAM5 >0扩展字段</REFNAM5></ROW>
</ROWSET>
</flddtl></mdroot>