<?xml version='1.0' encoding='GBK'?><mdroot><grdds>
<ROWSET>
<ROW num="0" ><MWTYP >R</MWTYP><MWID >RJZ_ZSRETURN</MWID><NAME >征收回盘确认</NAME><NOTE ></NOTE><NOACCNAME ></NOACCNAME><FILE >RJZ_ZSRETURN.zxg</FILE><SCENE ></SCENE><FIXED >1,1</FIXED><CATTYP ></CATTYP><DTLRNG ></DTLRNG><BATINP ></BATINP><MANUNIT ></MANUNIT><USESMLUNT ></USESMLUNT><ITEMTABLE ></ITEMTABLE><BILHDRTABLE ></BILHDRTABLE><BILDTLTABLE ></BILDTLTABLE><COLLIST ></COLLIST><WHERE ></WHERE><ORDER ></ORDER><DBNAME ></DBNAME><LISTSUM ></LISTSUM><LOADDATA ></LOADDATA><CHECKTITLE ></CHECKTITLE><IFBILL ></IFBILL><EXTJS ></EXTJS><JAVACLS ></JAVACLS><POST2MWID ></POST2MWID><LMS ></LMS><WIDTHMOD >1</WIDTHMOD><HEIGHTMOD ></HEIGHTMOD><CLIENTCLASS ></CLIENTCLASS><SHOWBTN >0</SHOWBTN><CLOSEPAGES ></CLOSEPAGES><syt >SBCW</syt></ROW>
</ROWSET>
</grdds><grdbtnds>
<ROWSET>
<ROW num="0" ><ID >doCheck</ID><NAME >数据检查</NAME><ACTTYP ></ACTTYP><URL ></URL><URLTARGET ></URLTARGET><TIP ></TIP><BTNORD ></BTNORD><IMG >1</IMG><IMGMOUSE >1</IMGMOUSE><C10 >dataCheck</C10></ROW>
<ROW num="1" ><ID >closeWND</ID><NAME >关闭</NAME><ACTTYP ></ACTTYP><URL ></URL><URLTARGET ></URLTARGET><TIP ></TIP><BTNORD ></BTNORD><IMG >2</IMG><IMGMOUSE >2</IMGMOUSE><C10 ></C10></ROW>
</ROWSET>
</grdbtnds><grdpamds>
<ROWSET>
<ROW num="0" ><ID >HPRQ</ID><NAME >回盘日期</NAME><NOTNULL ></NOTNULL><KEYVAL ></KEYVAL><INPCTL ></INPCTL><DISPORD ></DISPORD><SQLWHE ></SQLWHE><DEFVAL ></DEFVAL><TIP ></TIP><EDTFLG >1</EDTFLG><VISFLG >1</VISFLG><KEYFLG ></KEYFLG><C13 >hprq</C13><C14 >HPRQ</C14></ROW>
<ROW num="1" ><ID >JOBID</ID><NAME >回盘作业号</NAME><NOTNULL ></NOTNULL><KEYVAL ></KEYVAL><INPCTL ></INPCTL><DISPORD ></DISPORD><SQLWHE ></SQLWHE><DEFVAL ></DEFVAL><TIP ></TIP><EDTFLG >1</EDTFLG><VISFLG >1</VISFLG><KEYFLG ></KEYFLG><C13 >hpseqno</C13><C14 >JOBID</C14></ROW>
</ROWSET>
</grdpamds><grdshwds>
<ROWSET>
<ROW num="0" ><ID >0,1,0</ID><NAME ></NAME><DBNAME ></DBNAME><DSKEY >DSC:MAIN</DSKEY><NROW >2</NROW><NCOL >18</NCOL><PAGES ></PAGES><PAGESIZE ></PAGESIZE><URL ></URL><CTLTYP ></CTLTYP><DYNCTL ></DYNCTL><LISTID ></LISTID><ISCROSS ></ISCROSS><HROW ></HROW><HCOLS ></HCOLS><ROWORDER ></ROWORDER><VCOLS ></VCOLS><VCOLSQL ></VCOLSQL><VALUECOL ></VALUECOL><C20 >0,1,0</C20><C21 >0,1,0</C21></ROW>
</ROWSET>
</grdshwds><grdjsds>
<ROWSET>
<ROW num="0" ><GRDJSDS_VALUE >var checkResult = 0; //回盘数据格式检查结果
var intervalProcess;
var timecnt = 0;

//数据加载完毕
function _thisOnpost_loaddata(sheet)
{
	_this.SplitSheet(1,&amp;quot;V&amp;quot;,&amp;quot;40%&amp;quot;);
	_this.AutoFixColWidth(0,600);
	_this.AutoFixScreenWidth();
	_this.SetAttribe(&amp;quot;SHEET_0&amp;quot;,_this.ATTR_SHEET_SELECTFLAG,_this. SELECTFLAG_SINGLEROW );
	_this.SetAttribe(&amp;quot;SHEET_1&amp;quot;,_this.ATTR_SHOW_ZERO,1);
	_this.SetColVisible(0,7,-1);
	_this.SetColVisible(0,8,-1);

	
	_this.SetCellText(1,2,2,HPRQ);
	_this.SetToolbarString(&amp;quot;提示：当前回盘作业号:&amp;quot;+JOBID + &amp;quot;    快捷键：Ctrl+F查找&amp;quot;);
	
	_sql.querytods(&amp;quot;INFODS&amp;quot;,&amp;quot;JOBID=&amp;quot;+JOBID);
	_this.SetCellText(1,2,6,_this.XMLDS_GetString(0,&amp;quot;ZBS&amp;quot;));
	_this.SetCellText(1,2,8,_this.XMLDS_GetString(0,&amp;quot;DWBS&amp;quot;));
	_this.SetCellText(1,2,4,_this.XMLDS_GetString(0,&amp;quot;SUMJE&amp;quot;));
	_this.SetCellText(1,4,2,_this.XMLDS_GetString(0,&amp;quot;SUCCBS&amp;quot;));
	_this.SetCellText(1,4,6,_this.XMLDS_GetString(0,&amp;quot;FAILBS&amp;quot;));
	_this.SetCellText(1,4,4,_this.XMLDS_GetString(0,&amp;quot;SUCCJE&amp;quot;));
	_this.SetCellText(1,4,8,_this.XMLDS_GetString(0,&amp;quot;FAILJE&amp;quot;));
	
	_this.SetToCheckBox(&amp;quot;&amp;quot;,1,6,1,&amp;quot;是否笔数匹配&amp;quot;,&amp;quot;1&amp;quot;,&amp;quot;0&amp;quot;);
	_this.SetCellText(1,6,1,&amp;quot;1&amp;quot;);
	
	//20170228 lwq add-补托提醒
	var xbtdw = 0;
	var arrayObj = new Array();　//创建一个数组
	var xbts = 0;
	for (var r=_this.GetMainCellRangeRow1(0);r&amp;lt;=_this.GetMainCellRangeRow2(0);r++) {
		var hkbz = _this.GetCellText(0,r,15);
		if(hkbz == &amp;quot;1&amp;quot; || hkbz == &amp;quot;2&amp;quot;){
			xbts++;
		}
		var dwbhtxt = _this.GetCellText(0,r,2);
		if(!contains(arrayObj,dwbhtxt)) {
			arrayObj.push(dwbhtxt);
		}
	}
	xbtdw = arrayObj.length;
	if(xbts &amp;gt; 0){
		_this.SetCellText(1,11,1,&amp;quot;[提醒：当前您有单位数：&amp;quot;+xbtdw+&amp;quot;，笔数：&amp;quot;+xbts+&amp;quot;，需要生成补托数据或作废数据！]&amp;quot;);
	}
}

//数据检查
function dataCheck()
{
	var sbh = G_ORGID;
	var zth = G_ACCID.replace(G_ORGID,&amp;quot;&amp;quot;);
	var jobseqid = &amp;quot;SAVE_&amp;quot;+JOBID;
	var chkbs = _this.GetCellText(1,6,1);
	var ret = invokeOSFunc(&amp;quot;CheckHPData&amp;quot;,&amp;quot;sbh=&amp;quot;+sbh+&amp;quot;&amp;zth=&amp;quot;+zth+&amp;quot;&amp;jobid=&amp;quot;+JOBID+&amp;quot;&amp;jobseqid=&amp;quot;+jobseqid+&amp;quot;&amp;chkbs=&amp;quot;+chkbs);
	if (ret != &amp;quot;1&amp;quot;) {
		alert(&amp;quot;数据检查，发现以下问题：\n&amp;quot;+ret);
		_this.SetCellText(1,8,1,&amp;quot;数据检查，发现以下问题：\n&amp;quot;+ret);
		return 0;
	}
	return 1;
}

function doCheck()
{
	var ret = dataCheck();
	if (ret == 1) {
		alert(&amp;quot;数据检查完毕，没有发现问题！&amp;quot;);
		_this.SetCellText(1,8,1,&amp;quot;&amp;quot;);
	}
}

//点击按钮
function _thisOnButtonCtrlClick(id,sheet,row,col)
{
	if (id == &amp;quot;保存回盘&amp;quot;) {
		if (!confirm(&amp;quot;回盘保存，请确认以下信息！\n回盘入账日期： &amp;quot;+_this.GetCellText(1,2,2)
			+&amp;quot;\n   总笔数： &amp;quot;+_this.GetCellText(1,2,6)+&amp;quot;  单位数： &amp;quot;+_this.GetCellText(1,2,8)
			+&amp;quot;\n   总金额： &amp;quot;+ (1.0*_this.GetCellText(1,2,4)).toFixed(2)
			+&amp;quot;\n成功笔数： &amp;quot;+_this.GetCellText(1,4,2) +&amp;quot;  成功金额： &amp;quot;+_this.GetCellText(1,4,4)
			+&amp;quot;\n失败笔数： &amp;quot;+_this.GetCellText(1,4,6)+&amp;quot;  失败金额： &amp;quot;+_this.GetCellText(1,4,8)
		    )) return;
		if (dataCheck() == 0) return;
		
		var param = new Object();
		param.zth = G_ACCID.replace(G_ORGID,&amp;quot;&amp;quot;);
		param.hpdat = _this.GetCellText(1,2,2);
		param.thisorgid = G_ORGID;
		param.thisaccid = G_ACCID;
		param.usrid = G_USRID;
		param.czyxm = G_USRNAM;
		
		var jobseqid = &amp;quot;SAVE_&amp;quot;+JOBID;
		param.jobid = jobseqid;
		param.jobnam = &amp;quot;银行发放回盘导入进程[&amp;quot;+jobseqid+&amp;quot;]&amp;quot;;
		
		_sql.querytods(&amp;quot;QueryRunOSTimer&amp;quot;,&amp;quot;jobseqid=&amp;quot;+jobseqid);
		if( 1*_this.XMLDS_GetStringAt(0,0)&amp;gt;0 ){
			//有一个作业正在运行，打开进度框
			//window.showModalDialog(&amp;quot;show.sp?grdid=RunOSTimer&amp;jobseqid=&amp;quot;+jobseqid,&amp;quot;&amp;quot;,&amp;quot;dialogwidth:600pt;dialogheight:500pt;help:yes;resizable:yes;&amp;quot; );
			refresh(jobseqid);
		}
		else {
			_sql.querytods(&amp;quot;QueryRunOSTimerExist&amp;quot;,&amp;quot;jobseqid=&amp;quot;+jobseqid);
			if ( 1*_this.XMLDS_GetStringAt(0,0) &amp;gt; 0) { //是否运行结束
				//运行结束打开预览保存窗口
				clearInterval(intervalProcess);		
				refresh(jobseqid);	
			}
			else {
				intervalProcess = setInterval(&amp;quot;refresh(&amp;apos;&amp;quot;+jobseqid+&amp;quot;&amp;apos;)&amp;quot;,500);
				var ret = invokeOSFuncExt(&amp;quot;genbatch&amp;quot;,param);   
				if ( ret == jobseqid ) {
					//window.showModalDialog(&amp;quot;show.sp?grdid=RunOSTimer&amp;rungrdid=RJZ_PAYRETURN&amp;jobseqid=&amp;quot;+ret ,&amp;quot;&amp;quot;,&amp;quot;dialogwidth:600pt;dialogheight:500pt;help:yes;resizable:yes;&amp;quot; );
				}			
			}
		}
	}
}

function refresh(jobseqid)
{
	timecnt ++;
	var savebz = 0;
	
	_sql.querytods(&amp;quot;TIPSDS&amp;quot;,&amp;quot;jobseqid=&amp;quot;+jobseqid);
	var percent = _this.XMLDS_GetString(0,&amp;quot;PERCENT&amp;quot;);
	var tips = _this.XMLDS_GetString(0,&amp;quot;TIPS&amp;quot;);
	//_this.SetToolbarString(tips+&amp;quot; 进程ID:&amp;quot;+jobseqid);
	if (tips.indexOf(&amp;quot;保存征收回盘数据成功&amp;quot;) &amp;gt; -1) {
		savebz = 1;
	}
	var str = &amp;quot;&amp;quot;;
	for (var i=0;i&amp;lt;_this.XMLDS_GetRowCount();i++) {
		str += _this.XMLDS_GetString(i,&amp;quot;TIPS&amp;quot;) + &amp;quot;\n&amp;quot;;
	}
	_this.SetCellText(1,8,1,str);
	
	_this.SetRedraw(0);
	_this.SetCellText(1,0,0,&amp;quot;保存进度 &amp;quot;+percent+&amp;quot;%&amp;quot;);
	var colwidth = 0;
	for (var c=0;c&amp;lt;=9;c++) {
		colwidth += _this.GetColWidth(1,c);
	}
	_this.SetToRectbox(1,0,0, &amp;quot;&amp;quot;,&amp;quot;&amp;quot;,&amp;quot;保存进度 &amp;quot;+(percent*colwidth/100),&amp;quot;&amp;quot;+_this.GetRowHeight(1,0), &amp;quot;#FF0000&amp;quot;, 1,&amp;quot;#FF0000&amp;quot;,1,&amp;quot;#FF0000&amp;quot;,1,&amp;quot;#FF0000&amp;quot;,1,&amp;quot;#FF0000&amp;quot;);
	_this.SetRedraw(1);
	
	if (percent == 100) {
		clearInterval(intervalProcess);
		if (savebz == 1) {
			if (!confirm(&amp;quot;保存回盘数据成功！是否关闭窗口？&amp;quot;)) return;
			window.returnValue = &amp;quot;success&amp;quot;;
			window.close();
		}
		else {
			alert(&amp;quot;保存回盘数据失败！&amp;quot;);
		}
	}
}

//关闭
function closeWND()
{
	window.returnValue = &amp;quot;success&amp;quot;;
	window.close();
}

//20170228 lwq add
//判断数组是否存在某个元素
function contains(arr, obj) {  
    var i = arr.length;  
    while (i--) {  
        if (arr[i] === obj) {  
            return true;  
        }  
    }  
    return false;  
}</GRDJSDS_VALUE></ROW>
</ROWSET>
</grdjsds><grdosds>
<ROWSET>
<ROW num="0" ><GRDOSDS_VALUE >var pub = new JavaPackage(&amp;quot;com.xlsgrid.net.pub&amp;quot;);
var web = new JavaPackage(&amp;quot;com.xlsgrid.net.web&amp;quot;);
var servletpack = new JavaPackage(&amp;quot;com.xlsgrid.net.servlet&amp;quot;);
var ftppack = new JavaPackage(&amp;quot;org.apache.commons.net.ftp&amp;quot;);
var timepack = new JavaPackage( &amp;quot;com.xlsgrid.net.time&amp;quot; );

//银行回盘处理
function SaveYHZSHP()
{
	var filename = &amp;quot;&amp;quot;;
	var db = null;
	var sql = &amp;quot;&amp;quot;;
	var jkret = &amp;quot;&amp;quot;;
	var rowcnt = 0;
	var failecnt = 0;
	var process = 0;
	var sbh = thisorgid;
	var zbs = 0;//总笔数
	var succnt = 0;
	var yszlCheck = 0;
	
	try {
		db = new pub.EADatabase();
		
		var uo_ywjk = new SBCW_IYWJK(); //业务接口类
		var ywjkbz = uo_ywjk.getYWJKBZ(db,thisaccid);
		var yh_ywjk = new SBCW_YWJK_YH(); //征收业务接口函数
		var service = new SBCW_sbcwService();

		notify(jobseqid,0,&amp;quot;准备保存银行征收回盘数据...&amp;quot;,&amp;quot;run&amp;quot;);//名称为空表示只要更新进度

		sql = &amp;quot;select tcqbm from cw_sbsb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;&amp;quot;;
		var tcqbm = db.GetSQL(sql);		
		
		//2016-12-20修改为以下sql
		//sql = &amp;quot;select * from SI_ZSYHRETURN_TEMP where jobid=replace(&amp;apos;%s&amp;apos;,&amp;apos;SAVE_&amp;apos;,&amp;apos;&amp;apos;) and xmm!=&amp;apos;MMMMMMMMMMMMMMMM&amp;apos;&amp;quot;.format([jobseqid]);
		sql = &amp;quot;select * from (
			select min(xh) xh,djh,dwbh,num,dwzh,dwkhhm,khhm,yymm,rs,sum(dwj) dwj,sum(tfj) trj,sum(grj) grj,djrq,hkrq,hkbz,jobid,filename
			from SI_ZSYHRETURN_TEMP where jobid=replace(&amp;apos;%s&amp;apos;,&amp;apos;SAVE_&amp;apos;,&amp;apos;&amp;apos;) and xmm!=&amp;apos;MMMMMMMMMMMMMMMM&amp;apos;
			group by djh,dwbh,num,dwzh,dwkhhm,khhm,yymm,rs,djrq,hkrq,hkbz,jobid,filename
			) order by xh&amp;quot;.format([jobseqid]);
		var ds = db.QuerySQL(sql);
		
		rowcnt = ds.getRowCount();
		var modcnt = 5;
		if (rowcnt &amp;gt;= 10000) modcnt = 1000;
		else if (rowcnt &amp;gt;= 5000) modcnt = 500;
		else if (rowcnt &amp;gt;= 1000) modcnt = 100;
		else if (rowcnt &amp;gt;= 500) modcnt = 200;
		else if (rowcnt &amp;gt;= 200) modcnt = 50;
		else if (rowcnt &amp;gt;= 50) modcnt = 10;
		
		var djh_old = &amp;quot;&amp;quot;;
		var dwbh_old = &amp;quot;&amp;quot;;
		var pch     = &amp;quot;&amp;quot;;
		
		for (var i=0;i&amp;lt;rowcnt;i++) {
			zbs++;
			var currow = i + 1;
			process = db.GetSQL(&amp;quot;select round(&amp;quot;+currow+&amp;quot; / &amp;quot;+rowcnt+&amp;quot; * 100,0)-1 from dual&amp;quot;);			
			if (currow % modcnt == 0) {
				notify(jobseqid,process,&amp;quot;正在保存(当前行:&amp;quot;+currow+&amp;quot;),请稍候...&amp;quot;,&amp;quot;run&amp;quot;);//名称为空表示只要更新进度
			}
			
			filename = ds.getStringAt(i,&amp;quot;FILENAME&amp;quot;);
			var filerow = ds.getStringAt(i,&amp;quot;XH&amp;quot;);  //文件行号
			var djh = ds.getStringAt(i,&amp;quot;DJH&amp;quot;);
			var dwbh = ds.getStringAt(i,&amp;quot;DWBH&amp;quot;);
			var dwyhzh = ds.getStringAt(i,&amp;quot;DWZH&amp;quot;);
			var hkrq = ds.getStringAt(i,&amp;quot;HKRQ&amp;quot;);           
//			var hkrq = pub.EAFunc.Replace(hpdat,&amp;quot;-&amp;quot;,&amp;quot;&amp;quot;); //2017-01-18修改为界面传入的回盘入日期  20170310 lyh modify 修改为要文件回盘日期
			var hkbz = ds.getStringAt(i,&amp;quot;HKBZ&amp;quot;);

			//获取回款标志信息
			sql = &amp;quot;select aaa103 from aa10 b where b.aaa100=&amp;apos;BAZ901&amp;apos; and aaa102 = &amp;apos;&amp;quot;+hkbz+&amp;quot;&amp;apos;&amp;quot;;
			var hkxx = db.GetSQL(sql);
			
			var BAZ610 = &amp;quot;&amp;quot;;
			var AAA027 = &amp;quot;&amp;quot;;
			var BAZ901 = &amp;quot;&amp;quot;;
			var BAZ902 = &amp;quot;&amp;quot;;
			var BAC004 = &amp;quot;&amp;quot;;
			var BAE415 = &amp;quot;&amp;quot;;
			var AAE076 = &amp;quot;&amp;quot;;
			var BAE036 = &amp;quot;&amp;quot;;
			var AIC263 = 0.00;
			var BAE419 = &amp;quot;&amp;quot;;
			var AAB034 = &amp;quot;&amp;quot;;
			var BAC003 = &amp;quot;&amp;quot;;
			var BAE421 = &amp;quot;&amp;quot;;
			
			//20170310 lyh modify 多险种统一征收，会存在多行数据行，失败的数据已经作废了单据，再查询数据就会出现查询不到数据
			sql = &amp;quot;select a.AAA027,a.AAB034 ,a.BAZ901,a.BAZ902,a.BAC004,a.BAE415,a.AAE076,a.BAE036,sum(a.aic263) AIC263,a.BAC003,a.BAE419,a.bae421 BAE421
				from ac95 a where zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and aaa027=&amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and AAB001=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos; and BAE074=&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and zfbz!=&amp;apos;1&amp;apos;
				group by a.AAA027,a.AAB034 ,a.BAZ901,a.BAZ902,a.BAC004,a.BAE415,a.AAE076,a.BAE036 ,a.BAC003,a.BAE419,a.bae421&amp;quot;;
			var tmpds = db.QuerySQL(sql);	
//			if (tmpds.getRowCount() &amp;lt;= 0) {
//				db.Rollback();
//				notify(jobseqid,100,&amp;quot;保存回盘失败！查询不到业务数据，行号:&amp;quot;+filerow+&amp;quot;单据号:&amp;quot;+djh+&amp;quot;dwbh=&amp;quot;+dwbh+sql,&amp;quot;end&amp;quot;);	
//				return &amp;quot;保存回盘失败！查询不到业务数据，行号:&amp;quot;+filerow+&amp;quot;单据号:&amp;quot;+djh+&amp;quot;dwbh=&amp;quot;+dwbh;
//			}
//			else 
			if (tmpds.getRowCount() &amp;gt; 0) {
				//调用接口（银海、东软）通知业务 (一笔明细调用一次接口）
				//BAZ610 = tmpds.getStringAt(0,&amp;quot;BAZ610&amp;quot;); //业务内部序号
				AAA027 = tmpds.getStringAt(0,&amp;quot;AAA027&amp;quot;); //所属统筹区
				AAB034 = tmpds.getStringAt(0,&amp;quot;AAB034&amp;quot;); //所属统筹区
				BAZ901 = tmpds.getStringAt(0,&amp;quot;BAZ901&amp;quot;); //回盘结果状态码
				BAZ902 = tmpds.getStringAt(0,&amp;quot;BAZ902&amp;quot;); //回盘结果失败原因
				BAC004 = tmpds.getStringAt(0,&amp;quot;BAC004&amp;quot;); //回盘时间
				BAE415 = tmpds.getStringAt(0,&amp;quot;BAE415&amp;quot;); //发放批次
				AAE076 = tmpds.getStringAt(0,&amp;quot;AAE076&amp;quot;); //财务流水号
				BAE036 = tmpds.getStringAt(0,&amp;quot;BAE036&amp;quot;); //回盘时间
				AIC263 = tmpds.getStringAt(0,&amp;quot;AIC263&amp;quot;); //总金额
				BAE419 = tmpds.getStringAt(0,&amp;quot;BAE419&amp;quot;); //银行种类
				BAC003 = tmpds.getStringAt(0,&amp;quot;BAC003&amp;quot;); //回盘文件名
				BAE421 = tmpds.getStringAt(0,&amp;quot;BAE421&amp;quot;); //报盘流水号
				
				//是否启用银社直连判断
				if (yszlCheck == 0) {
					yszlCheck = 1;
					var sipub = new SBCW_PUBFUNC();
					var chkret = sipub.checkYSZLStatusByYH(db,sbh,zth,BAE419);
					if (chkret != &amp;quot;0&amp;quot;) { //已启用
						if (chkret != &amp;quot;&amp;quot;) {
							var rst = 1*db.GetSQL(&amp;quot;select to_date(&amp;apos;&amp;quot;+hpdat+&amp;quot;&amp;apos;,&amp;apos;yyyy-mm-dd&amp;apos;) - to_date(&amp;apos;&amp;quot;+chkret+&amp;quot;&amp;apos;,&amp;apos;yyyy-mm-dd&amp;apos;) from dual&amp;quot;);
							if (rst &amp;gt;= 0) {
								var yhmc = db.GetSQL(&amp;quot;select fullname from V_CW_YHZL_ZJ where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and id=&amp;apos;&amp;quot;+BAE419+&amp;quot;&amp;apos;&amp;quot;);
								notify(jobseqid,100,&amp;quot;保存回盘失败！【&amp;quot;+yhmc+&amp;quot;】社银直连已启用，请到社银直连模块操作！出错行号:&amp;quot;+filerow+&amp;quot;.&amp;quot;,&amp;quot;end&amp;quot;);
								return &amp;quot;保存回盘失败！【&amp;quot;+yhmc+&amp;quot;】社银直连已启用，请到社银直连模块操作！&amp;quot;;
							}											
						}
					}
				}
				
				//判断是否已经回盘 回盘文件名与导入文件名相同则视为已经回盘
				var rapSql = &amp;quot;SELECT nvl(instrb(&amp;apos;&amp;quot;+BAC003+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+filename+&amp;quot;&amp;apos;),0) repLen FROM dual&amp;quot;;
				var repLen = db.GetSQL(rapSql);
				if(repLen &amp;gt; 0 || AAE076 != &amp;quot;&amp;quot;){
					//db.Rollback();
					//notify(jobseqid,100,&amp;quot;出错行号:&amp;quot;+filerow+&amp;quot;单据号:&amp;quot;+djh+&amp;quot;已经入账,不允许回盘!hkbz=&amp;quot;+hkbz,&amp;quot;end&amp;quot;); 
					//return &amp;quot;文件名:&amp;quot;+filename+&amp;quot;已经回盘过,不允许再回盘!hkbz=&amp;quot;+hkbz;
					notify(jobseqid,process,&amp;quot;行号:&amp;quot;+filerow+&amp;quot;单据号:&amp;quot;+djh+&amp;quot;已经回盘入账,忽略!hkbz=&amp;quot;+hkbz,&amp;quot;end&amp;quot;);							
				}
				else {							
					//失败					
					if (hkbz &amp;gt;= 3) {	
						failecnt++;			
						//更新回盘信息
						sql = &amp;quot;update ac95 set BAZ901=&amp;apos;&amp;quot;+hkbz+&amp;quot;&amp;apos;,BAZ902=&amp;apos;&amp;quot;+hkxx+&amp;quot;&amp;apos;,BAC004=to_date(&amp;apos;&amp;quot;+hpdat+&amp;quot;&amp;apos;,&amp;apos;yyyy-mm-dd&amp;apos;),BAC003=&amp;apos;&amp;quot;+filename+&amp;quot;&amp;apos;,BAE011=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,BAE036=sysdate ,bie085 = &amp;apos;2&amp;apos;,zfbz = &amp;apos;1&amp;apos;
							where zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and aaa027=&amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and AAB001=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos; and BAE074=&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and zfbz!=&amp;apos;1&amp;apos;&amp;quot;;			
						var upcnt = db.ExcecutSQL(sql);
						if (upcnt == 0) {
							db.Rollback();
							notify(jobseqid,100,&amp;quot;更新回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+filerow,&amp;quot;end&amp;quot;);
							return &amp;quot;更新回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+filerow+&amp;quot;.\n&amp;quot;;
						}
						
						if(ywjkbz == &amp;quot;YH&amp;quot;) {
							sql = &amp;quot;update v_si_djb_tmp set zfbz = 1,zbr=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,zfsj=sysdate,cwbz=0
								where dwbh=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos; and djh = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and sbh =&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth =&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and zfbz!=&amp;apos;1&amp;apos;&amp;quot;;
							var upcntrow = db.ExcecutSQL(sql);
							if (upcntrow == 0) {
								db.Rollback();
								notify(jobseqid,100,&amp;quot;更新SI_DJB_TMP回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+filerow+&amp;quot;.&amp;quot;,&amp;quot;end&amp;quot;);
								return &amp;quot;更新SI_DJB_TMP回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+filerow+&amp;quot;.&amp;quot;;
							} 
						}	

						//   PROCEDURE prc_p_PayInterface(
						//      prm_aaz288      IN     VARCHAR2    ,  -- 征集通知ID（业务单据号=中间表DJH）
						//      prm_AAD016      IN     VARCHAR2    ,  -- 缴费方式  &amp;apos;1&amp;apos; 托收  &amp;apos;2&amp;apos; 银行缴费  &amp;apos;3&amp;apos; 转账  &amp;apos;4&amp;apos; 其他 
						//      prm_yad003      IN     NUMBER      ,  -- 缴费金额
						//      prm_AAD017      IN     DATE        ,  -- 缴费日期
						//      prm_BAZ901      IN     VARCHAR2    ,  -- 回盘结果   缴费方式为 1 时填写
						//      prm_BAZ902      IN     VARCHAR2    ,  -- 回盘失败原因  缴费方式为 1 时填写
						//      prm_aae011      IN     VARCHAR2    ,  -- 经办人
						//      prm_yab003      IN     VARCHAR2    ,  -- 经办所属机构
						//      prm_AppCode     OUT    VARCHAR2    ,  -- 错误代码
						//      prm_ErrorMsg    OUT    VARCHAR2       -- 错误内容
						//      );
						//调用业务接口
						var aad016 = &amp;quot;&amp;quot;;
						if (ywjkbz == &amp;quot;DR&amp;quot;) {
							aad016 = &amp;quot;BPHT&amp;quot;;
						}
						else if (ywjkbz == &amp;quot;YH&amp;quot;){
							aad016 = &amp;quot;1&amp;quot;;
						}
					
						var yhjk_msg = yh_ywjk.yhjk_PayInterface(db,djh,aad016,AIC263,hkrq,hkbz,hkxx,czyxm,AAB034 ,thisorgid ,thisaccid,ywjkbz,BAE421,&amp;quot;&amp;quot;,&amp;quot;&amp;quot;);
						var ret = yhjk_msg.split(&amp;quot;@&amp;quot;)[0];
						var retmes = yhjk_msg.split(&amp;quot;@&amp;quot;)[1];
						if (ret != &amp;quot;NOERROR&amp;quot;) {
							db.Rollback();
							notify(jobseqid,100,&amp;quot;调用业务接口出错！出错行号:&amp;quot;+filerow+&amp;quot;单据号:&amp;quot;+djh+&amp;quot;;出错原因:&amp;quot;+retmes,&amp;quot;end&amp;quot;);
							return &amp;quot;调用业务接口出错！出错行号:&amp;quot;+filerow+&amp;quot;单据号:&amp;quot;+djh+&amp;quot;;出错原因:&amp;quot;+retmes+&amp;quot;.&amp;quot;;
						}
			
					}
					//成功
					else if (hkbz == 0) {
						succnt ++;
						//获取科目编号
						sql = &amp;quot;SELECT yhmc FROM cw_dfdsb WHERE sbh = &amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND szbz =&amp;apos;1&amp;apos; AND yhbm = &amp;apos;&amp;quot;+BAE419+&amp;quot;&amp;apos;&amp;quot;;
						var yhmc = db.GetSQL(sql);

						sql = &amp;quot;SELECT nvl(max(kmbh),&amp;apos;NULL&amp;apos;) FROM CW_BKDYHB WHERE SBH = &amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND BZ = &amp;apos;12&amp;apos; AND (MRTSTZYHBZ = &amp;apos;217&amp;apos; or MRTSTZYHBZ = &amp;apos;218&amp;apos;)
							AND YHZL IN (SELECT YHBM FROM CW_DFDSB WHERE SBH = &amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND YHZL = &amp;apos;&amp;quot;+BAE419+&amp;quot;&amp;apos; AND SZBZ = &amp;apos;2&amp;apos; AND YHBM &amp;lt;&amp;gt; &amp;apos;*&amp;apos;) &amp;quot;;
						var kmbh = db.GetSQL(sql);
						if(kmbh == &amp;quot;NULL&amp;quot;){
							sql = &amp;quot;SELECT nvl(max(kmbh),&amp;apos;NULL&amp;apos;) FROM CW_BKDYHB WHERE SBH = &amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND BZ = &amp;apos;12&amp;apos; AND (MRTSTZYHBZ = &amp;apos;227&amp;apos; or MRTSTZYHBZ = &amp;apos;228&amp;apos;)
								AND YHZL IN (SELECT YHBM FROM CW_DFDSB WHERE SBH = &amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND YHZL = &amp;apos;&amp;quot;+BAE419+&amp;quot;&amp;apos; AND SZBZ = &amp;apos;2&amp;apos; AND YHBM &amp;lt;&amp;gt; &amp;apos;*&amp;apos;)&amp;quot;;								
							kmbh = db.GetSQL(sql);	
							if(kmbh == &amp;quot;NULL&amp;quot;) {								
								db.Rollback();
								notify(jobseqid,100,&amp;quot;查询无此银行科目,请到[账务管理-&amp;gt;账务维护-&amp;gt;银行帐号设置]&amp;quot;+&amp;quot;\n&amp;quot;+&amp;quot;请检查[&amp;quot;+yhmc+&amp;quot;]社保基金收入户是否设置为统一征收银行或者本行征收银行!!!!!!&amp;quot;,&amp;quot;end&amp;quot;);
								return &amp;quot;查询无此银行科目,请到[账务管理-&amp;gt;账务维护-&amp;gt;银行帐号设置]&amp;quot;+&amp;quot;\n&amp;quot;+&amp;quot;请检查[&amp;quot;+yhmc+&amp;quot;]社保基金收入户是否设置为统一征收银行或者本行征收银行!!!!!!&amp;quot;;
							}	
						}
						
						sql = &amp;quot;select count(1) from cw_kmb WHERE sbh = &amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND kmbh = &amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos; and yhzl = &amp;apos;&amp;quot;+BAE419+&amp;quot;&amp;apos;&amp;quot;;
						var km_count = db.GetSQL(sql);
						if(km_count == 0){
							db.Rollback();
							notify(jobseqid,100,&amp;quot;查询无此科目，科目编号：&amp;quot;+kmbh+&amp;quot;银行种类：&amp;quot;+BAE419,&amp;quot;end&amp;quot;);
							return &amp;quot;查询无此科目，科目编号：&amp;quot;+kmbh+&amp;quot;银行种类：&amp;quot;+BAE419;
						}

						//获取顺序号
						sql = &amp;quot;select nvl(max(sxh),0) + 1 sxh,nvl(max(pch),0) + 1 pch from cw_rjzb where sbh = &amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; AND kmbh = &amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos; 
							and yy = substrb(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,1,4) and mm = substrb(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,5,2)&amp;quot;;								
						var sxh_ds = db.QuerySQL(sql);	
						var sxh = sxh_ds.getStringAt(0,&amp;quot;sxh&amp;quot;);
						if(pch == &amp;quot;&amp;quot;){
						    pch = sxh_ds.getStringAt(0,&amp;quot;pch&amp;quot;);	
						}

						//获取社保流水号
						var sblsh = service.genSiSeq(tcqbm);
						var yhrjzsxh = db.GetSQL(&amp;quot;select nvl(max(sxh),0)+1 from cw_yhrjzb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and yy=substrb(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,1,4) and mm=substrb(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,5,2) and KMBH=&amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos;&amp;quot;);
						var yhrjzid = db.GetSQL(&amp;quot;select seq_yhrjzb_id.nextval from dual&amp;quot;);
						//获取主体类型及业务回退接口
						sql = &amp;quot;SELECT DECODE(&amp;apos;&amp;quot;+ywjkbz+&amp;quot;&amp;apos;,&amp;apos;YH&amp;apos;,YWXT_YHDM,&amp;apos;DR&amp;apos;,YWXT_DRDM,&amp;apos;&amp;quot;+ywjkbz+&amp;quot;&amp;apos;) ywhtjk,nvl(ztlx,1) ztlx FROM AA10 WHERE AAA100 = &amp;apos;YWLX&amp;apos; AND AAA102 = &amp;apos;A110&amp;apos;&amp;quot;;
						var ds = db.QuerySQL(sql);
						var ywhtjk = ds.getStringAt(0,&amp;quot;ywhtjk&amp;quot;);

						//插入银行日记账表
						sql = &amp;quot;insert into cw_yhrjzb(id,sbh,zth,YY,MM,DD,CWPCH,PZH,ZY,JE,JEFX,YEFX,YE,SISEQNO,DJH,YWPCH,ZTLX,ZTBH,ZTMC,KMBH,CZYXM,CZYSJ,JSFS,yspz_fjzs,yspz_fjpch,yspz_lrrq,DYYWJK_LX,sxh,fkbz )
						      select &amp;apos;&amp;quot;+yhrjzid+&amp;quot;&amp;apos;,sbh,zth,substrb(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,1,4) yy,substrb(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,5,2) mm,substrb(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,7,2) dd,&amp;apos;&amp;quot;+pch+&amp;quot;&amp;apos;,&amp;apos;&amp;apos;,max(zy) zy,sum(je1+je2+je3+je4+je5+je6+je7+je8+je9+je10+je11+je12+je13+je14+je15) je,
						      		&amp;apos;借&amp;apos; jefx,&amp;apos;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos; siseqno,djh,nvl(pch,zjpch) ywpch,&amp;apos;1&amp;apos;,dwbh,dwmc,&amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,sysdate,&amp;apos;电子托收&amp;apos; jsfs,&amp;apos;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;quot;+ywhtjk+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yhrjzsxh+&amp;quot;&amp;apos;,&amp;apos;2&amp;apos;
						        from v_si_djb_tmp 
						       where DJH = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;
							 AND YWLX = &amp;apos;A110&amp;apos;
							 and dwbh = &amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;
							 AND SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;
							 and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
							 AND RZBZ = 0
							 AND ZFBZ = 0
							group by sbh,zth,nvl(pch,zjpch),djh,dwbh,dwmc&amp;quot;;								   
						db.ExcecutSQL(sql);
						
						//20161223 lyh add 回盘导入插入单位表 //20170223处理更新语句报错：单行子查询返回多个行
						sql = &amp;quot;select count(1) from si_dwb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and dwbh = &amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;&amp;quot;;
						var dwcout = db.GetSQL(sql);
						if(dwcout == 0){
							sql = &amp;quot;insert into si_dwb(sbh,zth,dwbh,dwmc,dwjc,dwlxbh,org,acc,ywdwbh)
								select distinct sbh,zth,dwbh,dwmc,dwmc dwjc,nvl(max(dwlxbh),&amp;apos;0&amp;apos;) dwlxbh,org,acc,dwbh 
								  from V_SI_DJB_TMP WHERE DJH = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; AND YWLX = &amp;apos;A110&amp;apos; and dwbh = &amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos; AND SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
								  group by sbh,zth,dwbh,dwmc,org,acc&amp;quot;;
							db.ExcecutSQL(sql);
						}else{
							sql = &amp;quot;update si_dwb set (dwmc,dwjc,dwlxbh) = (select distinct dwmc,dwmc dwjc,nvl(max(dwlxbh),&amp;apos;0&amp;apos;) dwlxbh 
								  	from V_SI_DJB_TMP where DJH = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; AND YWLX = &amp;apos;A110&amp;apos; and dwbh = &amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos; AND SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
								  	group by dwmc) 
								where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and dwbh = &amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;&amp;quot;;
							db.ExcecutSQL(sql);
						}
						
						//notify(jobseqid,20,&amp;quot;1插入日记账表&amp;quot;+djh ,&amp;quot;run&amp;quot;);
						//获取流水号
						var lsh = db.GetSQL(&amp;quot;SELECT seq_rjz_lsh.NEXTVAL FROM dual&amp;quot;);
						//notify(jobseqid,20,&amp;quot;2插入日记账表&amp;quot;+djh+&amp;quot;:&amp;quot;+dwbh+&amp;quot;:&amp;quot;+sbh+&amp;quot;:&amp;quot;+zth ,&amp;quot;run&amp;quot;);
						//插入日记账表
						sql = &amp;quot;insert into cw_rjzb(sbh,zth,org,acc,lsh,yy,mm,dd,sxh,czyxm,pch,djh,old_pch,zy,kmbh,lxbh,dwbh,dwmc,je,jefx,jsfs,yspz_fjzs,yspz_fjpch,yspz_lrrq,czysj,mkjmbz,siseqno)
							select sbh,zth,org,acc,&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos; lsh,substrb(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,1,4) yy,substrb(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,5,2) mm,substrb(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,7,2) dd,&amp;apos;&amp;quot;+sxh+&amp;quot;&amp;apos; sxh,
							       &amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos; zbr,&amp;apos;&amp;quot;+pch+&amp;quot;&amp;apos; pch,djh,nvl(pch,zjpch) old_pch,max(zy) zy,&amp;apos;&amp;quot;+kmbh+&amp;quot;&amp;apos; kmbh,
							       replace(to_char(wm_concat(distinct lxbh)),&amp;apos;,&amp;apos;,&amp;apos;&amp;apos;) lxbh,dwbh,dwmc,
							       sum(je1+je2+je3+je4+je5+je6+je7+je8+je9+je10+je11+je12+je13+je14+je15) je,&amp;apos;借&amp;apos; jefx,&amp;apos;电子托收&amp;apos; jsfs,&amp;apos;&amp;apos; yspz_fjzs,&amp;apos;&amp;apos; yspz_fjpch,null yspz_lrrq,sysdate,&amp;apos;4&amp;apos; mkjmbz,&amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos; siseqno
							  from v_si_djb_tmp 
							 where DJH = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;
							   AND YWLX = &amp;apos;A110&amp;apos;
							   and dwbh = &amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;
							   AND SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;
							   and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
							   AND RZBZ = 0
							   AND ZFBZ = 0
							GROUP BY sbh,zth,org,acc,nvl(pch,zjpch),djh,dwbh,dwmc,djh&amp;quot;;
						//throw new Exception(sql);																
						db.ExcecutSQL(sql); 
						
						//notify(jobseqid,20,&amp;quot;3插入日记账明细表&amp;quot;+djh ,&amp;quot;run&amp;quot;);
						//插入明细表														
						sql = &amp;quot;SELECT  lxbh lxbh,
								NVL(JE1,0.00) JE1,
							       NVL(JE2,0.00) JE2,
							       NVL(JE3,0.00) JE3,
							       NVL(JE4,0.00) JE4,
							       NVL(JE5,0.00) JE5,
							       NVL(JE6,0.00) JE6,
							       NVL(JE7,0.00) JE7,
							       NVL(JE8,0.00) JE8,
							       NVL(JE9,0.00) JE9,
							       NVL(JE10,0.00) JE10,
							       NVL(JE11,0.00) JE11,
							       NVL(JE12,0.00) JE12,
							       NVL(JE13,0.00) JE13,
							       NVL(JE14,0.00) JE14,
							       NVL(JE15,0.00) JE15,
							       ym1 ym1,
							       ym2 ym2,
							       AAE140
							  FROM V_SI_DJB_TMP
							 WHERE DJH = &amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos;
							   and dwbh = &amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;
							   AND YWLX = &amp;apos;A110&amp;apos;
							   AND SBH = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;
							   AND ZTH = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
							   AND RZBZ = 0
							   AND ZFBZ = 0&amp;quot;;
						var rjzmx_ds = db.QuerySQL(sql);
						var mxxh = 0;	
						if(rjzmx_ds.getRowCount() == 0){
							db.Rollback();
							notify(jobseqid,100,&amp;quot;插入日记账明细表出错!&amp;quot;+sql,&amp;quot;end&amp;quot;);
							return &amp;quot;插入日记账明细表出错!&amp;quot;+sql;
						}
						
						//notify(jobseqid,20,&amp;quot;正在生成明细账&amp;quot;+djh ,&amp;quot;run&amp;quot;);
						for(var i = 0;i&amp;lt;rjzmx_ds.getRowCount();i++ ){
							var lxbh = rjzmx_ds.getStringAt(i,&amp;quot;lxbh&amp;quot;);
							var ym1 = rjzmx_ds.getStringAt(i,&amp;quot;ym1&amp;quot;);
							var ym2 = rjzmx_ds.getStringAt(i,&amp;quot;ym2&amp;quot;);
							for(var k = 1;k&amp;lt;15;k++){
								var je = rjzmx_ds.getStringAt(i,&amp;quot;JE&amp;quot;+k);	
								var lxxh = k;				
								if (je != &amp;quot;0&amp;quot; &amp;&amp; je != &amp;quot;0.00&amp;quot; &amp;&amp; je != &amp;quot;&amp;quot;) {
									mxxh ++;										
									sql = &amp;quot;insert into cw_rjzmxb(sbh,zth,org,acc,lsh,mxxh,kmbh,lxbh,lxxh,ym1,ym2,je,jefx)values(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;,
											&amp;apos;&amp;quot;+mxxh+&amp;quot;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;quot;+lxbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lxxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ym1+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ym2+&amp;quot;&amp;apos;,&amp;quot;+je+&amp;quot;,&amp;apos;借&amp;apos;)&amp;quot;;
									db.ExcecutSQL(sql);
								}
							}
						}
						
						//notify(jobseqid,20,&amp;quot;第&amp;quot;+rowcnt+&amp;quot;行，正在更新AC95表；&amp;quot;+dwbh+&amp;quot;-&amp;quot;+djh+&amp;quot;-&amp;quot;+zth ,&amp;quot;run&amp;quot;);								
						//更新回盘信息
						sql = &amp;quot;update ac95 set BAZ901=&amp;apos;&amp;quot;+hkbz+&amp;quot;&amp;apos;,BAZ902=&amp;apos;&amp;quot;+hkxx+&amp;quot;&amp;apos;,BAC004=to_date(&amp;apos;&amp;quot;+hpdat+&amp;quot;&amp;apos;,&amp;apos;yyyy-mm-dd&amp;apos;),BAC003=&amp;apos;&amp;quot;+filename+&amp;quot;&amp;apos;,BAE011=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,BAE036=sysdate ,AAE076 = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;
							where zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and aaa027=&amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and AAB001=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;and BAE074=&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and zfbz!=&amp;apos;1&amp;apos;&amp;quot;;			
						var upcnt = db.ExcecutSQL(sql);
						if (upcnt == 0) {
							db.Rollback();
							notify(jobseqid,100,&amp;quot;更新AC95回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+filerow+&amp;quot;.&amp;quot;,&amp;quot;end&amp;quot;);
							return &amp;quot;更新AC95回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+filerow;
						}
						
						//notify(jobseqid,20,&amp;quot;第&amp;quot;+rowcnt+&amp;quot;行，正在更新si_djb_tmp表；&amp;quot;+dwbh+&amp;quot;-&amp;quot;+djh+&amp;quot;-&amp;quot;+zth ,&amp;quot;run&amp;quot;);
						//更新si_djb_tmp
						sql = &amp;quot;update v_si_djb_tmp set rzbz = &amp;apos;1&amp;apos;,rzr=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,rzsj =to_date(&amp;apos;&amp;quot;+hkrq+&amp;quot;&amp;apos;,&amp;apos;yyyy-mm-dd&amp;apos;),lsh = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;
							where dwbh=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos; and djh=&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and zfbz!=&amp;apos;1&amp;apos;&amp;quot;;
						var upcntrow = db.ExcecutSQL(sql);
						if (upcntrow == 0) {
							db.Rollback();
							notify(jobseqid,100,&amp;quot;更新SI_DJB_TMP回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+filerow+&amp;quot;.&amp;quot;,&amp;quot;end&amp;quot;);
							return &amp;quot;更新SI_DJB_TMP回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+filerow;
						} 
						//调用业务接口
						var aad016 = &amp;quot;&amp;quot;;
						if (ywjkbz == &amp;quot;DR&amp;quot;) {
							aad016 = &amp;quot;DEDZ&amp;quot;;
						}
						else if(ywjkbz == &amp;quot;YH&amp;quot;) {
							aad016 = &amp;quot;1&amp;quot;;
						}													
						
						//notify(jobseqid,20,&amp;quot;第&amp;quot;+rowcnt+&amp;quot;行，正在调用业务接口；&amp;quot;+dwbh+&amp;quot;-&amp;quot;+djh+&amp;quot;-&amp;quot;+zth ,&amp;quot;run&amp;quot;);
						var yhjk_msg = yh_ywjk.yhjk_PayInterface(db,djh,aad016,AIC263,hkrq,hkbz,hkxx,czyxm,AAA027,thisorgid ,thisaccid ,ywjkbz,sblsh,&amp;quot;&amp;quot;,kmbh);
						var ret = yhjk_msg.split(&amp;quot;@&amp;quot;)[0];
						var retmes = yhjk_msg.split(&amp;quot;@&amp;quot;)[1];
						if (ret != &amp;quot;NOERROR&amp;quot;) {
							db.Rollback();
							notify(jobseqid,100,&amp;quot;调用业务接口prc_p_PayInterface出错！出错行号:&amp;quot;+filerow+&amp;quot;单据号:&amp;quot;+djh+&amp;quot;;出错原因:&amp;quot;+retmes,&amp;quot;end&amp;quot;);
							return &amp;quot;调用业务接口prc_p_PayInterface出错！出错行号:&amp;quot;+filerow+&amp;quot;单据号:&amp;quot;+djh+&amp;quot;;出错原因:&amp;quot;+retmes+&amp;quot;.\n&amp;quot;;
						}
				
					}
					else if (hkbz == 1 || hkbz == 2) {
						failecnt ++;
						//判断文件名 补托回盘文件名 例如 return_bt_161010_GSDS161010.txt					
						//更新回盘信息
						sql = &amp;quot;update ac95 set BAZ901=&amp;apos;&amp;quot;+hkbz+&amp;quot;&amp;apos;,BAZ902=&amp;apos;&amp;quot;+hkxx+&amp;quot;&amp;apos;,BAC004=to_date(&amp;apos;&amp;quot;+hpdat+&amp;quot;&amp;apos;,&amp;apos;yyyy-mm-dd&amp;apos;),BAC003=&amp;apos;&amp;quot;+filename+&amp;quot;&amp;apos;,BAE011=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,BAE036=sysdate 
							where zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and aaa027=&amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and AAB001=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos; and BAE074=&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and zfbz!=&amp;apos;1&amp;apos;&amp;quot;;			
						var upcnt = db.ExcecutSQL(sql);
						if (upcnt == 0) {
							db.Rollback();
							notify(jobseqid,100,&amp;quot;更新回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+filerow+&amp;quot;.&amp;quot;,&amp;quot;end&amp;quot;);
							return &amp;quot;更新回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+filerow;
						}					
					}
					else {
						failecnt ++;
						db.Rollback();
						notify(jobseqid,100,&amp;quot;出错行号:&amp;quot;+filerow+&amp;quot;单据号:&amp;quot;+djh+&amp;quot;;回款标志出错！hkbz=&amp;quot;+hkbz,&amp;quot;end&amp;quot;);
						return &amp;quot;出错行号:&amp;quot;+filerow+&amp;quot;单据号:&amp;quot;+djh+&amp;quot;;回款标志出错！hkbz=&amp;quot;+hkbz;
					}//end hkbz
				
				}
			} //end tmpds.getRowCount()				
			djh_old = djh;
			dwbh_old = dwbh;
		} //end ds
		
		//return jkret;
		if (notify(jobseqid,100,&amp;quot;保存征收回盘数据成功！\n回盘文件：&amp;quot;+filename+&amp;quot;\n总笔数：&amp;quot;+zbs+&amp;quot;\n成功笔数：&amp;quot;+succnt+&amp;quot;\n失败笔数：&amp;quot;+failecnt+&amp;quot;。&amp;quot;,&amp;quot;end&amp;quot;)==&amp;quot;ERROR&amp;quot;) throw new Exception ( &amp;quot;进程已经中断&amp;quot; );
		
		db.Commit();
//		db.Rollback();
//		throw new Exception(&amp;quot;调试测试中...&amp;quot;);

		return &amp;quot;保存征收回盘数据成功！\n回盘文件：&amp;quot;+filename+&amp;quot;\n总笔数：&amp;quot;+zbs+&amp;quot;\n成功笔数：&amp;quot;+succnt+&amp;quot;\n失败笔数：&amp;quot;+failecnt+&amp;quot;。&amp;quot;;
	}
	catch (e) {
		notify(jobseqid,100,&amp;quot;保存征收回盘失败！&amp;quot;+e.toString(),&amp;quot;error&amp;quot;);
		if (db != null) db.Rollback();
		return &amp;quot;保存征收回盘失败！&amp;quot;+e.toString();
	}
	finally {
		if (db != null) db.Close();
	}
}



//回盘加入进度条提示实现 
function genbatch()
{
	var db = null;
	var jobseqid = jobid;
	try {
		//db = new pub.EADatabase();	// 如果连接到其他数据库, new pubpack.EADatabase(“dbname”)
		
		var tim = new timepack.EARunOSTimer(); 
		tim.init(jobseqid,jobnam,&amp;quot;SBCW&amp;quot;,&amp;quot;RJZ_ZSRETURN&amp;quot;,&amp;quot;SaveYHZSHP&amp;quot;,&amp;quot;jobid=&amp;quot;+jobid+&amp;quot;&amp;thisorgid=&amp;quot;+thisorgid+&amp;quot;&amp;jobseqid=&amp;quot;+jobseqid 
			+&amp;quot;&amp;thisaccid=&amp;quot;+thisaccid+&amp;quot;&amp;hpdat=&amp;quot;+hpdat+&amp;quot;&amp;zth=&amp;quot;+zth+&amp;quot;&amp;usrid=&amp;quot;+usrid+&amp;quot;&amp;czyxm=&amp;quot;+czyxm);
	}
	catch ( ee ) {
		throw new pub.EAException ( ee.toString() );
	}
	finally {
		if (db!=null) db.Close();
	}
	return jobseqid  ;// 返回后台分配的作业编号

}
// 通知外部当前的运行情况
function notify(jobseqid,percent,note,stat)
{
	var db = null;
	if ( percent &amp;lt; 0 ) return &amp;quot;&amp;quot;;
	try{
		db = new pub.EADatabase();
		note = pub.EAFunc.Replace( note, &amp;quot;&amp;apos;&amp;quot;,&amp;quot;‘&amp;quot; );
		if(note==&amp;quot;&amp;quot;){
			db.ExcecutSQL(&amp;quot;update RunOSTimer set percent=&amp;quot;+(percent) +&amp;quot;,stat=&amp;apos;&amp;quot;+stat+&amp;quot;&amp;apos; where id=&amp;apos;&amp;quot;+jobseqid+&amp;quot;&amp;apos;&amp;quot;);
		}
		else {
			db.ExcecutSQL(&amp;quot;update RunOSTimer set percent=&amp;quot;+(percent) +&amp;quot;,percentnote=&amp;apos;&amp;quot;+note+&amp;quot;&amp;apos;,stat=&amp;apos;&amp;quot;+stat+&amp;quot;&amp;apos; where id=&amp;apos;&amp;quot;+jobseqid+&amp;quot;&amp;apos;&amp;quot;);
			db.ExcecutSQL(&amp;quot;insert into RunOSTimerDTL(id,name) values(&amp;apos;&amp;quot;+jobseqid+&amp;quot;&amp;apos;,&amp;apos;[ &amp;quot;+percent+&amp;quot;% ]&amp;quot;+note+&amp;quot;&amp;apos;)&amp;quot; );
		}
		db.Commit();
	}
	catch ( e ) {
		pub.EAFunc.Log( e.toString() );
		db.Rollback();
		return &amp;quot;ERROR&amp;quot; ;
	}
	finally {
		if (db!=null) db.Close();
	}
	return &amp;quot;OK&amp;quot;;
}

//检查回盘数据是否有问题
function CheckHPData()
{
	var db = null;
	var result = &amp;quot;&amp;quot;;
	
	try {
		db = new pub.EADatabase();
		var tcqbm = db.GetSQL(&amp;quot;select tcqbm from cw_sbsb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;&amp;quot;);
		
//		var sql = &amp;quot;select count(*) from si_zsyhreturn_temp where jobid=&amp;apos;&amp;quot;+jobid+&amp;quot;&amp;apos; and xmm&amp;lt;&amp;gt;&amp;apos;MMMMMMMMMMMMMMMM&amp;apos;&amp;quot;;
		var sql = &amp;quot;select count(distinct djh) from si_zsyhreturn_temp where jobid=&amp;apos;&amp;quot;+jobid+&amp;quot;&amp;apos; and xmm&amp;lt;&amp;gt;&amp;apos;MMMMMMMMMMMMMMMM&amp;apos;&amp;quot;;
		var fileCount = 1*db.GetSQL(sql); //文件数据总笔数		
//		sql = &amp;quot;select count(*) from ac95 where aaa027=&amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
//			and (bae074,aab001) in (select djh,dwbh from si_zsyhreturn_temp where jobid=&amp;apos;&amp;quot;+jobid+&amp;quot;&amp;apos;)&amp;quot;;
		sql = &amp;quot;select count(distinct bae074) from ac95 where aaa027=&amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
			and (bae074,aab001) in (select djh,dwbh from si_zsyhreturn_temp where jobid=&amp;apos;&amp;quot;+jobid+&amp;quot;&amp;apos;)&amp;quot;;
		var ywCount = 1*db.GetSQL(sql); //单据号+批次号所对应AC95表的总记录数
		
		if (fileCount != ywCount &amp;&amp; chkbs == &amp;quot;1&amp;quot;) {
			return &amp;quot;回盘文件总笔数与业务对应的笔数不一致！文件总笔数:&amp;quot;+fileCount+&amp;quot; 业务笔数:&amp;quot;+ywCount;
		}
		
		//判断总金额
		sql = &amp;quot; select sum(dwj+tfj+grj) sumje from SI_ZSYHRETURN_TEMP where jobid=&amp;apos;&amp;quot;+jobid+&amp;quot;&amp;apos; and xmm&amp;lt;&amp;gt;&amp;apos;MMMMMMMMMMMMMMMM&amp;apos;&amp;quot;;
		var fileSumMny = db.GetSQL(sql); //文件的总金额
		sql = &amp;quot;select sum(aic263) je from ac95 where aaa027=&amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
			and (bae074,aab001) in (select djh,dwbh from si_zsyhreturn_temp where jobid=&amp;apos;&amp;quot;+jobid+&amp;quot;&amp;apos;)&amp;quot;;
		var ywSumMny = db.GetSQL(sql); //业务的总金额
		if (1.0*fileSumMny != 1.0*ywSumMny) {
			return &amp;quot;回盘文件总金额与业务对应的总金额不一致！文件总金额: &amp;quot;+pub.EAFunc.formatMoney(fileSumMny,2)+&amp;quot; 业务总金额: &amp;quot;+pub.EAFunc.formatMoney(ywSumMny,2);
		}
		
//		//检查回盘文件的内容是否与中间表AC95一样
//		sql = &amp;quot;select a.xh,a.grbh,a.dwbh,a.sfzh,a.dfje,a.dfzh,b.AIC263,b.AAE135,b.AAE010  
//			from si_zsyhreturn_temp a,ac95 b
//			where a.jobid=&amp;apos;%s&amp;apos; and b.aaa027=&amp;apos;%s&amp;apos; and b.zth=&amp;apos;%s&amp;apos;
//			  and a.djh=b.bae074 and a.dwbh=b.aab001
//			  and a.xmm&amp;lt;&amp;gt;&amp;apos;MMMMMMMMMMMMMMMM&amp;apos;&amp;quot;.format([jobid,tcqbm,zth]);
//		var chkds = db.QuerySQL(sql);
//		for (var i=0;i&amp;lt;chkds.getRowCount();i++) {
//			var xh = chkds.getStringAt(i,&amp;quot;XH&amp;quot;);			/*文件行号*/
//			var grbh = chkds.getStringAt(i,&amp;quot;GRBH&amp;quot;);		/*文件个人编号*/
//			var dwbh = chkds.getStringAt(i,&amp;quot;DWBH&amp;quot;);		/*文件单位编号*/
//			var sfzh = chkds.getStringAt(i,&amp;quot;SFZH&amp;quot;);		/*文件身份证号*/
//			var dfje = chkds.getStringAt(i,&amp;quot;DFJE&amp;quot;);		/*文件代发金额*/
//			var dfzh = chkds.getStringAt(i,&amp;quot;DFZH&amp;quot;);		/*文件代发帐号*/
//			var aic263 = chkds.getStringAt(i,&amp;quot;AIC263&amp;quot;);	/*AC95代发金额*/
//			var aae135 = chkds.getStringAt(i,&amp;quot;AAE135&amp;quot;);	/*AC95身份证号*/
//			var aae010 = chkds.getStringAt(i,&amp;quot;AAE010&amp;quot;);	/*AC95代发帐号*/
//			
//			if (sfzh != aae135) result += &amp;quot;第&amp;quot;+xh+&amp;quot;行身份证号：&amp;quot;+sfzh+&amp;quot; != &amp;quot;+aae135+&amp;quot;\n&amp;quot;;
//			if (1.0*dfje != 1.0*aic263) result += &amp;quot;第&amp;quot;+xh+&amp;quot;行代发金额：&amp;quot;+dfje+&amp;quot; != &amp;quot;+aic263+&amp;quot;\n&amp;quot;;
//			if (dfzh != aae010) result += &amp;quot;第&amp;quot;+xh+&amp;quot;行代发帐号：&amp;quot;+dfzh+&amp;quot; != &amp;quot;+aae010+&amp;quot;\n&amp;quot;;
//		}
		
		if (result != &amp;quot;&amp;quot;) return result;
		
		return 1;
		
	}
	catch ( e ) {
		db.Rollback();
		return e.toString();
	}
	finally {
		if (db!=null) db.Close();
	}

	return 1;
}


</GRDOSDS_VALUE></ROW>
</ROWSET>
</grdosds><grddscds>
<ROWSET>
<ROW num="0" ><ID >MAIN</ID><NAME ></NAME><DATDSC >select XH,DJH,DWBH,NUM,DWZH,XMM,DWKHHM,KHHM,YYMM,RS,DWJ,TFJ,GRJ,DJRQ,HKRQ,
(select a.hkbz||&amp;apos;-&amp;apos;||aaa103 from aa10 c 
    where c.aaa100=&amp;apos;BAZ901&amp;apos; and c.aaa102=a.hkbz) HKBZ,
(select max(BAC001) from ac95 b 
      where a.dwbh=b.AAB001 and a.djh=b.BAE074 ) kpwjm,
  filename hpwjm 
from SI_ZSYHRETURN_TEMP a
where jobid=&amp;apos;[%JOBID]&amp;apos;
order by xh</DATDSC><C4 >MAIN</C4><C5 ></C5><C6 ></C6><C7 ></C7><C8 ></C8><C9 >MAIN</C9><C10 >MAIN</C10><C11 ></C11><C12 >MAIN</C12><C13 ></C13><C14 ></C14><C15 ></C15><C16 >MAIN</C16><C17 >MAIN</C17></ROW>
<ROW num="1" ><ID >INFODS</ID><NAME ></NAME><DATDSC >select sum(zbs) zbs,sum(dwbs) dwbs,sum(sumje) sumje,
       sum(succbs) succbs,sum(failbs) failbs,
       sum(succje) succje,sum(failje) failje 
from (
select count(distinct djh) zbs,
  count(distinct dwbh) dwbs,
  sum(dwj+tfj+grj) sumje,
      decode(hkbz,&amp;apos;0&amp;apos;,count(distinct djh),0) succbs,
      decode(hkbz,&amp;apos;0&amp;apos;,0,count(distinct djh)) failbs,
       sum(decode(hkbz,&amp;apos;0&amp;apos;,dwj+tfj+grj,0)) succje,
       sum(decode(hkbz,&amp;apos;0&amp;apos;,0,dwj+tfj+grj)) failje
from si_zsyhreturn_temp
where jobid=&amp;apos;[%JOBID]&amp;apos;
  and xmm&amp;lt;&amp;gt;&amp;apos;MMMMMMMMMMMMMMMM&amp;apos;
group by djh,dwbh,hkbz  
)
</DATDSC><C4 ></C4><C5 ></C5><C6 ></C6><C7 ></C7><C8 >INFODS</C8><C9 ></C9><C10 >INFODS</C10><C11 ></C11><C12 ></C12><C13 ></C13><C14 >INFODS</C14><C15 >INFODS</C15><C16 ></C16><C17 ></C17></ROW>
<ROW num="2" ><ID >QueryRunOSTimer</ID><NAME ></NAME><DATDSC >select count(*) from RunOSTimer
where stat=&amp;apos;run&amp;apos; and id=&amp;apos;[%jobseqid]&amp;apos;
</DATDSC><C4 >QueryRunOSTimer</C4><C5 ></C5><C6 ></C6><C7 ></C7><C8 ></C8><C9 ></C9><C10 ></C10><C11 >QueryRunOSTimer</C11><C12 ></C12><C13 ></C13><C14 ></C14><C15 ></C15><C16 ></C16><C17 ></C17></ROW>
<ROW num="3" ><ID >QueryRunOSTimerExist</ID><NAME ></NAME><DATDSC >select count(*) from RunOSTimer
where (stat=&amp;apos;end&amp;apos; or stat=&amp;apos;error&amp;apos;) and id=&amp;apos;[%jobseqid]&amp;apos;

</DATDSC><C4 ></C4><C5 ></C5><C6 ></C6><C7 ></C7><C8 ></C8><C9 ></C9><C10 ></C10><C11 ></C11><C12 ></C12><C13 ></C13><C14 ></C14><C15 ></C15><C16 ></C16><C17 ></C17></ROW>
<ROW num="4" ><ID >TIPSDS</ID><NAME ></NAME><DATDSC >select * from (
select b.name tips,a.percent 
from RunOSTimer a,RunOSTimerDTL b
where a.id=b.id
  and a.id=&amp;apos;[%jobseqid]&amp;apos;
order by b.seqid desc,b.crtdat desc
) 
</DATDSC><C4 ></C4><C5 >TIPSDS</C5><C6 >TIPSDS</C6><C7 >TIPSDS</C7><C8 >TIPSDS</C8><C9 ></C9><C10 ></C10><C11 ></C11><C12 ></C12><C13 >TIPSDS</C13><C14 ></C14><C15 ></C15><C16 ></C16><C17 ></C17></ROW>
</ROWSET>
</grddscds><fldhdr>
<ROWSET>
<ROW num="0" ><BILID >1单据编号</BILID><STAT >0单据状态</STAT><SUBTYP >0子类型</SUBTYP><CORPID >0往来单位编号</CORPID><CORPNAM >0往来单位名称</CORPNAM><LOCID >0仓库|部门编号</LOCID><LOCNAM >0仓库|部门名称</LOCNAM><DAT >0单据日期</DAT><CRTUSR >1录入人</CRTUSR><CRTUSRNAM >0录入人姓名</CRTUSRNAM><CRTDAT >0录入日期</CRTDAT><CHKUSR >1审核人</CHKUSR><CHKUSRNAM >0审核人姓名</CHKUSRNAM><CHKDAT >0审核日期</CHKDAT><SUMQTY >0合计金额</SUMQTY><SUMMNY >0合计金额</SUMMNY><REFID1 >0扩展字段</REFID1><REFNAM1 >0扩展字段</REFNAM1><REFID2 >0扩展字段</REFID2><REFNAM2 >0扩展字段</REFNAM2><REFID3 >0扩展字段</REFID3><REFNAM3 >0扩展字段</REFNAM3><REFID4 >0扩展字段</REFID4><REFNAM4 >0扩展字段</REFNAM4><REFID5 >0扩展字段</REFID5><REFNAM5 >0扩展字段</REFNAM5><REFID6 >0扩展字段</REFID6><REFNAM6 >0扩展字段</REFNAM6><NOTE >0备注</NOTE></ROW>
</ROWSET>
</fldhdr><flddtl>
<ROWSET>
<ROW num="0" ><SEQID >1明细序号</SEQID><ITMID >1品种编号</ITMID><ITMNAM >0品种名称</ITMNAM><ITEMPC >0品种批次号</ITEMPC><ITMSPC >0规格</ITMSPC><UNIT >0计量单位</UNIT><SMLUNT >0小计量单位</SMLUNT><UNTNUM >0大单位转小单位因子</UNTNUM><PRICE >0价格</PRICE><QTY >0数量</QTY><TAXTYP >0税率类型</TAXTYP><NOTAXMNY >0不含税税额</NOTAXMNY><TAXMNY >0税额</TAXMNY><MNY >0下单金额</MNY><REFID1 >0扩展字段</REFID1><REFNAM1 >0扩展字段</REFNAM1><REFID2 >0扩展字段</REFID2><REFNAM2 >0扩展字段</REFNAM2><REFID3 >0扩展字段</REFID3><REFNAM3 >0扩展字段</REFNAM3><REFID4 >0扩展字段</REFID4><REFNAM4 >0扩展字段</REFNAM4><REFID5 >0扩展字段</REFID5><REFNAM5 >0扩展字段</REFNAM5></ROW>
</ROWSET>
</flddtl></mdroot>