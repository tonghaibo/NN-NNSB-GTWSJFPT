<?xml version='1.0' encoding='GBK'?><mdroot><grdds>
<ROWSET>
<ROW num="0" ><MWTYP >R</MWTYP><MWID >yszl_dzcl</MWID><NAME >工行对账临时处理</NAME><NOTE ></NOTE><NOACCNAME ></NOACCNAME><FILE >yszl_dzcl.zxg</FILE><SCENE ></SCENE><FIXED ></FIXED><CATTYP ></CATTYP><DTLRNG ></DTLRNG><BATINP ></BATINP><MANUNIT ></MANUNIT><USESMLUNT ></USESMLUNT><ITEMTABLE ></ITEMTABLE><BILHDRTABLE ></BILHDRTABLE><BILDTLTABLE ></BILDTLTABLE><COLLIST ></COLLIST><WHERE ></WHERE><ORDER ></ORDER><DBNAME ></DBNAME><LISTSUM ></LISTSUM><LOADDATA ></LOADDATA><CHECKTITLE ></CHECKTITLE><IFBILL ></IFBILL><EXTJS ></EXTJS><JAVACLS ></JAVACLS><POST2MWID ></POST2MWID><LMS ></LMS><WIDTHMOD ></WIDTHMOD><HEIGHTMOD ></HEIGHTMOD><CLIENTCLASS ></CLIENTCLASS><SHOWBTN >0</SHOWBTN><CLOSEPAGES ></CLOSEPAGES><syt >SBCW</syt></ROW>
</ROWSET>
</grdds><grdbtnds>
<ROWSET>
<ROW num="0" ><ID >reSend</ID><NAME >手工重发</NAME><ACTTYP ></ACTTYP><URL ></URL><URLTARGET ></URLTARGET><TIP ></TIP><BTNORD ></BTNORD><IMG >1</IMG><IMGMOUSE ></IMGMOUSE><C10 >reSend</C10></ROW>
</ROWSET>
</grdbtnds><grdjsds>
<ROWSET>
<ROW num="0" ><GRDJSDS_VALUE >var ZXGFILE0 = &amp;quot;&amp;quot;;

//数据加载完毕
function _thisOnpost_loaddata(sheet)
{
	ZXGFILE0 = _this.SaveTempZXGFile(0);
	_this.SplitSheet(1,&amp;quot;V&amp;quot;,40);
	_this.SetToDateBox(&amp;quot;&amp;quot;,1,1,2,G_LOGDAT);
	_this.SetToDateBox(&amp;quot;&amp;quot;,1,1,4,G_LOGDAT);
	var cgList = _this.CreateListValue();
	_this.SetListValue(cgList,&amp;quot;%&amp;quot;,&amp;quot;全部&amp;quot;);
	_this.SetListValue(cgList,&amp;quot;0&amp;quot;,&amp;quot;未处理&amp;quot;);
	_this.SetListValue(cgList,&amp;quot;1&amp;quot;,&amp;quot;已处理&amp;quot;);
	_this.SetToComboBox(&amp;quot;&amp;quot;,1,1,13,cgList);
	_this.SetCellText(1,1,13,&amp;quot;%&amp;quot;);	
	loadMain();
}

function loadMain()
{
	_this.LoadZXGFile(ZXGFILE0,-1,0);
	_this.SetMainCellRange(0,2,2,_this.GetRowCount(0)-1,_this.GetColCount(0)-1);
	_this.SetAttribe(&amp;quot;SHEET_0&amp;quot;,_this.ATTR_SHEET_SELECTFLAG,_this.SELECTFLAG_SINGLEROW);
	_this.SetFixedRow(0,2);
	_this.SetFixedCol(0,2);
	var dat1 = _this.GetCellText(1,1,2);
	var dat2 = _this.GetCellText(1,1,4);
	var cgbz = _this.GetCellText(1,1,13);
	var ref = _this.GetCellText(1,1,7);
	var bkseq = _this.GetCellText(1,1,10);
	var xml = _sql.query(&amp;quot;MAIN&amp;quot;,&amp;quot;dat1=&amp;quot;+dat1+&amp;quot;&amp;dat2=&amp;quot;+dat2+&amp;quot;&amp;cgbz=&amp;quot;+cgbz+&amp;quot;&amp;ref=&amp;quot;+ref+&amp;quot;&amp;bkseq=&amp;quot;+bkseq);
	_this.SetXmlDS(0,_this.GetMainCellRangeRow1(0),_this.GetMainCellRangeCol1(0),_this.GetMainCellRangeRow2(0),_this.GetMainCellRangeCol2(0),xml);	
	for(var i=_this.GetMainCellRangeRow1(0);i&amp;lt;=_this.GetMainCellRangeRow2(0);i++) {
		var ref = _this.GetCellText(0,i,2);
		var cgbz = _this.GetCellText(0,i,17);
		if(ref != &amp;quot;&amp;quot;) {
			_this.SetToBoolBox(0,i,1);
		}
		if(cgbz == &amp;quot;0&amp;quot;) {
			_this.SetCellColor(0,i,17,255,0,0);
			_this.SetCellShowText(0,i,17,&amp;quot;未处理&amp;quot;);
		}
		else if(cgbz == &amp;quot;1&amp;quot;){
			_this.SetCellColor(0,i,17,0,0,255);
			_this.SetCellShowText(0,i,17,&amp;quot;已处理&amp;quot;);			
		}
	}
}

//点击按钮
function _thisOnButtonCtrlClick(id,sheet,row,col)
{
	if(id == &amp;quot;查询&amp;quot;) {
		loadMain();
	}
}

//手工重发
function reSend()
{
	var cnt = 0;
	if(!window.confirm(&amp;quot;是否确定要手工重发？&amp;quot;)) return false;
	var sbInstId = &amp;quot;45990081&amp;quot;;
	var bkInstId = &amp;quot;10200000&amp;quot;;
	var SiSeq = &amp;quot;&amp;quot;;
	var BkSeq = &amp;quot;&amp;quot;;
	var fileName = &amp;quot;&amp;quot;;
	var fileMD5 = &amp;quot;&amp;quot;;
	var param = new Object();
	param.sbInstId = sbInstId;
	param.bkInstId = bkInstId;
	param.SiSeq = SiSeq ;
	param.BkSeq = BkSeq ;
	param.fileName = fileName ;
	param.fileMD5 = fileMD5 ;
	param.fileTypeCode = &amp;quot;0122001&amp;quot;;
	param.ref = ref;
	param.czyxm = G_USRNAM;
	var ret = _this.invokeOSFuncExt(&amp;quot;reSend&amp;quot;,param);
	alert(ret);
}


//修改单元格内容
function _thisOnCellModify(sheet,row,col,oldvalue,newvalue)
{
	if(sheet == 1) {
		if(col == 7 || col == 10 || col == 13) {
			loadMain();
		}
	}
}

//鼠标左键点击
function _thisOnMouseLClick(sheet,row,col)
{
	if(sheet == 0 ) {
		if(row &amp;gt;= _this.GetMainCellRangeRow1(0) &amp;&amp; row &amp;lt;= _this.GetMainCellRangeRow2(0)) {
			if(col &amp;gt; 1 &amp;&amp; _this.GetCellText(0,row,2) != &amp;quot;&amp;quot;) {
				var oldvalue = _this.GetCellText(0,row,1);
				if(oldvalue == 0) {
					_this.SetCellText(0,row,1,1);
				}
				else {
					_this.SetCellText(0,row,1,0);
				}
			}
		}
	}
}

















</GRDJSDS_VALUE></ROW>
</ROWSET>
</grdjsds><grdosds>
<ROWSET>
<ROW num="0" ><GRDOSDS_VALUE >var pub = new JavaPackage(&amp;quot;com.xlsgrid.net.pub&amp;quot;);
var web = new JavaPackage(&amp;quot;com.xlsgrid.net.web&amp;quot;);
var servletpack = new JavaPackage(&amp;quot;com.xlsgrid.net.servlet&amp;quot;);
var ftppack = new JavaPackage(&amp;quot;org.apache.commons.net.ftp&amp;quot;);
var timepack = new JavaPackage( &amp;quot;com.xlsgrid.net.time&amp;quot; );
var jschftp = new JavaPackage( &amp;quot;com.jcraft.jsch&amp;quot; );

function reSend()
{
	var ret = &amp;quot;&amp;quot;;
	var db = null;
	try {
		db = new pub.EADatabase();
		//调用导入方法的中间件 N0122001
		ret = F0122001(sbInstId,bkInstId,fileName,ref,fileMD5,BkSeq,SiSeq,fileTypeCode,czyxm);
		return ret;     
	}catch(e) {
		if(db != null) db.Rollback();
		return e.toString();
	}finally {
		if(db != null) db.Close();
	}
}

function F0122001(sbInstId,bkInstId,fileName,ref,fileMD5,BkSeq,SiSeq,fileTypeCode,czyxm)
{	
	//fileName = &amp;quot;BK10200000ToRS459900_0122001_20160414011.txt&amp;quot;; //测试用
	var db = null;
	var db2 = null;//此连接用于记录日志
	var line = &amp;quot;&amp;quot;;
	var failecnt = 0;
	var rowcount = 0;
	var succcnt = 0;
	var jsywlx = &amp;quot;&amp;quot;; 	//结算业务类型
	var tcqbm = &amp;quot;&amp;quot;;	//统筹区编码
	var msgUsrName = &amp;quot;&amp;quot;;    //通知消息人姓名
	var a_yhrzrq = &amp;quot;&amp;quot;;
	var a_yhrzsj = &amp;quot;&amp;quot;;
	var a_sblsh = &amp;quot;&amp;quot;;	
	var sbh = &amp;quot;&amp;quot;;
	var zth = &amp;quot;&amp;quot;;
	var thisorgid = &amp;quot;&amp;quot;;
	var thisaccid = &amp;quot;&amp;quot;;	
	var sysdate = &amp;quot;&amp;quot;;
	var yszl_yhzl = &amp;quot;&amp;quot;;
	var a_yhmc = &amp;quot;&amp;quot;;//社保方银行名称
	var myfileName = fileName;
	var a_ywpch = &amp;quot;&amp;quot;;//业务批次号 代发和代扣都按业务批次号
	try{
		db = new pub.EADatabase();
		db2 = new pub.EADatabase();
		//var czyxm = &amp;quot;银行&amp;quot;+bkInstId;
		//先到枢纽服务器下载文件
		writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;0&amp;quot;,&amp;quot;开始导入文件【&amp;quot;+fileName+&amp;quot;】&amp;quot;);
		var sql = &amp;quot;select org,acc,sbh,zth,to_char(sysdate,&amp;apos;yyyymmdd&amp;apos;) sysdat from cw_ztb where yszl_sbjgdm = &amp;apos;&amp;quot;+sbInstId+&amp;quot;&amp;apos;&amp;quot;;
		var ds = db.QuerySQL(sql);
		for(var i=0;i&amp;lt;ds.getRowCount();i++) {
			sbh = ds.getStringAt(i,&amp;quot;sbh&amp;quot;);
			zth = ds.getStringAt(i,&amp;quot;zth&amp;quot;);
			thisorgid = ds.getStringAt(i,&amp;quot;org&amp;quot;);
			thisaccid = ds.getStringAt(i,&amp;quot;acc&amp;quot;);
			sysdate = ds.getStringAt(i,&amp;quot;sysdat&amp;quot;);
		}
		yszl_yhzl = db.GetSQL(&amp;quot;select min(yhbm) from cw_dfdsb_yszl where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and yszl_yhjgdm =&amp;apos;&amp;quot;+bkInstId+&amp;quot;&amp;apos; and szbz = &amp;apos;2&amp;apos;&amp;quot;);
		a_yhmc = db.GetSQL(&amp;quot;select nvl(max(yhmc),&amp;apos;NULL&amp;apos;) from cw_dfdsb_yszl where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and yszl_yhjgdm =&amp;apos;&amp;quot;+bkInstId+&amp;quot;&amp;apos; and szbz = &amp;apos;2&amp;apos;&amp;quot;);
		var dfyhbm = db.GetSQL(&amp;quot;select yhbm from cw_dfdsb_yszl where sbh= &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and szbz =&amp;apos;2&amp;apos; and yszl_yhjgdm = &amp;apos;&amp;quot;+bkInstId+&amp;quot;&amp;apos;&amp;quot;);
		var uo_ywjk = new SBCW_IYWJK(); //业务接口
		var ywjkbz = uo_ywjk.getYWJKBZ(db,thisaccid);	
		var sql = &amp;quot;select * from cw_dfdsb_yszl where yszl_yhjgdm = &amp;apos;&amp;quot;+bkInstId+&amp;quot;&amp;apos; and sbh= &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;&amp;quot;;
		var ftpds = db.QuerySQL(sql);
		var ftpip = ftpds.getStringAt(0,&amp;quot;FTP_IP&amp;quot;);
		var ftpport = ftpds.getStringAt(0,&amp;quot;FTP_PORT&amp;quot;);
		var ftpuser = ftpds.getStringAt(0,&amp;quot;FTP_GXSI_LOGIN_NAME&amp;quot;);
		var ftppasswd = ftpds.getStringAt(0,&amp;quot;FTP_GXSI_LOGIN_PASSWD&amp;quot;);		
		var ftploginpath = ftpds.getStringAt(0,&amp;quot;FTP_GXSI_LOGIN_PATH&amp;quot;);			
		var ftpdownpath = ftpds.getStringAt(0,&amp;quot;FTP_DOWN_PATH&amp;quot;);
		var wjdownpath = ftploginpath + &amp;quot;/&amp;quot; +	 ftpdownpath; 	
		var localpath = &amp;quot;/u/yszl_dsdf/incoming/&amp;quot;+sbInstId;
		//判断localpath是否存在，不存在则要创建
		var myfile = new java.io.File(localpath);
		if(!myfile.exists()) {
			myfile.mkdirs();
		}
		writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;10&amp;quot;,&amp;quot;开始下载文件【&amp;quot;+fileName+&amp;quot;】&amp;quot;);
		//下载sftp						
		var jsch = new jschftp.JSch();
		var sftp = null;
		var sshSession = null;
		var localFile = &amp;quot;&amp;quot;;//未解压
		var localFile2 = &amp;quot;&amp;quot;;//已解压
		try{
			sshSession = jsch.getSession(ftpuser,ftpip,&amp;quot;22&amp;quot;);
			sshSession.setPassword(ftppasswd);
			var config = new java.util.Properties();
			config.put(&amp;quot;StrictHostKeyChecking&amp;quot;,&amp;quot;no&amp;quot;);
			sshSession.setConfig(config);
			sshSession.connect();
			var channel = sshSession.openChannel(&amp;quot;sftp&amp;quot;);
			channel.connect();
			sftp = channel;
			sftp.cd(wjdownpath);
			localFile = new java.io.File(localpath + &amp;quot;/&amp;quot;+ fileName);
			sftp.get(fileName,new java.io.FileOutputStream(localFile));
			sftp.quit();
			sshSession.disconnect();
		}catch(ee){
			if(sftp != null) sftp.quit();
			if(sshSession != null) sshSession.disconnect();
			throw new Exception(&amp;quot;下载文件到ftp失败:&amp;quot;+ee.toString());
		}
		writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;20&amp;quot;,&amp;quot;开始解压文件【&amp;quot;+fileName+&amp;quot;】&amp;quot;);
		//解压文件
		var file1 = localpath + &amp;quot;/&amp;quot;+ fileName;
		//检验md5
		var chkMD5 = pub.EAFunc.getFileMD5(file1);
		if(fileMD5 != chkMD5 ) {
			throw new Exception(&amp;quot;检查文件【&amp;quot;+fileName+&amp;quot;】md5出错.\nfileMD5=&amp;quot;+fileMD5+&amp;quot;,chkMD5=&amp;quot;+chkMD5);			
		}		
		var file2 = localpath + &amp;quot;/&amp;quot;+ pub.EAFunc.Replace(fileName,&amp;quot;.gz&amp;quot;,&amp;quot;&amp;quot;);	
		try{
			pub.EAFunc.DecompressGzip(file1,file2);
		}catch(ee){
			throw new Exception(&amp;quot;解压文件【&amp;quot;+fileName+&amp;quot;】出错\n&amp;quot;+ee.toString());			
		}				
		fileName = pub.EAFunc.Replace(fileName,&amp;quot;.gz&amp;quot;,&amp;quot;&amp;quot;);					
		if(localFile.length() != 0 &amp;&amp; localFile.length != &amp;quot;&amp;quot;) {
			var fi = new java.io.FileInputStream(localpath + &amp;quot;/&amp;quot; + fileName);
			var ir = new java.io.InputStreamReader(fi,&amp;quot;GBK&amp;quot;);
			//var sr = new java.io.StringReader(pub.EAFunc.readFile(localpath + &amp;quot;/&amp;quot; + fileName));
			var br = new java.io.BufferedReader(ir);						
			//取第一行数据
			writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;30&amp;quot;,&amp;quot;开始读取文件【&amp;quot;+fileName+&amp;quot;】&amp;quot;);
			line = br.readLine();				
			rowcount ++;
			if(line == &amp;quot;&amp;quot;) {
				throw new Exception(&amp;quot;失败:文件第一行为空&amp;quot;);
			}
			var length = db.GetSQL(&amp;quot;select lengthb(&amp;apos;&amp;quot;+line+&amp;quot;&amp;apos;) from dual&amp;quot;);		
			if(length != 144) {
				throw new Exception(&amp;quot;文件【&amp;quot;+fileName+&amp;quot;】第一行长度不正确，正确长度：144，实际长度：&amp;quot;+length);			
			}
			var wjscrq = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,0,8),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);           /*文件生成日期 8*/
			var wjscsj = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,8,6),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);           /*文件生成时间 6*/
			var wjclpch = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,14,20),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);	/*文件处理批次号 20 */
			var wjcnt = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,34,8),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*文件记录数 8 */
			var zfsje = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,42,17),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*发生总金额 17*/
			var sucnums = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,59,8),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*成功记录数 8*/
			var sucje = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,67,17),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*成功总金额 17*/
			var sendid = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,84,30),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*发送方机构代码（银行） 30*/
			var recvid = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,114,30),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);	/*接收方机构代码（社保） 30*/	
			var olddjh = &amp;quot;&amp;quot;;
			var succ_djh = &amp;quot;&amp;quot;;//记录支付成功的明细所属单据号字符串	
			var fkzh = &amp;quot;&amp;quot;;
			var fkhm = &amp;quot;&amp;quot;;	
			var a_yhrjzkmbh = &amp;quot;&amp;quot;;//入银行账的科目编号
			var a_skzh = &amp;quot;&amp;quot;;  //批量代扣社保账户
			var a_skhm = &amp;quot;&amp;quot;; //批量代扣社保账户
			var a_yhhzlsh = &amp;quot;&amp;quot;;//银行汇总流水号
			var a_old_sblsh = &amp;quot;&amp;quot;;//批量发放时入账流水号
			tcqbm = db.GetSQL(&amp;quot;select max(tcqbm) from cw_sbsb where sbh in (select sbh from cw_ztb where yszl_sbjgdm = &amp;apos;&amp;quot;+recvid+&amp;quot;&amp;apos;)&amp;quot;);
			var backup2 = &amp;quot;&amp;quot;;
			var backup3 = &amp;quot;&amp;quot;;			
			while ((line = br.readLine()) != null) {
				rowcount ++;
				if(line == &amp;quot;&amp;quot;) continue;				
				var length = db.GetSQL(&amp;quot;select lengthb(&amp;apos;&amp;quot;+line+&amp;quot;&amp;apos;) from dual&amp;quot;);				/*返回文件明细行每行固定长度为601*/
//				if(length != 611) {
//					db.Rollback();
//					writeLog(ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;100&amp;quot;,&amp;quot;文件【&amp;quot;+fileName+&amp;quot;】第&amp;quot;+rowcount+&amp;quot;行长度不正确，正确长度：611，实际长度：&amp;quot;+length);
//					throw new Exception(&amp;quot;文件【&amp;quot;+fileName+&amp;quot;】第&amp;quot;+rowcount+&amp;quot;行长度不正确，正确长度：611，实际长度：&amp;quot;+length);
//					return;				
//				}			
				//return line;				
				var sbjbjgdm = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,0,30),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);               /*社保经办机构代码 30*/
				var yhrzrq = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,30,8),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);                /*银行入账日期 8*/
				var yhrzsj = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,38,6),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		       /*银行入账时间 6 */
				var yhlsh = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,44,30),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);			/*银行流水号 30 */
				var sblsh = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,74,30),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);			/*社保流水号 30*/
				var bb = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,104,3),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);			/*币别 3*/
				var chbz = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,107,1),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);			/*钞汇标志 1*/
				var ywgnh = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,108,7),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*业务功能号 7*/
				jsywlx = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,115,3),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*结算业务类型 3*/
				fkzh = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,118,34),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);           	/*付款账号 34*/
				fkhm = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,152,90),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);           	/*付款户名 90*/
				var skhh = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,242,12),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);			/*收款行号 12 */
				var skzh = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,254,34),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);			/*收款账号 34 */
				var skhm = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,288,90),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);			/*收款户名 90*/
				var jyje = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,378,17),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);			/*交易金额 17*/
				var cbsxf = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,395,17),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*应收参保对象手续费 17*/
				var sbsxf = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,412,17),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*应收社保机构手续费 17*/
				var retcode = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,429,4),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*返回码 4*/
				var retinfo = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,433,128),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*返回信息 128*/
				var backup1 = 	pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,561,10),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);    		/*备用1 10*/
				if(bkInstId == &amp;quot;10200000&amp;quot;) {//工行格式与别的银行不一样
					backup2 = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,571,10),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*备用2 10*/
					backup3 = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,581,20),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*备用3 20*/					
				}
				else {
					backup2 = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,571,30),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*备用2 30* 广西由原来10位扩展到20位，启用为银行支付失败退回汇总一笔入账的流水号（失败流水号整个文件相同）。*/ 
					backup3 = pub.EAFunc.Replace(pub.EAFunc.bSubstring(line,601,30),&amp;quot; &amp;quot;,&amp;quot;&amp;quot;);		/*备用3 30* 广西启用为支付先汇总文件总额一笔扣社保基金账户的流水号或代扣成功的汇总一笔入账流水号（成功流水号整个文件相同）*/					
					a_yhhzlsh = backup3;
				}
				if(jsywlx == &amp;quot;&amp;quot;) {
					throw new Exception(&amp;quot;回盘出错:结算业务类型为空,出错行:&amp;quot;+rowcount);				
				}				
				else if(jsywlx == &amp;quot;004&amp;quot;) { //社保批量支付			
					var ywguid = sblsh.substring(8);								
					sql = &amp;quot;select * from ac95 where baz610 = &amp;apos;&amp;quot;+ywguid+&amp;quot;&amp;apos; 
						and BAZ901 is not null and BAE036 is not null&amp;quot;;					
					var hpds = db.QuerySQL(sql);
					if (hpds.getRowCount() &amp;gt; 0) { //已回过盘不允许重复
						throw new Exception(&amp;quot;已经回盘，不允许重复回盘！出错行号:&amp;quot;+rowcount+&amp;quot;.&amp;quot;+sql);
					}				
					//更新回盘信息
					//返回的社保流水号为ac95表BAZ610+&amp;quot;_&amp;quot;+时间戳组成
					sql = &amp;quot;update ac95 set BAZ901=&amp;apos;&amp;quot;+retcode+&amp;quot;&amp;apos;,BAZ902=&amp;apos;&amp;quot;+retinfo+&amp;quot;&amp;apos;,BAC004=to_date(to_char(sysdate,&amp;apos;yyyy-mm-dd&amp;apos;),&amp;apos;yyyy-mm-dd&amp;apos;),BAC003=&amp;apos;&amp;quot;+fileName+&amp;quot;&amp;apos;||&amp;apos;.gz&amp;apos;,BAE011=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,BAE036=sysdate,
								YSZL_YHRZLSH = &amp;apos;&amp;quot;+yhlsh+&amp;quot;&amp;apos;,YSZL_YHRZRQ=&amp;quot;+yhrzrq+&amp;quot;,YSZL_YHRZSJ=&amp;quot;+yhrzsj+&amp;quot;,YSZL_YSCBDXSXF =to_number(&amp;apos;&amp;quot;+cbsxf +&amp;quot;&amp;apos;)/100 ,YSZL_YSSBJGSXF =to_number(&amp;apos;&amp;quot;+sbsxf +&amp;quot;&amp;apos;)/100
						where  BAZ610 = &amp;apos;&amp;quot;+ywguid+&amp;quot;&amp;apos;&amp;quot;;	
					db.ExcecutSQL(sql);														
					var upcnt = db.ExcecutSQL(sql);
					if (upcnt == 0) {
						throw new Exception(&amp;quot;更新回盘记录不成功，请检查回盘文件数据格式是否正确！出错行号:&amp;quot;+rowcount+&amp;quot;.&amp;quot;+sql);
					}
					sql = &amp;quot;select a.BAZ610,a.AAA027,a.BAZ901,nvl(a.BAZ902,(select aaa103 from aa10 b where a.BAZ901=b.aaa102 and b.aaa100=&amp;apos;BAZ901&amp;apos; )) BAZ902,a.BAC004,a.BAE415,a.AAE076,a.BAE036,a.AAE011,a.bae074
						from ac95 a where  baz610 = &amp;apos;&amp;quot;+ywguid+&amp;quot;&amp;apos;&amp;quot;;																								
					var tmpds = db.QuerySQL(sql);
					if(tmpds.getRowCount() &amp;gt; 0) {
						//调用接口（银海、东软）通知业务 (一笔明细调用一次接口）
						var BAZ610 = tmpds.getStringAt(0,&amp;quot;BAZ610&amp;quot;); //业务内部序号
						//var AAE117 = tmpds.getStringAt(0,&amp;quot;AAE117&amp;quot;); //支付状态
						var AAA027 = tmpds.getStringAt(0,&amp;quot;AAA027&amp;quot;); //所属统筹区
						var BAZ901 = tmpds.getStringAt(0,&amp;quot;BAZ901&amp;quot;); //回盘结果状态码
						var BAZ902 = tmpds.getStringAt(0,&amp;quot;BAZ902&amp;quot;); //回盘结果失败原因
						var BAC004 = tmpds.getStringAt(0,&amp;quot;BAC004&amp;quot;); //回盘时间
						var BAE415 = tmpds.getStringAt(0,&amp;quot;BAE415&amp;quot;); //发放批次
						var AAE076 = tmpds.getStringAt(0,&amp;quot;AAE076&amp;quot;); //财务流水号
						var BAE036 = tmpds.getStringAt(0,&amp;quot;BAE036&amp;quot;); //回盘时间
						var AAE011 = tmpds.getStringAt(0,&amp;quot;AAE011&amp;quot;); //拷盘操作人
						var BAE074 = tmpds.getStringAt(0,&amp;quot;BAE074&amp;quot;); //业务单据号
						var djh = BAE074;					
						tcqbm = AAA027;
						msgUsrName = AAE011;	
						a_yhrzrq = yhrzrq;
						a_yhrzsj = yhrzsj;
						a_old_sblsh = AAE076;
						a_ywpch = BAE415;
						
						if (AAE076 != &amp;quot;&amp;quot;) {  //还没有存入日记帐不能做回盘操作
							throw new Exception(&amp;quot;需要回盘后记账，该拷盘数据财务已入日记帐，不能回盘！&amp;quot;);
						}																					
						sql = &amp;quot;select czyxm,to_char(czysj,&amp;apos;yyyy-mm-dd&amp;apos;) czysj,kmbh from cw_yhrjzb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and siseqno=&amp;apos;&amp;quot;+AAE076+&amp;quot;&amp;apos;&amp;quot;;						
						var rjzds = db.QuerySQL(sql);
						var zdr = czyxm;
						var czysj = db.GetSQL(&amp;quot;select to_char(sysdate,&amp;apos;yyyy-mm-dd&amp;apos;) from dual&amp;quot;);
						if (rjzds.getRowCount() &amp;gt; 0) {
							zdr = rjzds.getStringAt(0,&amp;quot;CZYXM&amp;quot;);
							czysj = rjzds.getStringAt(0,&amp;quot;CZYSJ&amp;quot;);
							a_yhrjzkmbh = rjzds.getStringAt(0,&amp;quot;kmbh&amp;quot;);
						}
						var yhbz = (retcode == &amp;quot;0000&amp;quot; ? &amp;quot;11&amp;quot; : &amp;quot;12&amp;quot;); //支付标志（11:支付成功，12：支付失败）	
						var jkmsg = uo_ywjk.yhkpReturn(db,thisorgid,thisaccid,BAZ610,AAA027,yhbz,BAZ902,AAE076,zdr,czysj,BAE415,BAC004,BAC004,BAE036,ywjkbz);							
						if(a_sblsh == &amp;quot;&amp;quot;) {
							var service = new SBCW_sbcwService();
							a_sblsh = service.genSiSeq(sbInstId);
						}											
						if (retcode != &amp;quot;0000&amp;quot;) {
							failecnt ++;	
														
						}//END回盘不成功的记录																										
					}// end tmpds.getRowCount();					
				}//end if(jsywlx == &amp;quot;004&amp;quot;)
				else {
					throw new Exception(&amp;quot;回盘出错:结算业务类型不正确&amp;quot;);				
				}																
			}//end while				
			//存入日记账,成功的就写日记账
			if(jsywlx == &amp;quot;004&amp;quot;) {//批量支付业务
				//更新银行入账日期、时间、汇总流水号
				var yy = a_yhrzrq.substring(0,4);
				var mm = a_yhrzrq.substring(4,6);
				var dd = a_yhrzrq.substring(6,8);
				var yszl_kmbh = &amp;quot;&amp;quot;;
				//取入账的科目编号
				sql = &amp;quot;select nvl(max(kmbh),&amp;apos;NULL&amp;apos;) from cw_bkdyhb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth =&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and bz=&amp;apos;10&amp;apos; and yhzh=&amp;apos;&amp;quot;+fkzh+&amp;quot;&amp;apos; and yhhm=&amp;apos;&amp;quot;+fkhm+&amp;quot;&amp;apos;&amp;quot;;
				yszl_kmbh = db.GetSQL(sql);
				if(yszl_kmbh == &amp;quot;NULL&amp;quot;) {
					throw new Exception(&amp;quot;导入失败，查询科目编号出错,sql=&amp;quot;+sql);
				}
				var paramMap = new java.util.HashMap();
				paramMap.put(&amp;quot;rzyy&amp;quot;,yy);	
				paramMap.put(&amp;quot;rzmm&amp;quot;,mm);	
				paramMap.put(&amp;quot;rzdd&amp;quot;,dd);	 
				paramMap.put(&amp;quot;thisorgid&amp;quot;,thisorgid);	
				paramMap.put(&amp;quot;thisaccid&amp;quot;,thisaccid);
				paramMap.put(&amp;quot;usrid&amp;quot;,bkInstId);	
				paramMap.put(&amp;quot;czyxm&amp;quot;,&amp;quot;银行&amp;quot;+bkInstId);	
				paramMap.put(&amp;quot;sbh&amp;quot;,sbh);
				paramMap.put(&amp;quot;zth&amp;quot;,zth);
				paramMap.put(&amp;quot;yszl_kmbh&amp;quot;,yszl_kmbh);
				paramMap.put(&amp;quot;yszl_zfhm&amp;quot;,fkhm);	
				paramMap.put(&amp;quot;yszl_zfzh&amp;quot;,fkzh);	
				paramMap.put(&amp;quot;yszl_yhzl&amp;quot;,yszl_yhzl);
				paramMap.put(&amp;quot;yszl_fileName&amp;quot;,fileName);
				paramMap.put(&amp;quot;ywpch&amp;quot;,a_ywpch);
				paramMap.put(&amp;quot;failcnt&amp;quot;,failecnt);
				paramMap.put(&amp;quot;yszl_sbjgdm&amp;quot;,sbInstId);
				paramMap.put(&amp;quot;backup2&amp;quot;,backup2);
				paramMap.put(&amp;quot;backup3&amp;quot;,a_yhhzlsh);
				paramMap.put(&amp;quot;dzsj&amp;quot;,a_yhrzsj);
				
				//工行判断信用卡入账的方法 首位为‘3，4，5,6’ 且长度为16位，其余都是储蓄卡入账模式
				//先写社保总支出入账
				sql  = &amp;quot;select XH,DJH,DWBH,DWMC,DWLXBH,ZY,YM1,YM2,KMBH,AAE008,LXBH,ZJPCH,YWLX,JSFS,AAE140,RQ,a.SBH,a.ZTH,b.je1,b.je2,b.je3,b.je4,b.je5,b.je6,b.je7,b.je8,
						b.je9,b.je10,b.je11,b.je12,b.je13,b.je14,b.je15 from si_djb_tmp a,
					(select bae415,bae074,aaa027,zth,aab001,sum(nvl(baz501,0)) je1,sum(nvl(baz502,0)) je2,sum(nvl(baz503,0)) je3,sum(nvl(baz504,0)) je4,sum(nvl(baz505,0)) je5, 
						sum(nvl(baz506,0)) je6,sum(nvl(baz507,0)) je7,sum(nvl(baz508,0)) je8,sum(nvl(baz509,0)) je9,sum(nvl(baz510,0)) je10,sum(nvl(baz511,0)) je11,
						sum(nvl(baz512,0)) je12,sum(nvl(baz513,0)) je13,sum(nvl(baz514,0)) je14,sum(nvl(baz515,0)) je15,sum(nvl(aic263,0)) zje from ac95 
						where bae415 = &amp;apos;&amp;quot;+a_ywpch+&amp;quot;&amp;apos; and bae419 = &amp;apos;&amp;quot;+yszl_yhzl+&amp;quot;&amp;apos; and instr(bac003,&amp;apos;&amp;quot;+fileName+&amp;quot;&amp;apos;) &amp;gt; -1 and zfbz=&amp;apos;0&amp;apos;  [%FILTER]
						group by bae415,bae074,aaa027,zth,aab001) b 
					where a.djh = b.bae074 and a.pch = b.bae415 and a.sbh=b.aaa027 and a.zth = b.zth and a.dwbh = b.aab001
					  and a.pch = &amp;apos;&amp;quot;+a_ywpch+&amp;quot;&amp;apos; and a.aae008 = &amp;apos;&amp;quot;+yszl_yhzl+&amp;quot;&amp;apos;  and b.zje != 0 and b.zje is not null and a.zfbz=&amp;apos;0&amp;apos;
					  and substrb(nvl(a.zy,&amp;apos;null&amp;apos;),1,4) &amp;lt;&amp;gt; &amp;apos;退回&amp;apos; /* 20160817 丁晓斌 同个单据多笔退回要剔除上次写入的负数*/&amp;quot;;
					  
				writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;60&amp;quot;,&amp;quot;通知业务完成，准备记账...&amp;quot;);					  
				//由于工行记账方式有别于其他银行，需要回盘再记账
				if(bkInstId == &amp;quot;10200000&amp;quot;) {
					writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;70&amp;quot;,&amp;quot;开始工商银行储蓄卡记账...&amp;quot;);				
					//储蓄卡账
					var yhrjzsql = pub.EAFunc.Replace(sql,&amp;quot;[%FILTER]&amp;quot;,&amp;quot;and nvl(baz902,&amp;apos; &amp;apos;) not in (&amp;apos;发卡机构网点号不存在或状态不正常&amp;apos;,&amp;apos;校验账号/卡号的类型错误[获取账号类型为0]&amp;apos;) and not(lengthb(aae010)=16 and substr(aae010,0,1) in (&amp;apos;3&amp;apos;,&amp;apos;4&amp;apos;,&amp;apos;5&amp;apos;,&amp;apos;6&amp;apos;))&amp;quot;); 
					var htsql = &amp;quot;select * from ac95 where bae415 = &amp;apos;&amp;quot;+a_ywpch+&amp;quot;&amp;apos; and bae419 = &amp;apos;&amp;quot;+yszl_yhzl+&amp;quot;&amp;apos; and instr(bac003,&amp;apos;&amp;quot;+fileName+&amp;quot;&amp;apos;) &amp;gt; -1 and zfbz=&amp;apos;0&amp;apos; and baz901&amp;lt;&amp;gt; &amp;apos;0000&amp;apos; 
							and nvl(baz902,&amp;apos; &amp;apos;) not in (&amp;apos;发卡机构网点号不存在或状态不正常&amp;apos;,&amp;apos;校验账号/卡号的类型错误[获取账号类型为0]&amp;apos;) and not(lengthb(aae010)=16 and substr(aae010,0,1) in (&amp;apos;3&amp;apos;,&amp;apos;4&amp;apos;,&amp;apos;5&amp;apos;,&amp;apos;6&amp;apos;))&amp;quot;;
					paramMap.put(&amp;quot;yhrjzsql&amp;quot;,yhrjzsql);
					paramMap.put(&amp;quot;htyhrjzsql&amp;quot;,htsql);		
					try{
						saveYHRJZ(paramMap,db);
					}catch(e){
						throw new Exception(e);
					}	
					writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;70&amp;quot;,&amp;quot;开始工商银行信用卡记账...&amp;quot;);					
					//信用卡账
					var yhrjzsql = pub.EAFunc.Replace(sql,&amp;quot;[%FILTER]&amp;quot;,&amp;quot;and nvl(baz902,&amp;apos; &amp;apos;) not in (&amp;apos;发卡机构网点号不存在或状态不正常&amp;apos;,&amp;apos;校验账号/卡号的类型错误[获取账号类型为0]&amp;apos;) and lengthb(aae010)=16 and substr(aae010,0,1) in (&amp;apos;3&amp;apos;,&amp;apos;4&amp;apos;,&amp;apos;5&amp;apos;,&amp;apos;6&amp;apos;)&amp;quot;); //信用卡记账
					paramMap.put(&amp;quot;yhrjzsql&amp;quot;,yhrjzsql);
					var htsql = &amp;quot;select * from ac95 where bae415 = &amp;apos;&amp;quot;+a_ywpch+&amp;quot;&amp;apos; and bae419 = &amp;apos;&amp;quot;+yszl_yhzl+&amp;quot;&amp;apos; and instr(bac003,&amp;apos;&amp;quot;+fileName+&amp;quot;&amp;apos;) &amp;gt; -1 and zfbz=&amp;apos;0&amp;apos; and baz901&amp;lt;&amp;gt; &amp;apos;0000&amp;apos; 
							and nvl(baz902,&amp;apos; &amp;apos;) not in (&amp;apos;发卡机构网点号不存在或状态不正常&amp;apos;,&amp;apos;校验账号/卡号的类型错误[获取账号类型为0]&amp;apos;) and lengthb(aae010)=16 and substr(aae010,0,1) in (&amp;apos;3&amp;apos;,&amp;apos;4&amp;apos;,&amp;apos;5&amp;apos;,&amp;apos;6&amp;apos;)&amp;quot;;
					paramMap.put(&amp;quot;htyhrjzsql&amp;quot;,htsql);	
					try{
						saveYHRJZ(paramMap,db);
					}catch(e){
						throw new Exception(e);
					}		
												
												
				}	
				else if(bkInstId != &amp;quot;10200000&amp;quot;) {
					writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;70&amp;quot;,&amp;quot;开始记账...&amp;quot;);	
					var yhrjzsql = pub.EAFunc.Replace(sql,&amp;quot;[%FILTER]&amp;quot;,&amp;quot;&amp;quot;);
					var htsql = &amp;quot;select * from ac95 where bae415 = &amp;apos;&amp;quot;+a_ywpch+&amp;quot;&amp;apos; and bae419 = &amp;apos;&amp;quot;+yszl_yhzl+&amp;quot;&amp;apos; and instr(bac003,&amp;apos;&amp;quot;+fileName+&amp;quot;&amp;apos;) &amp;gt; -1 and zfbz=&amp;apos;0&amp;apos; and baz901&amp;lt;&amp;gt; &amp;apos;0000&amp;apos; &amp;quot;;
					paramMap.put(&amp;quot;yhrjzsql&amp;quot;,yhrjzsql);
					paramMap.put(&amp;quot;htyhrjzsql&amp;quot;,htsql);
					try{
						saveYHRJZ(paramMap,db);
					}catch(e){
						throw new Exception(e);
					}											
				}	
				else {
					throw new Exception(&amp;quot;回盘失败，银行机构代码不正确！！&amp;quot;);
				}		
				writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;80&amp;quot;,&amp;quot;记账完成....&amp;quot;);				
			}//end 结算业务=004
			
		}			
			var lognote = &amp;quot;所编号：&amp;quot;+sbh+&amp;quot;,账套号：&amp;quot;+zth+&amp;quot;\n报文序号ref：&amp;quot;+ref+&amp;quot;\n回盘文件：&amp;quot;+fileName+&amp;quot;\n总笔数：&amp;quot;+(rowcount-1)+&amp;quot; 失败笔数：&amp;quot;+failecnt+&amp;quot;\n社保银行:&amp;quot;+a_yhmc+&amp;quot;,批次号:&amp;quot;+a_ywpch;
			writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;100&amp;quot;,&amp;quot;lognote:&amp;quot;+lognote);
			//写系统消息系统通知
			sendMsg(jsywlx,&amp;quot;0&amp;quot;,thisorgid,fileName,ref,lognote);	
//			db.Rollback();
//			return &amp;quot;aaa&amp;quot;;			
			db.Commit();
			db2.Commit();
			return lognote;							
	}catch(e){	
		if(db != null) db.Rollback();	
		//记录导入异常的报文日志
		//&amp;quot;fileTypeCode=&amp;quot;+fileTypeCode+&amp;quot;&amp;sbInstId=&amp;quot;+sbInstId+&amp;quot;&amp;bkInstId=&amp;quot;+bkInstId+&amp;quot;&amp;jobseqid=&amp;quot;+jobseqid+&amp;quot;&amp;fileName=&amp;quot;+fileName+&amp;quot;&amp;fileMD5=&amp;quot;+fileMD5+&amp;quot;&amp;ref=&amp;quot;+ref+&amp;quot;&amp;BkSeq=&amp;quot;+BkSeq+&amp;quot;&amp;SiSeq=&amp;quot;+SiSeq
		var ysywlx = &amp;quot;&amp;quot;;
		if(jsywlx == &amp;quot;004&amp;quot;) {
			ysywlx = &amp;quot;1.7&amp;quot;;
		}else if(jsywlx == &amp;quot;005&amp;quot;) {
			ysywlx = &amp;quot;1.5&amp;quot;;
		}
		sendMsg(jsywlx,&amp;quot;1&amp;quot;,thisorgid,fileName,ref,&amp;quot;所编号：&amp;quot;+sbh+&amp;quot;,账套号：&amp;quot;+zth+&amp;quot;\n报文序号:&amp;quot;+ref+&amp;quot;\n回盘文件名：&amp;quot;+fileName+&amp;quot;\n社保银行:&amp;quot;+a_yhmc+&amp;quot;,批次号:&amp;quot;+a_ywpch);
		writeLog(db2,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;100&amp;quot;,&amp;quot;失败:&amp;quot;+e.toString());
		if(db2 != null) db2.Commit();
		return e.toString();	
	}finally {
		if(db != null) db.Close();
		if(db2 != null) db.Close();
	}
}

//保存日记账
function saveYHRJZ(map,db)
{
	var sblsh = &amp;quot;&amp;quot;;
	try{
		//先写总付款银行日记账
		var yhrjzsql = map.get(&amp;quot;yhrjzsql&amp;quot;);
		var htyhrjzsql = map.get(&amp;quot;htyhrjzsql&amp;quot;);
//		throw new Exception(yhrjzsql );		
		var sbh = map.get(&amp;quot;sbh&amp;quot;);
		var zth = map.get(&amp;quot;zth&amp;quot;);
		var thisaccid = map.get(&amp;quot;thisaccid&amp;quot;);
		var thisorgid = map.get(&amp;quot;thisorgid&amp;quot;);
		var yszl_kmbh = map.get(&amp;quot;yszl_kmbh&amp;quot;);
		var yszl_yhzl = map.get(&amp;quot;yszl_yhzl&amp;quot;);
		var yszl_zfzh = map.get(&amp;quot;yszl_zfzh&amp;quot;);
		var yszl_zfhm = map.get(&amp;quot;yszl_zfhm&amp;quot;);
		var yszl_sbjgdm = map.get(&amp;quot;yszl_sbjgdm&amp;quot;);
		var usrid = map.get(&amp;quot;usrid&amp;quot;);	
		var czyxm = map.get(&amp;quot;czyxm&amp;quot;);	
		var sql = &amp;quot;&amp;quot;;
		var backup2= map.get(&amp;quot;backup2&amp;quot;);//失败汇总流水号
		var backup3= map.get(&amp;quot;backup3&amp;quot;);//成功汇总流水号 
		var failcnt = map.get(&amp;quot;failcnt&amp;quot;);
			
		var yy = map.get(&amp;quot;rzyy&amp;quot;);
		var mm = map.get(&amp;quot;rzmm&amp;quot;);
		var dd = map.get(&amp;quot;rzdd&amp;quot;);
		var dzsj = map.get(&amp;quot;dzsj&amp;quot;);
		
		//到账日期
		sql = &amp;quot;select trim(&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos;||trim(to_char(&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos;,&amp;apos;00&amp;apos;))||trim(to_char(&amp;apos;&amp;quot;+dd+&amp;quot;&amp;apos;,&amp;apos;00&amp;apos;))) rq from dual&amp;quot;;
		var dzrq = db.GetSQL(sql);			
		var ds = db.QuerySQL(yhrjzsql);
		if(ds.getRowCount() &amp;gt; 0) {
			//区分接口标志
			var iuo_ywjk = new SBCW_IYWJK(); //业务接口类
			var ywjkbz = iuo_ywjk.getYWJKBZ(db,thisaccid);	
			var tcqbm = db.GetSQL(&amp;quot;select nvl(tcqbm,sbh) from cw_sbsb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;&amp;quot;);
			var yszl_sbjgdm = db.GetSQL(&amp;quot;select max(yszl_sbjgdm) from cw_ztb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;&amp;quot;);		
			var ywpch = map.get(&amp;quot;ywpch&amp;quot;);
			var jefx = &amp;quot;贷&amp;quot;;
			//初始化
			var dwbh_old = &amp;quot;&amp;quot;;
			var lsh = &amp;quot;&amp;quot;;
			var djh_old  = &amp;quot;&amp;quot;;		
			var mxxh = 0;
			var sxh  = 0;
			var djh_sj = &amp;quot;&amp;quot;;
			var zjpch  = &amp;quot;&amp;quot;;	
			var djh = &amp;quot;&amp;quot;;
			//插入银行账只有一笔，插入日记账按单据循环入账
			for(var i = 0;i&amp;lt; ds.getRowCount();i++){
	//				var tcqbm  = ds.getStringAt(i,&amp;quot;SBJGDM&amp;quot;);
				var xh     = ds.getStringAt(i,&amp;quot;XH&amp;quot;);
				var djh    = ds.getStringAt(i,&amp;quot;DJH&amp;quot;);
				var dwbh   = ds.getStringAt(i,&amp;quot;DWBH&amp;quot;);
				var dwmc   = ds.getStringAt(i,&amp;quot;DWMC&amp;quot;);
				var dwlxbh = ds.getStringAt(i,&amp;quot;DWLXBH&amp;quot;);
				var zy     = ds.getStringAt(i,&amp;quot;ZY&amp;quot;);
				var ym1    = ds.getStringAt(i,&amp;quot;YM1&amp;quot;);
				var ym2    = ds.getStringAt(i,&amp;quot;YM2&amp;quot;);
	//				var kmbh   = ds.getStringAt(i,&amp;quot;KMBH&amp;quot;);
				var lxbh   = ds.getStringAt(i,&amp;quot;LXBH&amp;quot;);
				var jsfs   = ds.getStringAt(i,&amp;quot;JSFS&amp;quot;);
				var aae140 = ds.getStringAt(i,&amp;quot;AAE140&amp;quot;);
				var rq     = ds.getStringAt(i,&amp;quot;RQ&amp;quot;);
				var ywlx_sj= ds.getStringAt(i,&amp;quot;YWLX&amp;quot;);
				    djh_sj = ds.getStringAt(i,&amp;quot;DJH&amp;quot;);
				    djh = ds.getStringAt(i,&amp;quot;DJH&amp;quot;);
				    zjpch  = ds.getStringAt(i,&amp;quot;ZJPCH&amp;quot;);
				    
				
				if(i == 0 ){
					//获取社保流水号
					var service = new SBCW_sbcwService();
					sblsh = service.genSiSeq(yszl_sbjgdm);
//					    sblsh = yszl_sblsh;
					var yhrjzsxh = db.GetSQL(&amp;quot;select nvl(max(sxh),0)+1 from cw_yhrjzb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and yy=&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; and mm=&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos; and KMBH=&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;&amp;quot;);
					var yhrjzid = db.GetSQL(&amp;quot;select seq_yhrjzb_id.nextval from dual&amp;quot;);
					
					sql = &amp;quot;select nvl(max(sxh),0) sxh from cw_rjzb where sbh=&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; and acc=&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos; and yy=&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; and mm=&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos; and kmbh=&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;&amp;quot;;
					sxh = db.GetSQL(sql); //获取日记账顺序号
					//获取主体类型及业务回退接口
					sql = &amp;quot;SELECT DECODE(&amp;apos;&amp;quot;+ywjkbz+&amp;quot;&amp;apos;,&amp;apos;YH&amp;apos;,YWXT_YHDM,&amp;apos;DR&amp;apos;,YWXT_DRDM,&amp;apos;&amp;quot;+ywjkbz+&amp;quot;&amp;apos;) ywhtjk,nvl(ztlx,1) ztlx FROM AA10 WHERE AAA100 = &amp;apos;YWLX&amp;apos; AND AAA102 = &amp;apos;&amp;quot;+ywlx_sj+&amp;quot;&amp;apos;&amp;quot;;
					var ds_ht = db.QuerySQL(sql);
					var ztlx   = ds_ht.getStringAt(0,&amp;quot;ztlx&amp;quot;);
					var ywhtjk = ds_ht.getStringAt(0,&amp;quot;ywhtjk&amp;quot;);
					sql = &amp;quot;SELECT AAA103 FROM aa10 WHERE aaa100 = &amp;apos;ZTLX&amp;apos; AND AAA102 = &amp;apos;&amp;quot;+ztlx+&amp;quot;&amp;apos;&amp;quot;;
					var ztmc = db.GetSQL(sql);
					
					//插入银行日记账表
					sql = &amp;quot;insert into cw_yhrjzb(id,sbh,zth,YY,MM,DD,CWPCH,PZH,ZY,JE,JEFX,YEFX,YE,SISEQNO,DJH,YWPCH,ZTLX,ZTBH,ZTMC,KMBH,CZYXM,CZYSJ,JSFS,yspz_fjzs,yspz_fjpch,yspz_lrrq,DYYWJK_LX,sxh,fkbz,
									YSZL_YHZL,YSZL_YWLX,YSZL_SZBZ,YSZL_FKF_YHZH,YSZL_FKF_YHHM,yszl_yhrzlsh,filename,yszl_yhrzrq,yszl_yhrzsj)
							values(&amp;apos;&amp;quot;+yhrjzid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dd+&amp;quot;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;quot;+zy+&amp;quot;&amp;apos;||&amp;apos;等&amp;apos;,&amp;apos;0&amp;apos;,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+djh_sj+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ywpch+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ztlx+&amp;quot;&amp;apos;,
								&amp;apos;&amp;quot;+ztlx+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ztmc+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,sysdate,&amp;apos;转账&amp;apos;,&amp;apos;1&amp;apos;,&amp;apos;1&amp;apos;,sysdate,&amp;apos;&amp;quot;+ywhtjk+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yhrjzsxh+&amp;quot;&amp;apos;,0,&amp;apos;&amp;quot;+yszl_yhzl+&amp;quot;&amp;apos;,&amp;apos;1.7&amp;apos;,&amp;apos;2&amp;apos;,&amp;apos;&amp;quot;+yszl_zfzh+&amp;quot;&amp;apos;
								,&amp;apos;&amp;quot;+yszl_zfhm+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+backup3+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+fileName+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dzrq+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dzsj+&amp;quot;&amp;apos;)&amp;quot;;
					var row = db.ExcecutSQL(sql);
					if(row != 1){
						db.Rollback();
						//throw new Exception(&amp;quot;插入银行日记账表出错！！！&amp;quot;);
						return &amp;quot;插入银行日记账表出错！！！&amp;quot;;
					}
				}//if(i == 0)				
				
				//插入日记账表	
				if(dwbh != dwbh_old || djh != djh_old ){
					mxxh = 0; //初始化明细序号
					sql = &amp;quot;select seq_rjz_lsh.nextval from dual&amp;quot;;
					lsh = db.GetSQL(sql); //流水号
					sxh = 1*sxh + 1;
					
					//插入日记账表
					sql = &amp;quot;insert into cw_rjzb(sbh,zth,lsh,yy,mm,dd,sxh,czyxm,zy,kmbh,lxbh,djh,old_pch,dwbh,je,jefx,jsfs,yefx,qcbz,fkbz,dwmc,dybz,czysj,org,acc,mkjmbz,siseqno)
						values(&amp;apos;&amp;quot; +sbh+ &amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dd+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zy+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;,&amp;quot;+null+&amp;quot;,&amp;apos;&amp;quot;+djh_sj+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ywpch+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;,&amp;apos;0&amp;apos;,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;
						,&amp;apos;转账&amp;apos;,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;,&amp;apos;0&amp;apos;,&amp;apos;0&amp;apos;,&amp;apos;&amp;quot;+dwmc+&amp;quot;&amp;apos;,&amp;apos;0&amp;apos;,sysdate,&amp;quot;+thisorgid+&amp;quot;
						,&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;,&amp;apos;银社批量支付&amp;apos;,&amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;)&amp;quot;;
					db.ExcecutSQL(sql);
				}
				
				//插入日记账明细表
				for(var k = 1;k&amp;lt;15;k++){
					var mxje = ds.getStringAt(i,&amp;quot;JE&amp;quot;+k);
					var lxxh = k;
					if (mxje != &amp;quot;0&amp;quot; &amp;&amp; mxje != &amp;quot;0.00&amp;quot; &amp;&amp; mxje != &amp;quot;&amp;quot;) {
						mxxh ++;
						sql = &amp;quot;insert into cw_rjzmxb(sbh,zth,org,acc,lsh,mxxh,kmbh,lxbh,lxxh,ym1,ym2,je,jefx)values(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;,
								&amp;apos;&amp;quot;+mxxh+&amp;quot;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;quot;+lxbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lxxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ym1+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ym2+&amp;quot;&amp;apos;,&amp;quot;+mxje+&amp;quot;,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos;)&amp;quot;;
						var rowcou = db.ExcecutSQL(sql);
					}
				}//for(var k = 1;k&amp;lt;15;k++)
				
				//更新si_djb_tmp表
				sql = &amp;quot;update v_si_djb_tmp set lsh=&amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;,RZBZ=&amp;apos;1&amp;apos;,RZR=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,RZSJ=sysdate ,cwbz= 1
					where djh=&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and dwbh=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos; 
					and sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;
					and lsh is null and rzbz=&amp;apos;0&amp;apos; and nvl(zfbz,0) = &amp;apos;0&amp;apos;&amp;quot;;
				db.ExcecutSQL(sql);					
				
				//更新AC95明细,入日记帐的记录才可以拷盘
				sql = &amp;quot;update ac95 set AAE076=&amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos; where (aaa027=&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos; or aaa027=&amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos;) 
					and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and BAE074=&amp;apos;&amp;quot;+djh+&amp;quot;&amp;apos; and AAB001=&amp;apos;&amp;quot;+dwbh+&amp;quot;&amp;apos;
					and aae076 is null&amp;quot;;
							
				dwbh_old = dwbh;
				djh_old  = djh;				
			}
				//更新日记账表每一笔金额
				sql = &amp;quot;update cw_rjzb a set (je,lxbh)=(select sum(je) je,replace(to_char(wm_concat(DISTINCT lxbh)),&amp;apos;,&amp;apos;,&amp;apos;&amp;apos;) lxbh from cw_rjzmxb b where a.sbh=b.sbh and a.zth=b.zth and a.lsh=b.lsh)
				where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;&amp;quot;;
				db.ExcecutSQL(sql);	
				sql = &amp;quot;update cw_yhrjzb a set je =(select sum(je) from cw_rjzb where sbh =&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;) 
				where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;&amp;quot;;	
				db.ExcecutSQL(sql);	
//				return &amp;quot;NOERROR@@&amp;quot;+sblsh;
						
		}//end ds.getRowCount &amp;gt; 0
		else {
			throw new Exception(&amp;quot;写入日记账出错，查询条数不为1！！&amp;quot;);
		}
		//如果有错误数据应该再写一笔退回账
		if(failcnt &amp;gt; 0) {			
			var ds = db.QuerySQL(htyhrjzsql);
			var service = new SBCW_sbcwService();
			var htsblsh = service.genSiSeq(yszl_sbjgdm);
			if(ds.getRowCount() &amp;gt; 0) {
				for(var i=0;i&amp;lt;ds.getRowCount();i++) {
					var retmsg = ds.getStringAt(i,&amp;quot;prc_out_xh&amp;quot;);
					//银海接口返回的是序号，东软返回的是单据号						
					sql = &amp;quot;select * from v_si_djb_tmp where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and (xh=&amp;apos;&amp;quot;+retmsg+&amp;quot;&amp;apos; or djh = &amp;apos;&amp;quot;+retmsg+&amp;quot;&amp;apos;)&amp;quot;;
					var sql1 = sql;
					var sids = db.QuerySQL(sql);					
					if (sids.getRowCount() &amp;gt; 0) {
						var yy = map.get(&amp;quot;rzyy&amp;quot;);
						var mm = map.get(&amp;quot;rzmm&amp;quot;);
						var dd = map.get(&amp;quot;rzdd&amp;quot;);
						var jefx = &amp;quot;借&amp;quot;;						
						//判断是否已存过日记帐
						var djblsh = sids.getStringAt(0,&amp;quot;LSH&amp;quot;);	
						sql = &amp;quot;select * from cw_rjzb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and lsh=&amp;apos;&amp;quot;+djblsh+&amp;quot;&amp;apos;&amp;quot;;																
						var cnt = db.GetSQLRowCount(sql);
						if (cnt == 0) {						
							//保存进日记帐表cw_rjzb			
							var lsh = db.GetSQL(&amp;quot;select seq_rjz_lsh.nextval from dual&amp;quot;); //财务日记帐表的流水号
							sql = &amp;quot;select nvl(max(sxh),-1)+1 from cw_rjzb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and yy=&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; and mm=&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos; and kmbh=&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;&amp;quot;;
							var sxh = db.GetSQL(sql); //顺序号
							var jsfs = &amp;quot;转帐&amp;quot;;
							sql = &amp;quot;insert into cw_rjzb(sbh,zth,org,acc,lsh,yy,mm,dd,sxh,czyxm,old_pch,zy,kmbh,lxbh,dwbh,dwmc,je,jefx,jsfs,yspz_fjzs,yspz_fjpch,yspz_lrrq,czysj,siseqno,djh,MKJMBZ)
								select sbh,zth,org,acc,&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos; lsh,&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; yy,&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos; mm,&amp;apos;&amp;quot;+dd+&amp;quot;&amp;apos; dd,&amp;apos;&amp;quot;+sxh+&amp;quot;&amp;apos; sxh,zbr,pch,zy,&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;,lxbh,dwbh,dwmc,
								nvl((0-(je1+je2+je3+je4+je5+je6+je7+je8+je9+je10+je11+je12+je13+je14+je15)),0) je,&amp;apos;&amp;quot;+jefx+&amp;quot;&amp;apos; jefx,&amp;apos;转帐&amp;apos; jsfs,&amp;apos;&amp;apos; yspz_fjzs,&amp;apos;&amp;apos; yspz_fjpch,null yspz_lrrq,sysdate,&amp;apos;&amp;quot;+htsblsh+&amp;quot;&amp;apos;,djh,&amp;apos;银社批量支付&amp;apos;
								from v_si_djb_tmp where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and (xh=&amp;apos;&amp;quot;+retmsg+&amp;quot;&amp;apos; or djh = &amp;apos;&amp;quot;+retmsg+&amp;quot;&amp;apos;)&amp;quot;;
							var rjzcnt = db.ExcecutSQL(sql);	
							if(rjzcnt == 0) {
								throw new Exception(&amp;quot;插入财务日记账表失败！sql=&amp;quot;+sql);									
							}								
							//保存进日记帐明细表cw_rjzmxb
							var mxxh = 0;
							var mxjefx = &amp;quot;贷&amp;quot;;
							for (var k=1;k&amp;lt;=15;k++) {
								var lxbh = sids.getStringAt(0,&amp;quot;LXBH&amp;quot;);	
								var je = sids.getStringAt(0,&amp;quot;JE&amp;quot;+k);	
								var lxxh = k;				
								if (je != &amp;quot;0&amp;quot; &amp;&amp; je != &amp;quot;0.00&amp;quot; &amp;&amp; je != &amp;quot;&amp;quot;) {
									mxxh ++;
									var ym1 = sids.getStringAt(0,&amp;quot;YM1&amp;quot;);
									var ym2 = sids.getStringAt(0,&amp;quot;YM2&amp;quot;);
									sql = &amp;quot;insert into cw_rjzmxb(sbh,zth,org,acc,lsh,mxxh,kmbh,lxbh,lxxh,ym1,ym2,je,jefx)values(&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+thisaccid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lsh+&amp;quot;&amp;apos;,
											&amp;apos;&amp;quot;+mxxh+&amp;quot;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;quot;+lxbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+lxxh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ym1+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+ym2+&amp;quot;&amp;apos;,&amp;quot;+je+&amp;quot;,&amp;apos;&amp;quot;+mxjefx+&amp;quot;&amp;apos;)&amp;quot;;
									db.ExcecutSQL(sql);
								}
							}
							//cw_yhrjzb
							var yhrjzje = db.GetSQL(&amp;quot;select (0-(je1+je2+je3+je4+je5+je6+je7+je8+je9+je10+je11+je12+je13+je14+je15)) je from v_si_djb_tmp where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and (xh=&amp;apos;&amp;quot;+retmsg+&amp;quot;&amp;apos; or djh = &amp;apos;&amp;quot;+retmsg+&amp;quot;&amp;apos;)&amp;quot;);
							var cnt2 = db.GetSQL(&amp;quot;select count(1) from cw_yhrjzb where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+htsblsh+&amp;quot;&amp;apos;&amp;quot;);
							if(cnt2 &amp;gt; 0) {
								sql = &amp;quot;update cw_yhrjzb set je = je+&amp;quot;+yhrjzje+&amp;quot; where sbh = &amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+htsblsh+&amp;quot;&amp;apos;&amp;quot;;
								db.ExcecutSQL(sql);
							}
							else {
								sql = &amp;quot;select sbh,zth,kmbh,rq from v_si_djb_tmp where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and  (xh=&amp;apos;&amp;quot;+retmsg+&amp;quot;&amp;apos; or djh = &amp;apos;&amp;quot;+retmsg+&amp;quot;&amp;apos;)&amp;quot;;
								var yhrjzds = db.QuerySQL(sql);
								if(yhrjzds.getRowCount() &amp;gt; 0) {
									var yhid = db.GetSQL(&amp;quot;select seq_yhrjzb_id.nextval from dual&amp;quot;); //银行日记账表主键
									var yhrjzsxh = db.GetSQL(&amp;quot;select nvl(max(sxh),0)+1 from cw_yhrjzb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth=&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and yy=&amp;apos;&amp;quot;+yy+&amp;quot;&amp;apos; and mm=&amp;apos;&amp;quot;+mm+&amp;quot;&amp;apos; and KMBH=&amp;apos;&amp;quot;+yszl_kmbh+&amp;quot;&amp;apos;&amp;quot;);
									sql = &amp;quot;insert into cw_yhrjzb(id,sbh,zth,SiSeqNo,yy,mm,dd,sxh,czyxm,kmbh,je,jefx,czysj,YSZL_YWLX,YSZL_SZBZ,yszl_yhrzlsh,YSZL_SKF_KHYH,
											YSZL_SKF_YHZH,YSZL_SKF_YHHM,FILENAME,ztlx,ztbh,ztmc,zy,jsfs,yszl_yhzl,djh,ywpch,yszl_yhrzrq,yszl_yhrzsj)
										select &amp;apos;&amp;quot;+yhid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+htsblsh+&amp;quot;&amp;apos;,&amp;quot;+yy+&amp;quot;,&amp;quot;+mm+&amp;quot;,&amp;quot;+dd+&amp;quot;,&amp;quot;+yhrjzsxh+&amp;quot;,&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,kmbh,&amp;quot;+ yhrjzje+&amp;quot;,&amp;apos;借&amp;apos;,sysdate,
												YSZL_YWLX,&amp;apos;1&amp;apos;,&amp;apos;&amp;quot;+backup2+&amp;quot;&amp;apos;,&amp;apos;&amp;apos;,&amp;apos;&amp;quot;+yszl_zfzh+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+yszl_zfhm+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+fileName+&amp;quot;&amp;apos;,ztlx,ztbh,ztmc,&amp;apos;退回&amp;apos;||zy,jsfs,yszl_yhzl,djh,ywpch,&amp;apos;&amp;quot;+dzrq+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+dzsj+&amp;quot;&amp;apos;
										from cw_yhrjzb where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and siseqno = &amp;apos;&amp;quot;+sblsh+&amp;quot;&amp;apos;&amp;quot;;
									var yhrjzcnt = db.ExcecutSQL(sql);	
									if(yhrjzcnt == 0) {
										throw new Exception(&amp;quot;插入银行日记账表失败！sql=&amp;quot;+sql);										
									}													
								}		
							}										
							//更新SI_DJB_TMP
							sql = &amp;quot;update v_si_djb_tmp set lsh=&amp;apos;&amp;quot;+htsblsh+&amp;quot;&amp;apos;,RZBZ=&amp;apos;1&amp;apos;,RZR=&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;,RZSJ=sysdate 
								where sbh=&amp;apos;&amp;quot;+sbh+&amp;quot;&amp;apos; and zth = &amp;apos;&amp;quot;+zth+&amp;quot;&amp;apos; and  (xh=&amp;apos;&amp;quot;+retmsg+&amp;quot;&amp;apos; or djh = &amp;apos;&amp;quot;+retmsg+&amp;quot;&amp;apos;)&amp;quot;;
							var cnt = db.ExcecutSQL(sql);
							if(cnt == 0) {
								throw new Exception(&amp;quot;回盘失败，更新SI_DJB_TMP失败,i=&amp;quot;+i+&amp;quot;,cnt=&amp;quot;+cnt+&amp;quot;,sql=&amp;quot;+sql);
							}								
						}	
							
														
					}
					else {
						db.Rollback();
						writeLog(ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;100&amp;quot;,&amp;quot;没有找到业务冲帐记录！（序号:&amp;quot;+retmsg+&amp;quot;）&amp;quot;);
						sendMsg(jsywlx,&amp;quot;1&amp;quot;,thisorgid,fileName,ref,&amp;quot;&amp;quot;);
						return &amp;quot;没有找到业务冲帐记录！（序号:&amp;quot;+retmsg+&amp;quot;）&amp;quot;;
					}									
				}//end for (var i =0..)			
			}
			else {
				throw new Exception(&amp;quot;导入失败，写退回日记账失败！&amp;quot;);
			}//end if(failcnt &amp;gt; 0) 
		}
		
		
	}catch(e){
		throw new Exception(e);
	}
	return &amp;quot;1&amp;quot;;//返回1表示成功
}


//写日志
function writeLog(db,id,name,percent,percentnote)
{
	try{
		percentnote = percentnote.toString();
		percentnote = pub.EAFunc.Replace(percentnote,&amp;quot;&amp;apos;&amp;quot;,&amp;quot;&amp;apos;&amp;apos;&amp;quot;);
		if(percentnote.length() &amp;gt;= 4000) {
			percentnote = percentnote.substring(0,3999);
		}	
		var sql = &amp;quot;insert into RUNOSTIMER(id,name,percent,percentnote) values (&amp;apos;&amp;quot;+id+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+name+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+percent+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+percentnote+&amp;quot;&amp;apos;)&amp;quot;;
		if(db != null){
			db.ExcecutSQL(sql);
		}
		else {
			pub.EADbTool.ExcecutSQL(sql);
		}	
	}catch(e){
	
	}	
}

//如果回盘失败，更新ac95标志
function updError(tcqbm,djh,note)
{
	var db = null;
	var sql = &amp;quot;&amp;quot;;
	try{
		db = new pub.EADatabase();
		if(tcqbm != &amp;quot;&amp;quot; &amp;&amp; djh != &amp;quot;&amp;quot;) {
			//note只有80长度，要截位
			note = pub.EAFunc.bSubstring(str ,79);
			sql = &amp;quot;update ac95 set baz902 = &amp;apos;&amp;quot;+note+&amp;quot;&amp;apos; where aaa027 = &amp;apos;&amp;quot;+tcqbm+&amp;quot;&amp;apos; and bae074 = &amp;apos;&amp;quot;+bae074+&amp;quot;&amp;apos;&amp;quot;;
			db.ExcecutSQL(sql);
		}
		db.Rollback();	
	}catch(e) {
		if(db != null) db.Rollback();
	}finally {
		if(db != null) db.Close();
	}
}

//写消息给用户
function sendMsg(jsywlx,cgbz,thisorgid,fileName,ref,lognote)
{
	var db = null;
	var sql = &amp;quot;&amp;quot;;
	var msgtitle = &amp;quot;&amp;quot;;
	var msg = &amp;quot;&amp;quot;;
	try{
		return &amp;quot;aaa&amp;quot;;
		db = new pub.EADatabase();
		if(jsywlx == &amp;quot;004&amp;quot;) {
			msgtitle += &amp;quot;您有一笔银社批量支付回盘文件导入&amp;quot;;	
		}else if(jsywlx == &amp;quot;005&amp;quot;) {
			msgtitle += &amp;quot;您有一笔银社批量代扣回盘文件导入&amp;quot;;	
		}
		else {
			msgtitle += &amp;quot;您有一笔银社回盘文件导入&amp;quot;;
		}
		if(cgbz == &amp;quot;0&amp;quot;) {
			msg += &amp;quot;导入成功!\n&amp;quot;;
		}
		else {
			msg += &amp;quot;导入失败!\n&amp;quot;;
		}
		msg += &amp;quot;\n&amp;quot;+lognote;
		sql = &amp;quot;select distinct org,name,id
				from
				(
				select c.org org, c.name name,c.id id
				  				from rol a, usrrol b, usr c
				 				where a.id in (&amp;apos;01&amp;apos;,&amp;apos;02&amp;apos;,&amp;apos;03&amp;apos;,&amp;apos;05&amp;apos;,&amp;apos;06&amp;apos;)
				   				and a.syt = &amp;apos;SBCW&amp;apos;
				  				and b.rol = a.guid
				   				and c.guid = b.usr
				   				and c.org = &amp;apos;&amp;quot;+thisorgid+&amp;quot;&amp;apos;
				)&amp;quot;;
   		var ds = db.QuerySQL(sql);
   		if(ds.getRowCount() &amp;gt; 0) {
   			var service = new SBCW_sbcwService();
   			for(var i=0;i&amp;lt;ds.getRowCount();i++) {
   				var usrid = ds.getStringAt(i,&amp;quot;id&amp;quot;);
				var str = service.sendMsg(msgtitle ,msg,thisorgid,usrid);					
   			}
   		}		
	}catch(e) {
		if(db != null) db.Rollback();
		writeLog(null,ref,&amp;quot;批量文件结算&amp;quot;,&amp;quot;100&amp;quot;,&amp;quot;发送消息失败&amp;quot;+e.toString());
	}finally {
		if(db != null) db.Close();
	}	
}


//异常处理,记录批量回盘导入出错的报文，需要人工手动重新操作
function writeErrorLog(ref,sendid,recvid,siseq,bkseq,filename,errormsg,ysywlx,fileMD5,czyxm)
{
	var db = null;
	var sql = &amp;quot;&amp;quot;;
	try{
		db = new pub.EADatabase();
		errormsg = errormsg.toString();
		errormsg = pub.EAFunc.Replace(errormsg ,&amp;quot;&amp;apos;&amp;quot;,&amp;quot;&amp;apos;&amp;apos;&amp;quot;);
		if(errormsg.length() &amp;gt;= 4000) {
			errormsg= errormsg.substring(0,3999);
		}		
		sql = &amp;quot;select 1 from YSZL_ERRORLOG where ref = &amp;apos;&amp;quot;+ref+&amp;quot;&amp;apos;&amp;quot;;
		var ds = db.QuerySQL(sql);
		if(ds.getRowCount() == 0) {//新增
			sql = &amp;quot;insert into YSZL_ERRORLOG(REF,SENDID,RECVID,SISEQ,BKSEQ,
							BUSCD,YSZLYWLX,FILETYPECODE,FILENAME,ERRMSG,fileMD5,yhjgdm,sbjgdm,czyxm)
				values (&amp;apos;&amp;quot;+ref+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sendid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+recvid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+siseq+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+bkseq+&amp;quot;&amp;apos;,&amp;apos;0214002&amp;apos;,&amp;apos;&amp;quot;+ysywlx+&amp;quot;&amp;apos;,
							&amp;apos;0122001&amp;apos;,&amp;apos;&amp;quot;+filename+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+errormsg+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+fileMD5+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+sendid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+recvid+&amp;quot;&amp;apos;,&amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos;)&amp;quot;;	
			db.ExcecutSQL(sql);				
		}
		else {//修改
			sql = &amp;quot;update YSZL_ERRORLOG set crtdat = sysdate,ERRMSG= &amp;apos;&amp;quot;+errormsg+&amp;quot;&amp;apos;,czyxm = &amp;apos;&amp;quot;+czyxm+&amp;quot;&amp;apos; where ref = &amp;apos;&amp;quot;+ref+&amp;quot;&amp;apos;&amp;quot;;
			db.ExcecutSQL(sql);
		}
		db.Commit();
		return &amp;quot;noerror&amp;quot;;
	}catch(e) {
		if(db != null) db.Rollback();
		return e.toString();
	}finally {
		if(db != null) db.Close();
	}	
}</GRDOSDS_VALUE></ROW>
</ROWSET>
</grdosds><grddscds>
<ROWSET>
<ROW num="0" ><ID >MAIN</ID><NAME ></NAME><DATDSC >SELECT ref,
       sendid,
       recvid,
       sbjgdm,
       yhjgdm,
       siseq,
       bkseq,
       buscd,
       yszlywlx,
       filetypecode,
       filename,
       errmsg,
       crtdat,filemd5,czyxm,cgbz
  FROM YSZL_ERRORLOG
  where sbjgdm in (select yszl_sbjgdm from cw_ztb where org=&amp;apos;[%SYS_ORGID]&amp;apos; and acc = &amp;apos;[%SYS_ACCID]&amp;apos;)
  and to_char(crtdat,&amp;apos;yyyy-mm-dd&amp;apos;) &amp;gt;= &amp;apos;[%dat1]&amp;apos;
  and to_char(crtdat,&amp;apos;yyyy-mm-dd&amp;apos;) &amp;lt;= &amp;apos;[%dat2]&amp;apos;
  and cgbz like &amp;apos;%[%cgbz]%&amp;apos;
  and ref like &amp;apos;[%ref]%&amp;apos;
  and bkseq like &amp;apos;[%bkseq]%&amp;apos; order by bkseq,crtdat</DATDSC><C4 >MAIN</C4><C5 >MAIN</C5><C6 >MAIN</C6><C7 >MAIN</C7><C8 >MAIN</C8><C9 >MAIN</C9></ROW>
</ROWSET>
</grddscds><fldhdr>
<ROWSET>
<ROW num="0" ><BILID >1单据编号</BILID><STAT >0单据状态</STAT><SUBTYP >0子类型</SUBTYP><CORPID >0往来单位编号</CORPID><CORPNAM >0往来单位名称</CORPNAM><LOCID >0仓库|部门编号</LOCID><LOCNAM >0仓库|部门名称</LOCNAM><DAT >0单据日期</DAT><CRTUSR >1录入人</CRTUSR><CRTUSRNAM >0录入人姓名</CRTUSRNAM><CRTDAT >0录入日期</CRTDAT><CHKUSR >1审核人</CHKUSR><CHKUSRNAM >0审核人姓名</CHKUSRNAM><CHKDAT >0审核日期</CHKDAT><SUMQTY >0合计金额</SUMQTY><SUMMNY >0合计金额</SUMMNY><REFID1 >0扩展字段</REFID1><REFNAM1 >0扩展字段</REFNAM1><REFID2 >0扩展字段</REFID2><REFNAM2 >0扩展字段</REFNAM2><REFID3 >0扩展字段</REFID3><REFNAM3 >0扩展字段</REFNAM3><REFID4 >0扩展字段</REFID4><REFNAM4 >0扩展字段</REFNAM4><REFID5 >0扩展字段</REFID5><REFNAM5 >0扩展字段</REFNAM5><REFID6 >0扩展字段</REFID6><REFNAM6 >0扩展字段</REFNAM6><NOTE >0备注</NOTE></ROW>
</ROWSET>
</fldhdr><flddtl>
<ROWSET>
<ROW num="0" ><SEQID >1明细序号</SEQID><ITMID >1品种编号</ITMID><ITMNAM >0品种名称</ITMNAM><ITEMPC >0品种批次号</ITEMPC><ITMSPC >0规格</ITMSPC><UNIT >0计量单位</UNIT><SMLUNT >0小计量单位</SMLUNT><UNTNUM >0大单位转小单位因子</UNTNUM><PRICE >0价格</PRICE><QTY >0数量</QTY><TAXTYP >0税率类型</TAXTYP><NOTAXMNY >0不含税税额</NOTAXMNY><TAXMNY >0税额</TAXMNY><MNY >0下单金额</MNY><REFID1 >0扩展字段</REFID1><REFNAM1 >0扩展字段</REFNAM1><REFID2 >0扩展字段</REFID2><REFNAM2 >0扩展字段</REFNAM2><REFID3 >0扩展字段</REFID3><REFNAM3 >0扩展字段</REFNAM3><REFID4 >0扩展字段</REFID4><REFNAM4 >0扩展字段</REFNAM4><REFID5 >0扩展字段</REFID5><REFNAM5 >0扩展字段</REFNAM5></ROW>
</ROWSET>
</flddtl></mdroot>